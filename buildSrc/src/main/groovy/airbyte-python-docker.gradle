import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.tasks.Exec

class AirbytePythonDockerConfiguration {
    String moduleDirectory
}

class AirbytePythonDockerPlugin implements Plugin<Project> {

    void apply(Project project) {
        def extension = project.extensions.create('airbytePythonDocker', AirbytePythonDockerConfiguration)

        project.task('airbytePythonDockerApply', type: Exec) {
            /*
            Install the dependencies, run the tests, and run static analysis from a docker container
             */
            commandLine "docker", "run", "-v", "${project.projectDir.getAbsolutePath()}:/home", "--entrypoint", "/bin/bash", "python:3.9-slim", "-c", "chmod +x /home/run_tests.sh && /home/run_tests.sh /home"
        }

        project.task('blackFormat', type: Exec) {
            /*
            Install the dependencies, run the tests, and run static analysis from a docker container
             */
            commandLine "docker", "run", "-v", "${project.projectDir.getAbsolutePath()}:/home", "--entrypoint", "/bin/bash", "python:3.9-slim", "-c", "chmod +x /home/run_tests.sh && /home/run_format.sh /home"
        }

        project.assemble.dependsOn project.airbytePythonDockerApply
        project.test.dependsOn project.airbytePythonDockerApply
    }
}

