import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.tasks.Exec

class AirbytePythonDockerConfiguration {
    String moduleDirectory
}

class AirbytePythonDockerPlugin implements Plugin<Project> {

    void apply(Project project) {
        def extension = project.extensions.create('airbytePythonDocker', AirbytePythonDockerConfiguration)

        project.task('runTests', type: Exec) {
            commandLine "docker", "run", "-v", "${project.projectDir.getAbsolutePath()}:/tmp", "--entrypoint", "/bin/bash", "python:3.9-slim", "-c", "chmod +x /tmp/run.sh && /tmp/run.sh /tmp"
        }

        project.task('airbytePythonApply', type: DefaultTask) {
            dependsOn project.runTests
        }


        project.task('airbytePythonTest', type: DefaultTask) {
            dependsOn project.airbytePythonApply
            dependsOn project.runTests
        }


        project.assemble.dependsOn project.airbytePythonApply
        project.assemble.dependsOn project.airbytePythonTest
        project.test.dependsOn project.airbytePythonTest
    }
}

