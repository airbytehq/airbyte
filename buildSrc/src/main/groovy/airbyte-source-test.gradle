import org.gradle.api.Plugin
import org.gradle.api.Project
import org.gradle.api.tasks.testing.Test

/*
TODO:
standardSourceTestPython {
    ext {
        imageName = "${extractImageName(project.file('Dockerfile'))}:dev"
        pythonContainerName = "${extractImageName(project.file('Dockerfile.test'))}:dev"
    }
}

todo: this needs to depend on building the test image

 */


class AirbyteSourceTestPlugin implements Plugin<Project> {
    void apply(Project project) {
        project.task('standardSourceTestPython') {
            project.ext {
                imageName = ''
                pythonContainerName = ''
            }

            doFirst {
                project.exec {
                    println('standard test inputs')
                    println("imageName: ${imageName}")
                    println("pythonContainerName: ${pythonContainerName}")
                    workingDir project.rootDir
                    commandLine 'docker', 'run', '--rm', '-i',
                            // so that it has access to docker
                            '-v', "/var/run/docker.sock:/var/run/docker.sock",
                            // when launching the container within a container, it mounts the directory from
                            // the host filesystem, not the parent container. this forces /tmp to be the
                            // same directory for host, parent container, and child container.
                            '-v', "/tmp:/tmp",
                            // mount the project dir. all provided input paths must be relative to that dir.
                            '-v', "${project.projectDir.absolutePath}:/test_input",
                            '--name', "std-test-${project.name}", 'airbyte/standard-source-test:dev',
                            '--imageName', imageName,
                            '--pythonContainerName', pythonContainerName
                }
            }
        }
        project.standardSourceTestPython.dependsOn(':airbyte-integrations:bases:standard-source-test:airbyteDocker')
        project.standardSourceTestPython.dependsOn(project.airbyteDocker)
    }
}
