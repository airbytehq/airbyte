apply from: rootProject.file('tools/gradle/commons/docker.gradle')

task standardTest {
    ext {
        configPath = ''
        catalogPath = ''
    }

    doFirst {
        exec {
            def imageName = "${extractImageName(project.file('Dockerfile'))}:dev"
            println('standard test inputs')
            println("imageName: ${imageName}")
            println("configPath: ${configPath}")
            println("catalogPath: ${catalogPath}")
            workingDir rootDir
            commandLine 'docker', 'run', '--rm', '-i',
                    // so that it has access to docker
                    '-v', "/var/run/docker.sock:/var/run/docker.sock",
                    // when launching the container within a container, it mounts the directory from the host filesystem, not the parent container. this forces /tmp to be the same directory for host, parent container, and child container.
                    '-v', "/tmp:/tmp",
                    // mount the project dir. all provided input paths must be relative to that dir.
                    '-v', "${project.projectDir.absolutePath}:/test_input",
                    '--name', "std-test-${project.name}", 'airbyte/source-test:dev',
                    '--imageName', imageName,
                    '--config', "/test_input/${configPath}",
                    '--catalog', "/test_input/${catalogPath}"
        }
    }
}
standardTest.dependsOn(':airbyte-integrations:bases:source-test-lib:buildImage')
standardTest.dependsOn(compileJava)
standardTest.dependsOn(buildImage)
