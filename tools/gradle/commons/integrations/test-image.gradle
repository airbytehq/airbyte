// todo (cgardens) - dedupe this code with image.gradle.
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage

buildscript {
    repositories {
        jcenter()
    }
    dependencies {
        classpath "com.bmuschko:gradle-docker-plugin:6.6.1"
    }
}

apply plugin: com.bmuschko.gradle.docker.DockerRemoteApiPlugin
apply from: rootProject.file('tools/gradle/commons/docker.gradle')

task buildTestImage(type: DockerBuildImage) {
    def testDockerfile = project.file('Dockerfile.test')
    inputDir = projectDir
    dockerFile = testDockerfile
    images.add("${extractImageName(testDockerfile)}:dev")

    // Handles the case where there's an upstream dependency on a dev versioned image built by Gradle.
    // The plugin doesn't recognize changes to the base image as a change that requires rebuilding.
    // Docker will still cache the artifact, so it shouldn't be much slower.
    outputs.upToDateWhen { false }
}

buildImage.dependsOn(build)
