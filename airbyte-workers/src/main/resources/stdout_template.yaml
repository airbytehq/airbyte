apiVersion: v1
kind: Pod
metadata:
  name: airbyte-worker-JOBID-ATTEMPTID-SUFFIX
spec:
  restartPolicy: Never
  initContainers:
    - name: init
      image: busybox:1.28
      command: [ 'sh', '-c', "mkfifo /pipes/stdin && mkfifo /pipes/stdout" ]
      volumeMounts:
        - name: airbyte-pipes
          mountPath: /pipes
  containers:
    - name: worker
      image: IMAGE
      workingDir: WORKDIR
      command: [ 'sh', '-c', "COMMAND > /pipes/stdout" ]
      args: ARGS
      volumeMounts:
        #        - name: airbyte-volume-workspace
        #          mountPath: /workspace
        - name: airbyte-pipes
          mountPath: /pipes
    - name: socat
      image: alpine/socat:1.7.4.1-r1
      command: [ 'sh', '-c', "cat /pipes/stdout | socat -d -d -d - TCP:0.0.0.0:9000" ] # todo: fix connection refused errors - tried localhost/127.0.0.1/0.0.0.0/$POD_IP
      env:
        - name: POD_IP
          valueFrom:
            fieldRef:
              fieldPath: status.podIP
      ports:
        - containerPort: 9000
      volumeMounts:
        - name: airbyte-pipes
          mountPath: /pipes
  volumes:
    #    - name: airbyte-volume-workspace
    #      persistentVolumeClaim:
    #        claimName: airbyte-volume-workspace
    - name: airbyte-pipes
      emptyDir: {}
