import { API_SIDEBAR_PATH, EMBEDDED_API_SPEC_URL } from "./constants";
import * as fs from "fs";
import { execSync } from "child_process";

const loadAllowedTags = (): string[] => {
  // Fetch spec directly from S3 using curl (synchronous)
  try {
    console.log("Fetching OpenAPI spec from S3 for tag filtering...");
    const specData = execSync(`curl -s "${EMBEDDED_API_SPEC_URL}"`, {
      encoding: "utf8",
      timeout: 30000,
    });
    const spec = JSON.parse(specData);
    console.log("Successfully fetched spec from S3");
    return spec.tags?.map((tag: any) => tag.name) || [];
  } catch (e) {
    console.warn("Could not fetch OpenAPI spec from S3 for tag filtering:", e);
    return [];
  }
};

export const loadSonarApiSidebar = (): any[] => {
  const allowedTags = loadAllowedTags();

  if (fs.existsSync(API_SIDEBAR_PATH)) {
    try {
      const sidebarModule = require(API_SIDEBAR_PATH);
      // The sidebar.ts exports the array directly via: export default sidebar.apisidebar;
      let apiSidebarItems = sidebarModule.default || sidebarModule || [];

      // Filter to only show tags that are defined in the spec
      apiSidebarItems = apiSidebarItems.filter((item: any) => {
        if (item.type !== "category") {
          return true;
        }

        return allowedTags.includes(item.label);
      });

      console.log(`Filtered API sidebar to ${apiSidebarItems.length} items`);
      return apiSidebarItems;
    } catch (e) {
      console.warn("Could not load pre-generated API sidebar:", e);
      return [];
    }
  }
  return [];
};

// Helper function to find and replace the "api-reference" category
export const replaceApiReferenceCategory = (
  items: any[],
  sonarApiItems: any[],
): any[] => {
  return items.map((item) => {
    if (
      item.type === "category" &&
      item.label === "api-reference" &&
      item.items !== undefined
    ) {
      // Replace the api-reference category items with the filtered autogenerated API sidebar
      return {
        ...item,
        label: "Sonar API Reference",
        items: sonarApiItems,
      };
    }

    if (item.items) {
      return {
        ...item,
        items: replaceApiReferenceCategory(item.items, sonarApiItems),
      };
    }

    return item;
  });
};
