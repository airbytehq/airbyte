# Step 3: Connecting to the API

We're now ready to start implementing the connector.

Over the course of this tutorial, we'll be editing a few files that were generated by the code generator:

- `source-exchange-rates-tutorial/source_exchange_rates_tutorial/spec.yaml`: This is the [spec file](../../connector-specification-reference.md). It describes the inputs used to configure the connector.
- `source-exchange-rates-tutorial/source_exchange_rates_tutorial/exchange_rates_tutorial.yaml`: This is the connector definition. It describes how the data should be read from the API source.
  We'll also be creating the following files:
- `source-exchange-rates-tutorial/secrets/config.json`: This is the configuration file we'll be using to test the connector. It's schema should match the schema defined in the spec file.
- `source_exchange_rates_tutorial/schemas/rates.json`: This is the [schema definition](../../cdk-python/schemas.md) for the stream we'll implement.
- `source-exchange-rates/acceptance-test-config.yml`: This is the [acceptance test configuration file](../../testing-connectors/README.md). It describes the integration tests to be used to verify that the connector works as expected.

## Updating the connector spec and config

1. Let's populate the config so the connector can access the access key and base currency.
   First, we'll add these properties to the connector spec in `source-exchange-rates-tutorial/source_exchange_rates_tutorial/spec.yaml`

```
documentationUrl: https://docs.airbyte.io/integrations/sources/exchangeratesapi
connectionSpecification:
  $schema: http://json-schema.org/draft-07/schema#
  title: exchangeratesapi.io Source Spec
  type: object
  required:
    - access_key
    - base
  additionalProperties: true
  properties:
    access_key:
      type: string
      description: >-
        Your API Access Key. See <a
        href="https://exchangeratesapi.io/documentation/">here</a>. The key is
        case sensitive.
      airbyte_secret: true
    base:
      type: string
      description: >-
        ISO reference currency. See <a
        href="https://www.ecb.europa.eu/stats/policy_and_exchange_rates/euro_reference_exchange_rates/html/index.en.html">here</a>.
      examples:
        - EUR
        - USD
```

2. We also need to fill in the connection config in the `secrets/config.json`
   Because of the sensitive nature of the access key, we recommend storing this config in the `secrets` directory because it is ignored by git.

```
echo '{"access_key": "<your_access_key>", "base": "USD"}'  > secrets/config.json
```

## Updating the connector definition

Next, we'll update the connector definition which was generated by the code generation script `source-exchange-rates-tutorial/source_exchange_rates_tutorial/exchange_rates_tutorial.yaml`
More details on the connector definition file can be found in the [overview](../overview.md) and [connection definition](../yaml-structure.md) sections.

```
schema_loader:
  type: JsonSchema
  file_path: "./source_exchange_rates_tutorial/schemas/{{ options.name }}.json"
selector:
  type: RecordSelector
  extractor:
    type: JelloExtractor
    transform: "_"
requester:
  type: HttpRequester
  name: "{{ options['name'] }}"
  url_base: TODO "your_api_base_url"
  http_method: "GET"
  authenticator:
    type: TokenAuthenticator
    token: "{{ config['api_key'] }}"
retriever:
  type: SimpleRetriever
  name: "{{ options['name'] }}"
  primary_key: "{{ options['primary_key'] }}"
  record_selector:
    $ref: "*ref(selector)"
  paginator:
    type: NoPagination
customers_stream:
  type: DeclarativeStream
  $options:
    name: "customers"
  primary_key: "id"
  schema_loader:
    $ref: "*ref(schema_loader)"
  retriever:
    $ref: "*ref(retriever)"
    requester:
      $ref: "*ref(requester)"
      path: TODO "your_endpoint_path"
streams:
  - "*ref(customers_stream)"
check:
  type: CheckStream
  stream_names: ["customers_stream"]

```

Let's fill this out these TODOs with the information found in the [Exchange Rates API docs](https://exchangeratesapi.io/documentation/)

1. First, let's rename the stream from `customers` to `rates`, and update the primary key to `date`

```
rates_stream:
  type: DeclarativeStream
  $options:
    name: "rates"
    primary_key: "date"
```

and update the references in the streams list and check block

```
streams:
  - "*ref(rates_stream)"
check:
  type: CheckStream
  stream_names: ["rates"]
```

2. Next we'll set the base url.
   According to the API documentation, the base url is `"https://api.exchangeratesapi.io/v1/"`.
   This can be set in the requester definition.

```
requester:
  type: HttpRequester
  name: "{{ options['name'] }}"
  url_base: "https://api.exchangeratesapi.io/v1/" # Only change the url_base field
```

3. We can fetch the latest data by submitting a request to "/latest". This path is specific to the stream, so we'll set within the `rates_stream` definition.

```
rates_stream:
  type: DeclarativeStream
  $options:
    name: "rates"
    primary_key: "date"
  schema_loader:
    $ref: "*ref(schema_loader)"
  retriever:
    $ref: "*ref(retriever)"
    requester:
      $ref: "*ref(requester)"
      path: "/latest"
```

4. Next, we'll set up the authentication.
   The Exchange Rates API requires an access key to be passed as request parameter. We'll need to make this access key accessible to our connector, and pass it as a request_parameter in the `request_parameters` field of the `request_options_provider`
   We'll configure the connector to use this access key by setting the access key in a request parameter and pointing to a field in the config, which we'll populate in the next step:

```
requester:
  type: HttpRequester
  name: "{{ options['name'] }}"
  url_base: "https://api.exchangeratesapi.io/v1/"
  http_method: "GET"
  request_options_provider:
    request_parameters:
      access_key: "{{ config.access_key }}"
```

Since the access key is set directly as a request parameter, we can remove the `authenticator` field from the `requester`.

5. According to the ExchangeRatesApi documentation, we can specify the base currency of interest in a request parameter. Let's assume the user will configure this via the connector configuration in parameter called `base`; we'll pass the value input by the user as a request parameter:

```
request_options_provider:
  request_parameters:
    access_key: "{{ config.access_key }}"
    base: "{{ config.base }}"
```

The full connection definition should now look like

```
schema_loader:
  type: JsonSchema
  file_path: "./source_exchange_rates_tutorial/schemas/{{ options.name }}.json"
selector:
  type: RecordSelector
  extractor:
    type: JelloExtractor
    transform: "_"
requester:
  type: HttpRequester
  name: "{{ options['name'] }}"
  url_base: "https://api.exchangeratesapi.io/v1/"
  http_method: "GET"
  request_options_provider:
    request_parameters:
      access_key: "{{ config.access_key }}"
      base: "{{ config.base }}"
retriever:
  type: SimpleRetriever
  name: "{{ options['name'] }}"
  primary_key: "{{ options['primary_key'] }}"
  record_selector:
    $ref: "*ref(selector)"
  paginator:
    type: NoPagination
rates_stream:
  type: DeclarativeStream
  $options:
    name: "rates"
    primary_key: "date"
  schema_loader:
    $ref: "*ref(schema_loader)"
  retriever:
    $ref: "*ref(retriever)"
    requester:
      $ref: "*ref(requester)"
      path: "/latest"
streams:
  - "*ref(rates_stream)"
check:
  type: CheckStream
  stream_names: [ "rates" ]
```

We can now run the `check` operation, which verifies the connector can connect to the API source.

```
python main.py check --config secrets/config.json
```

which should now succeed with logs similar to:

```
{"type": "LOG", "log": {"level": "INFO", "message": "Check succeeded"}}
{"type": "CONNECTION_STATUS", "connectionStatus": {"status": "SUCCEEDED"}}
```

## Next steps

Next, we'll [extract the records from the response](4-reading-data.md)

## More readings

- <connector_definition_yaml_file.yaml>
- [Config-based connectors overview](../overview.md)
- [Authentication](../authentication.md)
- [Request options providers](../request-options.md)