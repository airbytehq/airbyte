#!/usr/bin/env bash

set -e

[ -z "$ROOT_DIR" ] && exit 1

YAML_DIR=airbyte-protocol/models/src/main/resources/airbyte_protocol
OUTPUT_DIR=airbyte-cdk/python/airbyte_cdk/models

function main() {
  rm -rf "$ROOT_DIR/$OUTPUT_DIR"/*.py
  echo "# generated by generate-protocol-files" > "$ROOT_DIR/$OUTPUT_DIR"/__init__.py

  for f in "$ROOT_DIR/$YAML_DIR"/*.yaml; do
    filename_wo_ext=$(basename "$f" | cut -d . -f 1)
    echo "from .$filename_wo_ext import *" >> "$ROOT_DIR/$OUTPUT_DIR"/__init__.py

    if [[ -z "$CODESPACE_CONTAINERS" ]]; then
      docker run --user "$(id -u):$(id -g)" -v "$ROOT_DIR":/airbyte airbyte/code-generator:dev \
        --input "/airbyte/$YAML_DIR/$filename_wo_ext.yaml" \
        --output "/airbyte/$OUTPUT_DIR/$filename_wo_ext.py" \
        --disable-timestamp
    else
      docker run --user "$(id -u):$(id -g)" --volumes-from=$CODESPACE_CONTAINERS airbyte/code-generator:dev \
        --input "/workspace/$YAML_DIR/$filename_wo_ext.yaml" \
        --output "/workspace/$OUTPUT_DIR/$filename_wo_ext.py" \
        --disable-timestamp
    fi
  done
}

main "$@"
