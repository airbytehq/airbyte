# This workflow generates PyAirbyte API documentation using pdoc3
# and commits the generated markdown files to the docs/developers/pyairbyte/reference directory.
#
# The workflow can be triggered:
# - Manually via workflow_dispatch
# - On a schedule (weekly on Sundays)
# - When PyAirbyte releases a new version (via repository_dispatch)
#
# pdoc3 generates markdown output when --output-dir is specified without --html or --pdf flags.
# See: https://github.com/pdoc3/pdoc/issues/257

name: Generate PyAirbyte API Docs

on:
  workflow_dispatch:
    inputs:
      pyairbyte_version:
        description: "PyAirbyte version to generate docs for (leave empty for latest)"
        required: false
        default: ""
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: "0 0 * * 0"
  repository_dispatch:
    types: [pyairbyte-release]

jobs:
  generate-docs:
    name: Generate PyAirbyte API Documentation
    runs-on: ubuntu-24.04
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout Airbyte Repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@a26af69be951a213d495a4c3e4e4022e16d87065 # v5.6.0
        with:
          python-version: "3.12"

      - name: Determine PyAirbyte Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.pyairbyte_version }}" ]; then
            echo "version=${{ github.event.inputs.pyairbyte_version }}" >> $GITHUB_OUTPUT
          elif [ -n "${{ github.event.client_payload.version }}" ]; then
            echo "version=${{ github.event.client_payload.version }}" >> $GITHUB_OUTPUT
          else
            # Get latest version from PyPI
            LATEST_VERSION=$(pip index versions airbyte 2>/dev/null | grep -oP 'airbyte \(\K[^)]+' | head -1)
            echo "version=${LATEST_VERSION}" >> $GITHUB_OUTPUT
          fi

      - name: Clone PyAirbyte Repository
        run: |
          # Clone PyAirbyte at the specific version tag
          git clone --depth 1 --branch "v${{ steps.version.outputs.version }}" \
            https://github.com/airbytehq/PyAirbyte.git pyairbyte-source
          echo "Cloned PyAirbyte v${{ steps.version.outputs.version }}"
          ls -la pyairbyte-source/

      - name: Install PyAirbyte and pdoc3
        run: |
          # Install PyAirbyte from the cloned source to get all dependencies
          cd pyairbyte-source
          pip install -e .
          cd ..
          # Install pdoc3 for documentation generation
          pip install pdoc3

      - name: Generate API Documentation
        run: |
          # Create the reference directory if it doesn't exist
          mkdir -p docs/developers/pyairbyte/reference

          # Generate markdown documentation using pdoc3
          # Without --html or --pdf flags, pdoc3 outputs Markdown-Extra format
          # See: https://github.com/pdoc3/pdoc/issues/257
          pdoc3 --output-dir docs/developers/pyairbyte/reference \
            --config show_source_code=False \
            --config sort_identifiers=True \
            --config show_type_annotations=True \
            airbyte

          echo "Generated documentation files:"
          find docs/developers/pyairbyte/reference -name "*.md" | head -20

      - name: Add Docusaurus Frontmatter
        run: |
          # Add Docusaurus-compatible frontmatter to generated markdown files
          for file in $(find docs/developers/pyairbyte/reference -name "*.md"); do
            filename=$(basename "$file" .md)
            # Create a temp file with frontmatter and original content
            {
              echo "---"
              echo "sidebar_label: ${filename}"
              echo "title: ${filename}"
              echo "---"
              echo ""
              cat "$file"
            } > "${file}.tmp"
            mv "${file}.tmp" "$file"
          done
          echo "Added Docusaurus frontmatter to all generated files"

      - name: Escape Curly Braces for MDX Compatibility
        run: |
          # Docusaurus uses MDX which interprets { and } as JSX expressions.
          # We need to escape them in the generated markdown files.
          find docs/developers/pyairbyte/reference -name "*.md" -exec sed -i \
            -e 's/\([^\\`]\){/\1\\{/g' \
            -e 's/^{/\\{/g' \
            {} \;
          echo "Escaped curly braces in generated markdown files"

      - name: Cleanup PyAirbyte Source
        run: |
          # Remove the cloned PyAirbyte source directory to prevent it from being
          # committed as a submodule (it contains a .git directory)
          rm -rf pyairbyte-source
          echo "Cleaned up temporary files"

      - name: Check for Changes
        id: changes
        run: |
          git add docs/developers/pyairbyte/reference/
          if git diff --cached --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate as GitHub App
        if: steps.changes.outputs.has_changes == 'true'
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@271a8d0340265f705b14b6d32b9829c1cb33d45e # v7.0.8
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          commit-message: "docs: Update PyAirbyte API reference documentation for v${{ steps.version.outputs.version }}"
          title: "docs: Update PyAirbyte API reference documentation for v${{ steps.version.outputs.version }}"
          body: |
            This PR updates the PyAirbyte API reference documentation.

            **PyAirbyte Version:** ${{ steps.version.outputs.version }}

            The documentation was auto-generated using [pdoc3](https://github.com/pdoc3/pdoc).

            ---
            *This PR was automatically generated by the [Generate PyAirbyte API Docs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) workflow.*
          branch: docs/pyairbyte-api-reference-${{ steps.version.outputs.version }}
          base: master
          labels: |
            area/documentation
            auto-generated
          delete-branch: true
