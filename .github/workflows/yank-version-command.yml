name: Yank Version Command

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "Pull request number (if triggered from a PR)"
        type: number
        required: false
      comment-id:
        description: "The comment-id of the slash command. Used to update the comment with the status."
        required: false
      connector:
        description: "Connector name (e.g., source-github, destination-snowflake)"
        required: false
      version:
        description: "Version to yank (e.g., 1.2.3)"
        required: false
      repo:
        description: "Repo (passed by slash command dispatcher)"
        required: false
        default: "airbytehq/airbyte"
      gitref:
        description: "Git ref (passed by slash command dispatcher)"
        required: false

run-name: "Yank Version: ${{ github.event.inputs.connector }} ${{ github.event.inputs.version }}"

jobs:
  yank-version:
    name: Yank Connector Version
    runs-on: ubuntu-latest
    steps:
      - name: Get job variables
        id: job-vars
        run: |
          echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      - name: Parse inputs and validate
        id: vars
        run: |
          connector_name="${{ inputs.connector }}"
          version="${{ inputs.version }}"

          # Validate required inputs
          if [[ -z "$connector_name" ]]; then
            echo "Error: connector name is required. Use: /yank-version connector=<name> version=<version>"
            echo "error=true" >> $GITHUB_OUTPUT
            echo "error_message=Connector name is required. Use: /yank-version connector=<name> version=<version>" >> $GITHUB_OUTPUT
          elif [[ -z "$version" ]]; then
            echo "Error: version is required. Use: /yank-version connector=<name> version=<version>"
            echo "error=true" >> $GITHUB_OUTPUT
            echo "error_message=Version is required. Use: /yank-version connector=<name> version=<version>" >> $GITHUB_OUTPUT
          else
            echo "error=false" >> $GITHUB_OUTPUT
          fi

          echo "connector_name=$connector_name" >> $GITHUB_OUTPUT
          echo "version=$version" >> $GITHUB_OUTPUT

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Post error comment
        if: steps.vars.outputs.error == 'true' && inputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          body: |
            > **Yank Version: ERROR**
            >
            > ${{ steps.vars.outputs.error_message }}
            >
            > **Usage:**
            > ```
            > /yank-version connector=<connector-name> version=<version>
            > ```
            > Example: `/yank-version connector=source-github version=1.2.3`

      - name: Exit on error
        if: steps.vars.outputs.error == 'true'
        run: exit 1

      - name: Post start comment
        if: inputs.comment-id != ''
        id: start-comment
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          body: |
            > **Yank Version: STARTED**
            >
            > Initiating rollback for connector `${{ steps.vars.outputs.connector_name }}` version `${{ steps.vars.outputs.version }}`.
            >
            > [View workflow run](${{ steps.job-vars.outputs.run-url }})

      - name: Checkout Airbyte
        uses: actions/checkout@v4

      - name: Run rollback
        id: rollback
        uses: ./.github/actions/run-airbyte-ci
        with:
          context: "manual"
          dagger_cloud_token: ${{ secrets.DAGGER_CLOUD_TOKEN_CACHE_2 }}
          docker_hub_password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          docker_hub_username: ${{ secrets.DOCKER_HUB_USERNAME }}
          gcp_gsm_credentials: ${{ secrets.GCP_GSM_CREDENTIALS }}
          gcs_credentials: ${{ secrets.METADATA_SERVICE_PROD_GCS_CREDENTIALS }}
          github_token: ${{ steps.get-app-token.outputs.token }}
          metadata_service_gcs_credentials: ${{ secrets.METADATA_SERVICE_PROD_GCS_CREDENTIALS }}
          sentry_dsn: ${{ secrets.SENTRY_AIRBYTE_CI_DSN }}
          slack_webhook_url: ${{ secrets.PUBLISH_ON_MERGE_SLACK_WEBHOOK }}
          spec_cache_gcs_credentials: ${{ secrets.SPEC_CACHE_SERVICE_ACCOUNT_KEY_PUBLISH }}
          subcommand: "connectors --name=${{ steps.vars.outputs.connector_name }} publish --rollback-release-candidate"

      - name: Post success comment
        if: success() && inputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ steps.start-comment.outputs.comment-id || inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          reactions: hooray
          body: |
            > **Yank Version: SUCCESS**
            >
            > Rollback completed for `${{ steps.vars.outputs.connector_name }}`.
            >
            > The release candidate has been rolled back.

      - name: Post failure comment
        if: failure() && inputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ steps.start-comment.outputs.comment-id || inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          reactions: confused
          body: |
            > **Yank Version: FAILED**
            >
            > Failed to rollback connector version. Check the [workflow logs](${{ steps.job-vars.outputs.run-url }}) for details.
