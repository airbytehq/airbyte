name: Publish CDK
on:
  workflow_dispatch:
    inputs:
      dry-run:
        description: ''
        required: false
      comment-id:
        description: 'The comment-id of the slash command. Used to update the comment with the status.'
        required: false

jobs:
  publish-cdk:
    runs-on: ubuntu-latest
    steps:
      - name: Link comment to workflow run
        if: github.event.inputs.comment-id
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ github.event.inputs.comment-id }}
          body: |
            > :clock2: ${{github.event.inputs.connector}} https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
      - name: Echo
        run: echo ${{ github.event.inputs.dry-run }}
        # Github does not provide a clean way of doing if-else branches. The alternative to having two conditions is injecting bash or using another
        # custom action. This approach seemed the simplest.
      - name: Publish to prod PyPi if dry-run is false.
        if: github.event.inputs.dry-run == 'dry-run=false'
        run: |
          echo "Publishing to production PyPi."
      - name: Publish to test PyPi if dry-run.
        if: github.event.inputs.dry-run != 'dry-run=false'
        run: |
          echo "By default publishing to test PyPi. Run /publish-cdk dryrun=false to publish to prod PyPi."
      - name: Checkout Airbyte
        uses: actions/checkout@v2
      - name: Publish Python Package
        uses: mariamrf/py-package-publish-action@v1.0.0
        with:
          python_version: '3.7.9'
          pip_version: '21.1'
          subdir: 'airbyte-cdk/python/'
        env:
          TWINE_PASSWORD: ${{ secrets.TWINE_PASSWORD }}
          TWINE_USERNAME: ${{ secrets.TWINE_USERNAME }}
          TWINE_REPOSITORY_URL: 'https://test.pypi.org/legacy/'
      - name: Add Success Comment
        if: github.event.inputs.comment-id && success()
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ github.event.inputs.comment-id }}
          body: |
            > :white_check_mark: ${{github.event.inputs.connector}} https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
      - name: Add Failure Comment
        if: github.event.inputs.comment-id && !success()
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ github.event.inputs.comment-id }}
          body: |
            > :x: ${{github.event.inputs.connector}} https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}
