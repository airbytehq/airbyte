name: Publish Connectors Pre-release
# This workflow publishes pre-release connector builds from PR branches.
# It can be triggered via the /publish-connectors-prerelease slash command from PR comments.
#
# Pre-release versions are tagged with the format: {version}-dev.{10-char-git-sha}
# These versions are NOT eligible for semver auto-advancement but ARE available
# for version pinning via the scoped_configuration API.
#
# Usage:
#   /publish-connectors-prerelease
#
# This will automatically publish all modified connectors in the PR.

on:
  workflow_dispatch:
    inputs:
      # Global static-arg inputs for slash commands
      repo:
        description: "The repository name"
        required: false
        default: "airbytehq/airbyte"
        type: string
      gitref:
        description: "The git reference (branch or tag)"
        required: false
        type: string
      comment-id:
        description: "The ID of the comment triggering the workflow"
        required: false
        type: number
      pr:
        description: "The pull request number, if applicable"
        required: false
        type: number
      connector:
        description: "Single connector name to publish (e.g., destination-pinecone). If not provided, publishes all modified connectors."
        required: false
        type: string

concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.pr || github.run_id }}
  cancel-in-progress: false

jobs:
  init:
    name: Initialize Pre-release Publish
    runs-on: ubuntu-24.04
    outputs:
      run-url: ${{ steps.job-vars.outputs.run-url }}
      pr-number: ${{ steps.job-vars.outputs.pr-number }}
      comment-id: ${{ steps.append-start-comment.outputs.comment-id }}
      short-sha: ${{ steps.get-sha.outputs.short-sha }}
      connector-version: ${{ steps.connector-version.outputs.connector-version }}
    steps:
      - name: Checkout to get commit SHA
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repo || github.repository }}
          ref: ${{ inputs.gitref || '' }}

      - name: Get short SHA
        id: get-sha
        run: |
          SHORT_SHA=$(git rev-parse --short=10 HEAD)
          echo "short-sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Get job variables
        id: job-vars
        run: |
          echo "run-url=https://github.com/${{ github.repository }}/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT
          echo "pr-number=${{ inputs.pr }}" >> $GITHUB_OUTPUT

      - name: Determine connector version
        id: connector-version
        if: inputs.connector != ''
        run: |
          set -euo pipefail
          CONNECTOR_DIR="airbyte-integrations/connectors/${{ inputs.connector }}"
          VERSION=""
          if [[ -f "$CONNECTOR_DIR/manifest.yaml" ]]; then
            VERSION=$(grep -E '^\s*version:' "$CONNECTOR_DIR/manifest.yaml" | head -n1 | awk '{print $2}' | tr -d '"')
          fi
          if [[ -z "$VERSION" ]] && [[ -f "$CONNECTOR_DIR/metadata.yaml" ]]; then
            VERSION=$(grep -E '^\s*dockerImageTag:' "$CONNECTOR_DIR/metadata.yaml" | head -n1 | awk '{print $2}' | tr -d '"')
          fi
          echo "connector-version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Append start comment
        id: append-start-comment
        if: inputs.comment-id != '' || inputs.pr != ''
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ steps.job-vars.outputs.pr-number }}
          reactions: "+1"
          body: |
            > **Pre-release Connector Publish Started**
            >
            > Publishing pre-release builds for all modified connectors in this PR.
            > Branch: `${{ inputs.gitref }}`
            >
            > Pre-release versions will be tagged as `{version}-dev.${{ steps.get-sha.outputs.short-sha }}`
            > and are available for version pinning via the scoped_configuration API.
            >
            > [View workflow run](${{ steps.job-vars.outputs.run-url }})

  publish:
    name: Publish Pre-release
    needs: [init]
    uses: ./.github/workflows/publish_connectors.yml
    with:
      connectors: ${{ inputs.connector != '' && format('--name={0}', inputs.connector) || '--modified' }}
      release-type: pre-release
    secrets: inherit

  post-completion:
    name: Post Completion Status
    needs: [init, publish]
    runs-on: ubuntu-24.04
    if: always() && (inputs.comment-id != '' || inputs.pr != '')
    steps:
      - name: Determine publish status
        id: status
        run: |
          if [[ "${{ needs.publish.result }}" == "success" ]]; then
            echo "status_emoji=:white_check_mark:" >> $GITHUB_OUTPUT
            echo "status_text=SUCCESS" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.publish.result }}" == "failure" ]]; then
            echo "status_emoji=:x:" >> $GITHUB_OUTPUT
            echo "status_text=FAILED" >> $GITHUB_OUTPUT
          elif [[ "${{ needs.publish.result }}" == "cancelled" ]]; then
            echo "status_emoji=:warning:" >> $GITHUB_OUTPUT
            echo "status_text=CANCELLED" >> $GITHUB_OUTPUT
          else
            echo "status_emoji=:grey_question:" >> $GITHUB_OUTPUT
            echo "status_text=UNKNOWN" >> $GITHUB_OUTPUT
          fi

      - name: Prepare message variables
        id: message-vars
        run: |
          CONNECTOR_NAME="${{ inputs.connector || 'CONNECTOR_NAME' }}"
          SHORT_SHA="${{ needs.init.outputs.short-sha }}"
          VERSION="${{ needs.init.outputs.connector-version }}"

          if [[ -n "$VERSION" ]]; then
            DOCKER_TAG="${VERSION}-dev.${SHORT_SHA}"
          else
            DOCKER_TAG="{version}-dev.${SHORT_SHA}"
          fi

          echo "connector_name=$CONNECTOR_NAME" >> $GITHUB_OUTPUT
          echo "docker_image=airbyte/$CONNECTOR_NAME" >> $GITHUB_OUTPUT
          echo "docker_tag=$DOCKER_TAG" >> $GITHUB_OUTPUT
          echo "dockerhub_url=https://hub.docker.com/layers/airbyte/$CONNECTOR_NAME/$DOCKER_TAG" >> $GITHUB_OUTPUT
          echo "oss_registry_url=https://connectors.airbyte.com/files/registries/v0/oss_registry.json" >> $GITHUB_OUTPUT
          echo "cloud_registry_url=https://connectors.airbyte.com/files/registries/v0/cloud_registry.json" >> $GITHUB_OUTPUT

      - name: Append completion comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ needs.init.outputs.comment-id }}
          issue-number: ${{ needs.init.outputs.pr-number }}
          body: |
            > **Pre-release Publish: ${{ steps.status.outputs.status_text }}** ${{ steps.status.outputs.status_emoji }}
            >
            > **Docker image (pre-release):**
            > `${{ steps.message-vars.outputs.docker_image }}:${{ steps.message-vars.outputs.docker_tag }}`
            >
            > **Docker Hub:** ${{ steps.message-vars.outputs.dockerhub_url }}
            >
            > **Registry JSON:**
            > - [OSS Registry](${{ steps.message-vars.outputs.oss_registry_url }})
            > - [Cloud Registry](${{ steps.message-vars.outputs.cloud_registry_url }})
