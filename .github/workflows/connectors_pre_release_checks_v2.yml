name: Connector Pre-Release Checks (Beta)

on:
    pull_request:
      types: [opened, synchronize, reopened]
      paths:
      - "airbyte-integrations/connectors/**/*"

jobs:
  generate-matrix:
    name: Generate Connector Matrix
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Connector Matrix from Changes
        id: generate-matrix
        run: |
          # Get the list of modified connectors
          echo "connectors_matrix=$(./poe-tasks/get-modified-connectors.sh --json)" | tee -a $GITHUB_OUTPUT
    outputs:
      connectors-matrix: ${{ steps.generate-matrix.outputs.connectors_matrix }}

  qa-checks:
    needs: [generate-matrix]
    runs-on: ubuntu-24.04
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.connectors-matrix) }}
      max-parallel: 5 # Limit number of parallel jobs
      fail-fast: false # Don't stop on first failure
    name: QA Checks for ${{ matrix.connector || ' (no connectors modified)' }}
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install QA Checks
        run: |
          python -m pip install --upgrade pip
          python -m pip install pipx
          pipx install airbyte-ci/connectors/connectors_qa
      - name: Run QA Checks
        # remove strict-encrypt suffix if present for parity with previous checks
        run: |
          connector_name=${{ matrix.connector }}
          connectors-qa run --name ${connector_name%-strict-encrypt} 
