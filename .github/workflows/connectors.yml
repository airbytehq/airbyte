name: Connectors

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  build_airbyte_to_flow:
    runs-on: ubuntu-20.04

    permissions:
      contents: read
      packages: write

    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Prepare
        id: prep
        run: |
          TAG=$(echo $GITHUB_SHA | head -c7)
          echo ::set-output name=tag::${TAG}

      # Linux builds need the non-default musl target.
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: x86_64-unknown-linux-musl

      - name: Install protobuf compiler (it's not already included in CI runner)
        run: sudo apt install -y libprotobuf-dev protobuf-compiler

      - name: Build Linux
        run: |-
          sudo apt-get update && \
          sudo apt-get install -y musl-tools && \
          cd airbyte-to-flow && \
          make

      - name: Tests
        run: cd airbyte-to-flow && cargo test --target x86_64-unknown-linux-musl

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push
        uses: docker/build-push-action@v3
        if: ${{ github.ref == 'refs/heads/master' }}
        with:
          context: airbyte-to-flow
          platforms: linux/amd64
          push: true
          tags: ghcr.io/estuary/airbyte-to-flow:dev,ghcr.io/estuary/airbyte-to-flow:${{ steps.prep.outputs.tag }}

      - name: Build and push
        uses: docker/build-push-action@v3
        if: ${{ github.ref != 'refs/heads/master' }}
        with:
          context: airbyte-to-flow
          platforms: linux/amd64
          push: true
          tags: ghcr.io/estuary/airbyte-to-flow:${{ steps.prep.outputs.tag }}

  build_cdk:
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Prepare
        id: prep
        run: |
          TAG=$(echo $GITHUB_SHA | head -c7)
          echo ::set-output name=tag::${TAG}

      - uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - uses: actions/setup-java@v1
        with:
          java-version: "17"

      - name: Build CDK
        id: build
        if: ${{ github.event_name == 'push' }}
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_TOKEN }}
        run: |
          ./gradlew :airbyte-cdk:python:build
          ./publish-airbyte-cdk.sh

  build_connectors:
    needs:
      - build_airbyte_to_flow
      - build_cdk
    runs-on: ubuntu-20.04
    strategy:
      fail-fast: false
      matrix:
        connector:
          - name: source-facebook-marketing
          - name: source-hubspot
          - name: source-google-sheets
          - name: source-exchange-rates
          - name: source-google-analytics-v4
            alias: source-google-analytics-ua
          - name: source-mailchimp
          - name: source-zendesk-support
          - name: source-stripe
          - name: source-amplitude
          - name: source-intercom
          - name: source-google-ads
          - name: source-salesforce
          - name: source-google-analytics-data-api
          - name: source-linkedin-ads
          - name: source-bing-ads
          - name: source-github
          - name: source-amazon-ads
          - name: source-notion
          - name: source-tiktok-marketing
          - name: source-google-search-console
          - name: source-surveymonkey

    steps:
      - uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: Prepare
        id: prep
        run: |
          TAG=$(echo $GITHUB_SHA | head -c7)
          echo ::set-output name=tag::${TAG}

      - uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - uses: actions/setup-java@v1
        with:
          java-version: "17"

      - name: Login to GitHub package docker registry
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | \
            docker login --username ${{ github.actor }} --password-stdin ghcr.io

      - name: Install virtualenv
        run: python3 -m pip install virtualenv==20.4.2 --user

      - name: Build ${{ matrix.connector }}
        id: build
        run: |
          ./gradlew :airbyte-integrations:connectors:${{ matrix.connector.name }}:build
          connector_name=${{ matrix.connector.name }}
          docker tag docker.io/airbyte/${{ matrix.connector.name }}:dev ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }}
          docker push ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }}

      - name: Push ${{ matrix.connector.name }} image with 'dev' and version tags
        if: ${{ github.event_name == 'push' }}
        id: push-dev
        run: |
          source tools/lib/lib.sh
          export IMAGE_VERSION=$(_get_docker_image_version airbyte-integrations/connectors/${{ matrix.connector.name }}/Dockerfile)
          
          docker pull ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }}
          echo "Publishing image ghcr.io/estuary/${{ matrix.connector.name }}:dev"
          docker tag ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }} ghcr.io/estuary/${{ matrix.connector.name }}:dev
          docker push ghcr.io/estuary/${{ matrix.connector.name }}:dev
          echo "Publishing image ghcr.io/estuary/${{ matrix.connector.name }}:$IMAGE_VERSION"
          docker tag ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }} ghcr.io/estuary/${{ matrix.connector.name }}:$IMAGE_VERSION
          docker push ghcr.io/estuary/${{ matrix.connector.name }}:$IMAGE_VERSION

      - name: Push ${{ matrix.connector.alias }} image with 'dev' and version tags
        if: github.event_name == 'push' && matrix.connector.alias
        id: push-dev-alias
        run: |
          source tools/lib/lib.sh
          export IMAGE_VERSION=$(_get_docker_image_version airbyte-integrations/connectors/${{ matrix.connector.name }}/Dockerfile)
          
          docker pull ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }}
          echo "Publishing image ghcr.io/estuary/${{ matrix.connector.alias }}:dev"
          docker tag ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }} ghcr.io/estuary/${{ matrix.connector.alias }}:dev
          docker push ghcr.io/estuary/${{ matrix.connector.alias }}:dev
          echo "Publishing image ghcr.io/estuary/${{ matrix.connector.alias }}:$IMAGE_VERSION"
          docker tag ghcr.io/estuary/${{ matrix.connector.name }}:${{ steps.prep.outputs.tag }} ghcr.io/estuary/${{ matrix.connector.alias }}:$IMAGE_VERSION
          docker push ghcr.io/estuary/${{ matrix.connector.alias }}:$IMAGE_VERSION

      - name: Install psql
        if: ${{ github.event_name == 'push' }}
        run: sudo apt install postgresql-client

      - name: Refresh connector tags for ${{ matrix.connector.name }}
        if: ${{ github.event_name == 'push' }}
        env:
          PGHOST: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_HOST }}
          PGUSER: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_PASSWORD }}
          PGDATABASE: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_DATABASE }}
        run: |
          source tools/lib/lib.sh
          export VERSION=$(_get_docker_image_version airbyte-integrations/connectors/${{ matrix.connector }}/Dockerfile)
          echo "UPDATE connector_tags SET job_status='{\"type\": \"queued\"}'
                  WHERE connector_id IN (
                    SELECT id FROM connectors WHERE image_name='ghcr.io/estuary/${{ matrix.connector }}'
                  )
                  AND
                  image_tag IN (':$VERSION', ':dev');" | psql

      - name: Refresh connector tags for ${{ matrix.connector.alias }}
        if: github.event_name == 'push' && matrix.connector.alias
        env:
          PGHOST: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_HOST }}
          PGUSER: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_USER }}
          PGPASSWORD: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_PASSWORD }}
          PGDATABASE: ${{ secrets.POSTGRES_CONNECTOR_REFRESH_DATABASE }}
        run: |
          source tools/lib/lib.sh
          export VERSION=$(_get_docker_image_version airbyte-integrations/connectors/${{ matrix.connector.name }}/Dockerfile)
          echo "UPDATE connector_tags SET job_status='{\"type\": \"queued\"}'
                  WHERE connector_id IN (
                    SELECT id FROM connectors WHERE image_name='ghcr.io/estuary/${{ matrix.connector.alias }}'
                  )
                  AND
                  image_tag IN (':$VERSION', ':dev');" | psql
