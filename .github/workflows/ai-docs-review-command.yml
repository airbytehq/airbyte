# AI Docs Review Workflow
#
# This workflow provides AI-powered documentation recommendations for PRs that modify
# connector code. It uses Devin AI to review the proposed changes and provide
# documentation guidance.
#
# Workflow triggers:
# - Triggered via /ai-docs-review slash command on PRs
# - Only processes PRs from non-forked repos or forks with secrets access
# - Triggers for any connector changes (not filtered by support level)

name: AI Docs Review Command

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "Pull request number (if triggered from a PR)"
        type: number
        required: false
      comment-id:
        description: "The comment-id of the slash command. Used to update the comment with the status."
        required: false
      repo:
        description: "Repo (passed by slash command dispatcher)"
        required: false
        default: "airbytehq/airbyte"
      gitref:
        description: "Git ref (passed by slash command dispatcher)"
        required: false

run-name: "AI Docs Review for PR #${{ github.event.inputs.pr }}"

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  recommend-documentation-updates:
    name: Recommend documentation updates with AI
    runs-on: ubuntu-latest

    steps:
      - name: Get job variables
        id: job-vars
        run: |
          echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Check fork and secrets access
        id: check-fork
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}
        run: |
          # Get PR info to check if it's from a fork
          PR_INFO=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr }})
          IS_FORK=$(echo "$PR_INFO" | jq -r '.head.repo.fork')
          echo "is_fork=$IS_FORK" >> $GITHUB_OUTPUT

          # Check if we have access to secrets by checking if the Devin token is available
          if [ -z "${{ secrets.DEVIN_AI_API_KEY }}" ]; then
            echo "has_secrets=false" >> $GITHUB_OUTPUT
          else
            echo "has_secrets=true" >> $GITHUB_OUTPUT
          fi

      - name: Exit if fork without secrets access
        if: steps.check-fork.outputs.is_fork == 'true' && steps.check-fork.outputs.has_secrets == 'false'
        run: |
          echo "Cannot run Devin session for fork PRs without secrets access."
          echo "This is expected behavior - fork PRs do not have access to repository secrets."
          exit 0

      - name: Checkout PR code
        if: steps.check-fork.outputs.is_fork != 'true' || steps.check-fork.outputs.has_secrets == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ inputs.gitref }}

      - name: Get files changed in this PR
        if: steps.check-fork.outputs.is_fork != 'true' || steps.check-fork.outputs.has_secrets == 'true'
        id: pr-files
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}
        run: |
          echo "Fetching files changed in PR #${{ inputs.pr }}..."

          # Get the list of changed files from the PR
          FILES=$(gh api repos/${{ github.repository }}/pulls/${{ inputs.pr }}/files --jq '.[].filename' | jq -R -s -c 'split("\n")[:-1]')

          if [ -z "$FILES" ] || [ "$FILES" = "[]" ]; then
            echo "No files changed in this PR - skipping documentation recommendations."
            echo "has_connector_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Successfully fetched changed files list"

          # Check if any files match the connector path pattern
          CONNECTOR_FILES=$(echo "$FILES" | jq -r '.[] | select(test("^airbyte-integrations/connectors/[^/]+/"))')

          if [ -z "$CONNECTOR_FILES" ]; then
            echo "No connector files found in changed files - skipping documentation recommendations."
            echo "has_connector_changes=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Connector changes detected - documentation recommendations needed"
          echo "has_connector_changes=true" >> $GITHUB_OUTPUT

      - name: Post start comment
        if: inputs.comment-id != '' && (steps.check-fork.outputs.is_fork != 'true' || steps.check-fork.outputs.has_secrets == 'true') && steps.pr-files.outputs.has_connector_changes == 'true'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          body: |
            > **AI Docs Review Started**
            >
            > Analyzing connector changes and preparing documentation recommendations.
            > [View workflow run](${{ steps.job-vars.outputs.run-url }})

      - name: Post skip comment (no connector changes)
        if: inputs.comment-id != '' && (steps.check-fork.outputs.is_fork != 'true' || steps.check-fork.outputs.has_secrets == 'true') && steps.pr-files.outputs.has_connector_changes == 'false'
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          body: |
            > **AI Docs Review Skipped**
            >
            > No connector changes detected in this PR. Documentation review is only triggered for PRs that modify connector code.

      - name: Start AI documentation recommendation session
        if: (steps.check-fork.outputs.is_fork != 'true' || steps.check-fork.outputs.has_secrets == 'true') && steps.pr-files.outputs.has_connector_changes == 'true'
        uses: aaronsteers/devin-action@0d74d6d9ff1b16ada5966dc31af53a9d155759f4 # Pinned to specific commit for security
        with:
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ steps.get-app-token.outputs.token }}
          playbook-macro: "!connectordocs-pr-review"
          prompt-text: "The pull request to review is ${{ inputs.pr }}."
          start-message: "üìù **AI Docs Review session starting...** Analyzing connector changes and preparing documentation recommendations."
          tags: |
            area/documentation
            team/documentation
