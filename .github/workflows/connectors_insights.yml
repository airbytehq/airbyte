name: Connectors Tests

on:
  schedule:
    # 0AM UTC is 2AM CEST, 3AM EEST, 5PM PDT.
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  connectors_insights:
    name: Connectors Insights generation
    runs-on: connector-tooling-large
    timeout-minutes: 1440 # 24 hours
    env:
      GOOGLE_APPLICATION_CREDENTIALS: ${{ secrets.METADATA_SERVICE_PROD_GCS_CREDENTIALS }}
      DAGGER_CLOUD_TOKEN: ${{ secrets.DAGGER_CLOUD_TOKEN_2 }}
    steps:
      - name: Get Dagger Engine Image
        uses: ./.github/actions/get-dagger-engine-image
        with:
          dagger_engine_image: "registry.dagger.io/engine:v0.9.6"
      - name: Checkout Airbyte
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - name: Install and configure Poetry
        uses: snok/install-poetry@v1
      - name: Install connector insights
        shell: bash
        run: |
          poetry -C airbyte-ci/connectors/connectors_insights install
          poetry -C airbyte-ci/connectors/connectors_insights run connector-insights generate --gcs-uri=gs://prod-airbyte-cloud-connector-metadata-service/connector_insights --connector-directory airbyte-integrations/connectors/ --concurrency 10
