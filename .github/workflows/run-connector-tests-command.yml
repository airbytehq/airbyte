name: Airbyte CI for Connector Contributions
# This workflow is used to run connector tests for contributors.
# It can be triggered manually via slash command or workflow dispatch.
# It also will run on push events to forks, if the fork has "BYO Secrets" defined.

on:
  workflow_dispatch:
    inputs:
      repo:
        description: "The repository name"
        required: false
        type: string
      gitref:
        description: "The git reference (branch or tag)"
        required: false
        type: string
      comment-id:
        description: "The ID of the comment triggering the workflow"
        required: false
        type: number
      pr:
        description: "The pull request number, if applicable"
        required: false
        type: number
  push:

jobs:


  debug-connector-ci-outputs:
    name: "🛠️ Debug Connector-CI Outputs"
    runs-on: ubuntu-latest
    # if: >
    #   github.event_name == 'workflow_dispatch' ||
    #   (github.event_name == 'push' &&
    #     github.repository != 'airbytehq/airbyte' &&
    #     vars.GCP_PROJECT_ID != ''
    #    )
    steps:
      - name: Dump all reusable-workflow outputs
        run: |
          echo "github.event_name   = |${{ github.event_name }}|"
          echo "github.repository   = |${{ github.repository }}|"
          echo "vars.GCP_PROJECT_ID = |${{ vars.GCP_PROJECT_ID }}|"
          echo "condition = |${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'push' && github.repository != 'airbytehq/airbyte' && vars.GCP_PROJECT_ID != '') }}|"

      - name: Skip-me
        if: >
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'push' &&
          github.repository != 'airbytehq/airbyte' &&
          vars.GCP_PROJECT_ID != '')
        run: |
          echo "This should not run."

      - name: Skip-me (2)
        if: >
          github.event_name == 'workflow_dispatch' ||
          (github.event_name == 'push' &&
           github.repository != 'airbytehq/airbyte' &&
           vars.GCP_PROJECT_ID != '')
        run: |
          echo "This should not run."

  call-connector-ci-tests:
    # Run always for 'workflow_dipatch' events.
    # Run for 'push' events on forks, but only if the fork defines "BYO Secrets".
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' &&
       github.repository != 'airbytehq/airbyte' &&
       vars.GCP_PROJECT_ID != '')
    uses: ./.github/workflows/connector-ci-tests.yml
    with:
      repo: "${{ inputs.repo || github.repository }}"
      gitref: "${{ inputs.gitref || github.ref_name }}"
      comment-id: "${{ github.event_name == 'workflow_dispatch' && inputs['comment-id'] || '' }}"
      pr: "${{ github.event_name == 'workflow_dispatch' && inputs.pr || '' }}"
    secrets: inherit
