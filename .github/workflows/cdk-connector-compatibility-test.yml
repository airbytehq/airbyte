name: CDK Connector Compatibility Test

on:
  pull_request:
    paths:
      - "airbyte-cdk/bulk/**/*"
  schedule:
    - cron: "0 12 * * *"

jobs:
  generate-matrix:
    name: Generate Connector Matrix
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@v4
        with:
          submodules: true # Needed for airbyte-enterprise connectors (no-op otherwise)
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.14"

      - name: Trigger changes on all connectors using bulk cdk # this is just an easy way to get a list of all bulk cdk connectors
        run: ./gradlew upgradeCdk --cdkVersion=local

      - name: Generate Connector Matrix from Changes
        id: generate-matrix
        run: echo "connectors_matrix=$(./poe-tasks/get-modified-connectors.sh --json --local-cdk)" | tee -a $GITHUB_OUTPUT

    outputs:
      connectors-matrix: ${{ steps.generate-matrix.outputs.connectors_matrix }}

  connectors-test:
    name: Test ${{ matrix.connector }} Connector
    needs: [generate-matrix]
    runs-on: linux-24.04-large
    env:
      GCP_GSM_CREDENTIALS: ${{ secrets.GCP_GSM_CREDENTIALS }}
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID || vars.GCP_PROJECT_ID }}
      DD_TAGS: "connector.name:${{ matrix.connector }}"

    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.connectors-matrix) }}
      max-parallel: 5 # Limit number of parallel jobs
      fail-fast: false # Don't stop on first failure
    steps:
      - name: Checkout Airbyte
        if: matrix.connector
        id: checkout
        uses: actions/checkout@v4
        with:
          submodules: true # Needed for airbyte-enterprise connectors (no-op otherwise)

      # Java deps
      - uses: actions/setup-java@v4
        if: matrix.connector
        with:
          distribution: zulu
          java-version: 21
          cache: gradle

      # The default behaviour is read-only on PR branches and read/write on master.
      # See https://github.com/gradle/actions/blob/main/docs/setup-gradle.md#using-the-cache-read-only.
      - uses: gradle/actions/setup-gradle@v4
        if: matrix.connector
        with:
          gradle-version: "8.14"

      - name: Install the latest version of uv
        if: matrix.connector
        uses: astral-sh/setup-uv@v6

      - name: Install Poe
        if: matrix.connector
        run: |
          # Install Poe so we can run the connector tasks:
          uv tool install poethepoet

      - name: Install connector dependencies
        if: matrix.connector
        working-directory: airbyte-integrations/connectors/${{ matrix.connector }}
        run: poe install

      - name: Fetch connector secrets
        # This will be skipped if the repo or fork does not set GCP_PROJECT_ID, or if it is set to an empty value.
        # Later integration tests will likely fail in this case, but we at least let them run.
        if: matrix.connector && (vars.GCP_PROJECT_ID != '')
        run: |
          airbyte-cdk secrets fetch ${{ matrix.connector }}

      - name: Run CDK upgrade # Run tests against local CDK version
        if: matrix.connector
        run: ./gradlew upgradeCdk --cdkVersion=local

      - name: Run Unit Tests
        id: run-unit-tests
        if: matrix.connector
        working-directory: airbyte-integrations/connectors/${{ matrix.connector }}
        run: poe test-unit-tests

      - name: Run Integration Tests
        id: run-integration-tests
        if: matrix.connector
        working-directory: airbyte-integrations/connectors/${{ matrix.connector }}
        run: poe test-integration-tests

      - name: Slack Notification on Failure
        if: github.event_name == 'schedule' && failure() && (steps.run-unit-tests.outcome == 'failure' || steps.run-integration-tests.outcome == 'failure')
        uses: slackapi/slack-github-action@v2.1.1
        with:
          token: ${{ secrets.SLACK_BOT_TOKEN_AIRBYTE_TEAM }}
          method: chat.postMessage
          payload: |
            channel: C09H56MT8J2 # jose-alert-test channel. The use of this channel is meant to be temporary while we evaluate the usefulness of these notifications.
            text: "`${{ matrix.connector }}` connector tests failed when using local CDK! <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|View Test Logs>"
