name: AI Canary Prerelease Command

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "Pull request number (if triggered from a PR)"
        type: number
        required: false
      comment-id:
        description: "The comment-id of the slash command. Used to update the comment with the status."
        required: false
      repo:
        description: "Repo (passed by slash command dispatcher)"
        required: false
        default: "airbytehq/airbyte"
      gitref:
        description: "Git ref (passed by slash command dispatcher)"
        required: false

run-name: "AI Canary Prerelease for PR #${{ github.event.inputs.pr }}"

permissions:
  contents: read
  issues: write
  pull-requests: read

jobs:
  ai-canary-prerelease:
    runs-on: ubuntu-latest
    steps:
      - name: Get job variables
        id: job-vars
        run: |
          echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte,oncall"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Post start comment
        if: inputs.comment-id != ''
        uses: peter-evans/create-or-update-comment@v4
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          body: |
            > **AI Canary Prerelease Started**
            >
            > Rolling out to 5-10 connections, watching results, and reporting findings.
            > [View workflow run](${{ steps.job-vars.outputs.run-url }})

      - name: Run AI Canary Prerelease
        uses: aaronsteers/devin-action@main
        with:
          comment-id: ${{ inputs.comment-id }}
          issue-number: ${{ inputs.pr }}
          playbook-macro: "!canary_prerelease"
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ steps.get-app-token.outputs.token }}
          start-message: "üê§ **AI Canary Prerelease session starting...** Rolling out to 5-10 connections, watching results, and reporting findings. [View playbook](https://github.com/airbytehq/oncall/blob/main/prompts/playbooks/canary_prerelease.md)"
          tags: |
            ai-oncall
