name: Enable Auto-Merge on Label

# This workflow enables GitHub's native auto-merge feature when auto-merge labels are added.
# It also converts draft PRs to ready status if needed.
#
# Supported labels:
#   - "auto-merge"
#   - "auto-merge/bypass-ci-checks"

on:
  pull_request_target:
    types:
      - labeled

jobs:
  enable-auto-merge:
    name: Enable Auto-Merge
    # Only run when an auto-merge label is added
    if: |
      github.event.label.name == 'auto-merge' ||
      github.event.label.name == 'auto-merge/bypass-ci-checks'
    permissions:
      contents: write
      pull-requests: write
    runs-on: ubuntu-24.04
    steps:
      - name: Convert draft to ready if needed
        if: github.event.pull_request.draft == true
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Converting draft PR to ready status..."
          gh pr ready "$PR_NUMBER" --repo "${{ github.repository }}"

      - name: Enable auto-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Enabling auto-merge with squash strategy..."
          gh pr merge --auto --squash "$PR_NUMBER" --repo "${{ github.repository }}"
