name: Terminate Zombie Build Instances

on:
  push:

jobs:
  terminate:
    runs-on: ubuntu-latest
    steps:
      - name: List and Remove Old Instances
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SELF_RUNNER_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SELF_RUNNER_AWS_SECRET_ACCESS_KEY }}
          # See https://github.com/aws/aws-cli/issues/5623
          AWS_EC2_METADATA_DISABLED: true
        run: |
          set -euxo pipefail

          aws configure set default.region us-east-2

          echo CURR_TIME=${date +%s}

          env | sort

          aws ec2 describe-instances --no-paginate --filters Name=instance-type,Values=c5.2xlarge \
            --query 'Reservations[*].Instances[*].{Instance:InstanceId,LaunchTime:LaunchTime}' --output json \
          | jq 'def c(str): str | (split("+")[0] + "Z") | fromdate ; flatten | map( { InstanceId: .Instance, LaunchTime: c(.LaunchTime) } ) | map( select ( .LaunchTime > 1626421602 ) )'
