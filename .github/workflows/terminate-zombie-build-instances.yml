name: Terminate Zombie Build Instances

on:
  push:

jobs:
  terminate:
    runs-on: ubuntu-latest
    steps:
      - name: List and Remove Old Instances
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.SELF_RUNNER_AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.SELF_RUNNER_AWS_SECRET_ACCESS_KEY }}
          AWS_EC2_METADATA_DISABLED: true
        run: |
          set -euxo pipefail

          aws configure set default.region us-east-2

          aws ec2 describe-instances --no-paginate --filters Name=instance-type,Values=c5.2xlarge \
            --query 'Reservations[*].Instances[*].{Instance:InstanceId,LaunchTime:LaunchTime}' --output json \
          | jq '.[][] | select( .LaunchTime | fromdateiso8601 > 10000)'
