# This workflow builds the documentation for the project using `poe` and `uv`.
# It is redundant with the Vercel Preview deployment, but is runs unprivileged and
# can be used on forks to verify the documentation build without deploying it.
#
# Caching Strategy:
# - On master pushes: Build and save caches for pnpm store, Rspack, and Docusaurus
# - On PRs: Restore caches from master branch (fallback) for faster builds
# - This provides a Vercel-like experience where PRs benefit from production cache
name: Docs
on:
  push:
    branches:
      - master
    paths:
      - 'docs/**'
      - 'docusaurus/**'
      - '.markdownlint.jsonc'
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  detect-changes:
    name: Detect Changes
    runs-on: ubuntu-24.04
    # Skip change detection on push events (master) - always build to refresh cache
    if: github.event_name == 'pull_request'
    steps:
      # Checkout not required from `pull_request` event.
      # The detection method uses the GitHub REST API.
      - name: Detect Changes
        id: detect-changes
        uses: dorny/paths-filter@de90cc6fb38fc0963ad72b210f1f284cd68cea36 # v3.0.2
        with:
          filters: |
            docs:
              - 'docs/**'
              - 'docusaurus/**'
              - '.markdownlint.jsonc'

    outputs:
      # 'true' if any of the docs files have changed, 'false' otherwise.
      changed: ${{ steps.detect-changes.outputs.docs }}

  build-docs:
    name: Build Airbyte Docs
    runs-on: ubuntu-24.04
    # Only depend on detect-changes for PRs (it's skipped on push events)
    needs: [detect-changes]
    # Run on master pushes (always) or on PRs when docs changed
    # Using always() to allow running even when detect-changes is skipped
    if: always() && (github.event_name == 'push' || needs.detect-changes.outputs.changed == 'true')
    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 0
          repository: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name || github.repository }}
          ref: ${{ github.event_name == 'pull_request' && github.head_ref || github.ref }}

      - name: Check For Skip Conditions
        id: check-skip
        run: |
          # temporarily disable -e so we can capture a non-zero exit
          set +e
          # Run the script and capture the exit code.
          ./docs/check-docs-git-diff.sh
          exit_code=$?
          set -e

          if [ $exit_code -eq 0 ]; then
            echo "✅ Documentation already up-to-date. No build required."
            echo skip-build=true | tee -a $GITHUB_OUTPUT
          else
            echo "❌ Documentation needs to be built."
            echo skip-build=false | tee -a $GITHUB_OUTPUT
          fi

      - name: Set Up pnpm
        if: steps.check-skip.outputs.skip-build != 'true'
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
        with:
          version: 10.12.1

      - name: Setup Node.js
        if: steps.check-skip.outputs.skip-build != 'true'
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version-file: 'docusaurus/.nvmrc'

      - name: Get pnpm store directory
        if: steps.check-skip.outputs.skip-build != 'true'
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Restore pnpm store cache
        if: steps.check-skip.outputs.skip-build != 'true'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: docs-pnpm-${{ runner.os }}-${{ hashFiles('docusaurus/pnpm-lock.yaml') }}
          restore-keys: |
            docs-pnpm-${{ runner.os }}-

      - name: Restore Rspack cache
        if: steps.check-skip.outputs.skip-build != 'true'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: docusaurus/node_modules/.cache/rspack
          key: docs-rspack-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('docs/**', 'docusaurus/**') }}
          restore-keys: |
            docs-rspack-${{ runner.os }}-${{ github.ref_name }}-
            docs-rspack-${{ runner.os }}-master-
            docs-rspack-${{ runner.os }}-

      - name: Restore Docusaurus cache
        if: steps.check-skip.outputs.skip-build != 'true'
        uses: actions/cache@5a3ec84eff668545956fd18022155c47e93e2684 # v4.2.3
        with:
          path: docusaurus/.docusaurus
          key: docs-docusaurus-${{ runner.os }}-${{ github.ref_name }}-${{ hashFiles('docs/**', 'docusaurus/**') }}
          restore-keys: |
            docs-docusaurus-${{ runner.os }}-${{ github.ref_name }}-
            docs-docusaurus-${{ runner.os }}-master-
            docs-docusaurus-${{ runner.os }}-

      - name: Install uv
        if: steps.check-skip.outputs.skip-build != 'true'
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v6.8.0

      - name: Install Poe
        if: steps.check-skip.outputs.skip-build != 'true'
        run: |
          # Install Poe so we can run the connector tasks:
          uv tool install poethepoet

      - name: Build Docs
        if: steps.check-skip.outputs.skip-build != 'true'
        run: |
          poe docs-build

  vercel-preview:
    name: Vercel Preview
    needs: detect-changes
    if: >
      github.event.pull_request.head.repo.full_name == github.repository
      && needs.detect-changes.outputs.changed == 'true'
    runs-on: ubuntu-latest
    # This workflow deploys preview builds to Vercel on pull requests.
    # Pull requests from forks are ignored.
    env:
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ vars.VERCEL_PROJECT_ID }}

    steps:
      - name: Checkout Current Branch
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          fetch-depth: 1

      - name: Deploy to Vercel
        id: deploy-vercel
        uses: amondnet/vercel-action@888da851026e0573da056b061931bcb765a915c4 # v41.1.4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ env.VERCEL_ORG_ID }}
          vercel-project-id: ${{ env.VERCEL_PROJECT_ID }}
          vercel-args: --archive=tgz

      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@df432ceedc7162793a195dd1713ff69aefc7379e # v2.0.6
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      # If successful, post a check status with the Preview URL as its "details" link
      - name: Post Custom Check with Preview URL (${{ steps.deploy-vercel.outputs.preview-url }})
        uses: LouisBrunner/checks-action@6b626ffbad7cc56fd58627f774b9067e6118af23 # v2.0.0
        with:
          name: "Vercel Preview Deployed" # << Name of the check
          status: completed
          conclusion: success
          details_url: ${{ steps.deploy-vercel.outputs.preview-url }}
          token: ${{ steps.get-app-token.outputs.token }}
