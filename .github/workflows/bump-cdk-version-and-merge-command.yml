name: Bump Java CDK Version
on:
  workflow_dispatch:
    inputs:
      repo:
        description: "Repo to check out code from. Defaults to the main airbyte repo."
        type: choice
        required: true
        default: airbytehq/airbyte
        options:
          - airbytehq/airbyte
      version:
        description: "Version to bump to. Defaults to the latest version."
        type: string
        required: true
        default: latest
jobs:
  bump-cdk-version:
    runs-on: ubuntu-24.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Validate provided version
        run: |
          # Extract the provided version
          provided_version="${{ github.event.inputs.version }}"
          
          # Extract the current version from version.properties
          current_version=$(grep '^version=' airbyte-cdk/java/airbyte-cdk/core/src/main/resources/version.properties | cut -d'=' -f2)
          
          # Check if the provided version follows SemVer
          if ! [[ "$provided_version" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Provided version '$provided_version' is not a valid SemVer version."
            exit 1
          fi
          
          # Compare the provided version with the current version
          if [ "$(printf '%s\n' "$current_version" "$provided_version" | sort -V | head -n1)" = "$provided_version" ] && [ "$current_version" != "$provided_version" ]; then
            echo "Error: Provided version '$provided_version' is not greater than the current version '$current_version'."
            exit 1
          fi
          
          echo "Provided version '$provided_version' is valid and greater than the current version '$current_version'."

      - name: Update version.properties
        run: |
          # Extract the provided version
          provided_version="${{ github.event.inputs.version }}"
          
          # Update the version in version.properties
          sed -i "s/^version=.*/version=$provided_version/" airbyte-cdk/java/airbyte-cdk/core/src/main/resources/version.properties
          
          echo "Updated version.properties with version '$provided_version'."

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update cdkVersionRequired in build.gradle files
        run: |
          # Ensure the branch has the most recent updates from the master branch
          git fetch origin master

          # Get the list of modified files between the default branch and the current branch
          modified_files=$(git diff --name-only origin/master)

          connector_folders=$(echo "$modified_files" | \
            grep -oP 'airbyte-integrations/connectors/\K[^/]+' | \
            sort | \
            uniq)
          
          echo "modified_connextors=${connector_folders}" >> $GITHUB_OUTPUT

          for folder in $connector_folders; do
            gradle_file="airbyte-integrations/connectors/$folder/build.gradle"
            if [ -f "$gradle_file" ]; then
              sed -i "s/cdkVersionRequired = '.*'/cdkVersionRequired = '${{ github.event.inputs.version }}'/" "$gradle_file"
              sed -i "/useLocalCdk/d" "$gradle_file"
            fi
          done

      - name: Commit changes
        run: |
          git add .
          git commit -m "Bump the cdk version to ${{ github.event.inputs.version }}"
          git push

  publish-java-cdk:
    needs: [bump-cdk-version]
    uses: ./.github/workflows/publish-java-cdk-command.yml
    with:
      gitref: ${{ github.ref_name }}
      dry-run: true
      force: false
    secrets: inherit

  publish-connectors:
    needs: [publish-java-cdk]
    uses: ./.github/workflows/publish_connectors.yml
    with:
      connectors-options: "--name=$modified_connectors"
      ref: ${{ github.ref_name }}
    secrets: inherit
    #runs-on: ubuntu-24.04
    #steps:
    #  - name: Checkout repository
    #    uses: actions/checkout@v4
    #  - name: Configure Git
    #    run: |
    #      git config user.name "github-actions[bot]"
    #      git config user.email "github-actions[bot]@users.noreply.github.com"
    #  - name: Release the connector
    #    env:
    #      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Automatically provided by GitHub Actions
    #      AUTO_MERGE_PRODUCTION: false
    #    run: |
    #      # Ensure the branch has the most recent updates from the master branch
    #      git fetch origin master
    #
    #      modified_files=$(git diff --name-only origin/master)
#
    #      # Process the list to get the unique connector folder names
    #      connector_folders=$(echo "$modified_files" | \
    #      grep -oP 'airbyte-integrations/connectors/\K[^/]+' | \
    #      sort | \
    #      uniq)

    #      poetry install

    #      # Read each line from the connector_folders variable
    #      echo "$connector_folders" | while read -r folder; do
    #        # Call the function, passing the current folder name as an argument
    #        echo "Triggering workflow for connector: $folder"
    #        # gh workflow run 'Connector Ops CI - Publish Connectors' --ref ${{ github.ref_name }} -F connectors-options="--name=$folder"
    #        poetry run airbyte-ci connectors --name="$folder" add-changelog --message="Update CDK version"git ad
    #        git add .
    #        git commit -m "Update changelog for $folder"
    #        git push
    #      done
    #
    #      # poetry install
    #      # poetry run auto-merge
    #    working-directory: ${{ github.workspace }} # Ensure gh command runs from the repo root
