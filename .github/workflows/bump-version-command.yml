name: Bump versions for connectors in a PR

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "Pull request number. This PR will be referenced in the changelog line."
        type: number
        required: false
      comment-id:
        description: "Optional. The comment-id of the slash command. Used to update the comment with the status."
        required: false

      type:
        description: "The type of bump to perform. One of 'major', 'minor', or 'patch'."
        required: false
        default: "patch"

      changelog:
        description: "Optional. The comment to add to the changelog. If not provided, the PR title will be used."
        required: false
        # If not provided, we'll use the PR title as the changelog
        default: ""

      # These must be declared, but they are unused and ignored.
      # TODO: Infer 'repo' and 'gitref' from PR number on other workflows, so we can remove these.
      repo:
        description: "Repo (Ignored)"
        required: false
        default: "airbytehq/airbyte"
      gitref:
        description: "Ref (Ignored)"
        required: false

run-name: "Bump connector versions in PR: #${{ github.event.inputs.pr }}"
concurrency:
  group: ${{ github.workflow }}-${{ github.event.inputs.pr }}
  # Cancel any previous runs on the same branch if they are still in progress
  cancel-in-progress: true

jobs:
  generate-matrix:
    name: "Generate connector matrix"
    runs-on: ubuntu-24.04
    outputs:
      connectors-matrix: ${{ steps.generate-matrix.outputs.connectors_matrix }}
      repo: ${{ steps.job-vars.outputs.repo }}
      branch: ${{ steps.job-vars.outputs.branch }}
      pr_title: ${{ steps.job-vars.outputs.pr_title }}
      run-url: ${{ steps.job-vars.outputs.run-url }}
      comment-id: ${{ steps.first-comment-action.outputs.comment-id }}
    steps:
      - name: Get job variables
        id: job-vars
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.inputs.pr }})
          echo "repo=$(echo "$PR_JSON" | jq -r .head.repo.full_name)" >> $GITHUB_OUTPUT
          echo "branch=$(echo "$PR_JSON" | jq -r .head.ref)" >> $GITHUB_OUTPUT
          echo "pr_title=$(echo "$PR_JSON" | jq -r .title)" >> $GITHUB_OUTPUT
          echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      # NOTE: We still use a PAT here (rather than a GitHub App) because the workflow needs
      # permissions to add commits to our main repo as well as forks. This will only work on
      # forks if the user installs the app into their fork. Until we document this as a clear
      # path, we will have to keep using the PAT.
      - name: Checkout Airbyte
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          repository: ${{ steps.job-vars.outputs.repo }}
          ref: ${{ steps.job-vars.outputs.branch }}
          fetch-depth: 0
          # Important that token is a PAT so that CI checks are triggered again.
          # Without this we would be forever waiting on required checks to pass.
          token: ${{ secrets.GH_PAT_APPROVINGTON_OCTAVIA }}

      - name: Append comment with job run link
        # If comment-id is not provided, this will create a new
        # comment with the job run link.
        id: first-comment-action
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          comment-id: ${{ github.event.inputs.comment-id }}
          issue-number: ${{ github.event.inputs.pr }}
          body: |

            > Bump Version job started... [Check job output.][1]

            [1]: ${{ steps.job-vars.outputs.run-url }}

      - name: Install uv
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v6.8.0

      - name: Generate connector matrix
        id: generate-matrix
        run: |
          # Get modified connectors using airbyte-ops CLI
          MATRIX_JSON=$(uvx --from=airbyte-internal-ops airbyte-ops repo connector list \
            --modified-only \
            --pr=${{ github.event.inputs.pr }} \
            --output-format=json-gh-matrix)

          # Handle empty matrix case - add empty connector for no-op run
          if [ "$(echo "$MATRIX_JSON" | jq '.include | length')" -eq 0 ]; then
            MATRIX_JSON='{"include": [{"connector": ""}]}'
          fi

          echo "connectors_matrix=$MATRIX_JSON" >> $GITHUB_OUTPUT
          echo "Matrix: $MATRIX_JSON"

  bump-version:
    name: "Bump ${{ matrix.connector }}${{ matrix.connector == '' && ' (no connectors modified)' || '' }}"
    needs: [generate-matrix]
    runs-on: ubuntu-24.04
    strategy:
      matrix: ${{ fromJson(needs.generate-matrix.outputs.connectors-matrix) }}
      fail-fast: false
    steps:
      - name: Checkout Airbyte
        if: matrix.connector != ''
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          repository: ${{ needs.generate-matrix.outputs.repo }}
          ref: ${{ needs.generate-matrix.outputs.branch }}
          fetch-depth: 1
          token: ${{ secrets.GH_PAT_APPROVINGTON_OCTAVIA }}

      - name: Install uv
        if: matrix.connector != ''
        uses: astral-sh/setup-uv@d0cc045d04ccac9d8b7881df0226f9e82c39688e # v6.8.0

      - name: Log changelog source
        if: matrix.connector != ''
        run: |
          if [ -n "${{ github.event.inputs.changelog }}" ]; then
            echo "Using user-provided changelog: ${{ github.event.inputs.changelog }}"
          else
            echo "Using PR title as changelog: ${{ needs.generate-matrix.outputs.pr_title }}"
          fi

      - name: Bump version for ${{ matrix.connector }}
        if: matrix.connector != ''
        run: |
          CHANGELOG_MSG="${{ github.event.inputs.changelog != '' && github.event.inputs.changelog || needs.generate-matrix.outputs.pr_title }}"

          uvx --from=airbyte-internal-ops airbyte-ops repo connector bump-version \
            --name="${{ matrix.connector }}" \
            --repo-path=. \
            --bump-type="${{ github.event.inputs.type }}" \
            --changelog-message="$CHANGELOG_MSG" \
            --pr-number=${{ github.event.inputs.pr }}

      # This is helpful in the case that we change a previously committed generated file to be ignored by git.
      - name: Remove any files that have been gitignored
        if: matrix.connector != ''
        run: git ls-files -i -c --exclude-from=.gitignore | xargs -r git rm --cached

      # Check for changes in git
      - name: Check for changes
        if: matrix.connector != ''
        id: git-diff
        run: |
          git diff --quiet && echo "No changes to commit" || echo "changes=true" >> $GITHUB_OUTPUT
        shell: bash

      # Commit changes (if any)
      - name: Commit changes
        id: commit-step
        if: matrix.connector != '' && steps.git-diff.outputs.changes == 'true'
        run: |
          git config --global user.name "Octavia Squidington III"
          git config --global user.email "octavia-squidington-iii@users.noreply.github.com"
          git add .
          git commit -m "chore: bump-version ${{ matrix.connector }} ${{ github.event.inputs.type }}"
          echo "sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT

      - name: Push changes
        if: matrix.connector != '' && steps.git-diff.outputs.changes == 'true'
        run: |
          git remote add contributor https://github.com/${{ needs.generate-matrix.outputs.repo }}.git || true
          git push contributor HEAD:'${{ needs.generate-matrix.outputs.branch }}'

  report-status:
    name: "Report status"
    needs: [generate-matrix, bump-version]
    runs-on: ubuntu-24.04
    if: always()
    steps:
      - name: Append success comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        if: needs.bump-version.result == 'success'
        with:
          comment-id: ${{ needs.generate-matrix.outputs.comment-id }}
          reactions: hooray
          body: |
            > âœ… Bump version completed successfully.

      - name: Append failure comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        if: needs.bump-version.result == 'failure'
        with:
          comment-id: ${{ needs.generate-matrix.outputs.comment-id }}
          reactions: confused
          body: |
            > ğŸ”´ Bump version job failed.

      - name: Append skipped comment
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        if: needs.bump-version.result == 'skipped'
        with:
          comment-id: ${{ needs.generate-matrix.outputs.comment-id }}
          reactions: "-1"
          body: |
            > ğŸ”´ No connectors found to bump.
