# Autodoc Workflow
#
# This workflow automatically triggers documentation updates for community-supported connectors
# when changes are pushed to master. It uses Devin AI to review connector changes and
# update the corresponding user documentation to ensure it stays current with code changes.
#
# Workflow triggers:
# - Only on pushes to master branch
# - Excludes bot-authored pushes to prevent automation loops
# - Only processes community-supported connectors

name: Autodoc

on:
  push:
    branches:
      - master

jobs:
  update-connector-documentation:
    name: Update connector documentation with AI
    runs-on: ubuntu-latest
    # Only run for human authors, exclude bot accounts
    if: |
      !contains(fromJSON('["airbyteio", "octavia-bot", "octavia-bot-hoard", "github-actions[bot]", "dependabot[bot]"]'), github.actor) &&
      !endsWith(github.actor, '[bot]')

    steps:
      # Step 1: Get the pushed code
      - name: Checkout pushed code
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0 # Full history needed for comprehensive analysis

      # Step 2: Analyze what files were changed in this push
      - name: Get files changed in this push
        id: push-files
        run: |
          echo "üîç Fetching files changed in push from ${{ github.event.before }} to ${{ github.sha }}..."
          FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | jq -R -s -c 'split("\n")[:-1]')

          if [ -z "$FILES" ] || [ "$FILES" = "[]" ]; then
            echo "‚ÑπÔ∏è  No files changed in this push - skipping documentation update."
            exit 0
          fi

          echo "‚úÖ Successfully fetched changed files list"
          echo "files=$FILES" >> $GITHUB_OUTPUT

      # Step 3: Install YAML parsing tool
      - name: Install YAML parser (yq)
        run: |
          echo "üì¶ Installing yq for metadata.yaml parsing..."
          sudo wget https://github.com/mikefarah/yq/releases/download/v4.47.2/yq_linux_amd64 -O /usr/local/bin/yq
          sudo chmod +x /usr/local/bin/yq
          echo "‚úÖ yq v4.47.2 installed successfully"

      # Step 4: Determine if this push affects a community-supported connector
      - name: Determine if connector is community-supported
        id: check-support-level
        run: |
          echo "üîç Checking if push contains community-supported connector changes..."

          # Parse the changed files from Step 2
          CHANGED_FILES='${{ steps.push-files.outputs.files }}'

          # Filter for connector metadata.yaml files in the changed files
          METADATA_FILE=$(echo "$CHANGED_FILES" | yq -p json -r '.[] | select(test("airbyte-integrations/connectors/.*/metadata\\.yaml$"))' | head -n 1)

          if [ -z "$METADATA_FILE" ]; then
            echo "‚ÑπÔ∏è  No connector metadata.yaml file found in changed files - this push doesn't affect connectors"
            echo "metadata_file=false" >> $GITHUB_OUTPUT
            echo "community_support=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Parse the support level from the metadata
          SUPPORT_LEVEL=$(yq '.data.supportLevel' "$METADATA_FILE")
          echo "üìã Found metadata file: $METADATA_FILE"
          echo "üìã Support level: $SUPPORT_LEVEL"

          if [ "$SUPPORT_LEVEL" != "community" ]; then
            echo "‚ÑπÔ∏è  This connector is not community-supported (level: $SUPPORT_LEVEL)"
            echo "metadata_file=true" >> $GITHUB_OUTPUT
            echo "community_support=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "‚úÖ Community-supported connector detected - documentation update needed"
          echo "metadata_file=true" >> $GITHUB_OUTPUT
          echo "community_support=true" >> $GITHUB_OUTPUT

      # Step 5: Skip documentation update for non-community connectors
      - name: Skip documentation update (not community connector)
        if: steps.check-support-level.outputs.metadata_file == 'false' || steps.check-support-level.outputs.community_support == 'false'
        run: |
          echo "‚è≠Ô∏è  Skipping documentation update:"
          echo "   - Metadata file found: ${{ steps.check-support-level.outputs.metadata_file }}"
          echo "   - Community support: ${{ steps.check-support-level.outputs.community_support }}"
          echo "   - Only community-supported connectors trigger automatic documentation updates"

      # Step 6: Trigger AI documentation update for community connectors
      - name: Start AI documentation update session
        if: steps.check-support-level.outputs.metadata_file == 'true' && steps.check-support-level.outputs.community_support == 'true'
        env:
          PROMPT_TEXT: "The commit to review is ${{ github.sha }}. This commit was pushed to master and may contain connector changes that need documentation updates."
        uses: aaronsteers/devin-action@0d74d6d9ff1b16ada5966dc31af53a9d155759f4 # Pinned to specific commit for security
        with:
          devin-token: ${{ secrets.DEVIN_AI_API_KEY }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          playbook-macro: "!connectordocs" # Use the connector documentation playbook
          prompt-text: ${{ env.PROMPT_TEXT }}
          tags: |
            area/documentation
            team/documentation
