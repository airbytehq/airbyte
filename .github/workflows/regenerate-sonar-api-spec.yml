name: Regenerate Sonar API Spec Cache

on:
  schedule:
    # Run daily at 06:00 UTC
    - cron: "0 6 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  regenerate-spec:
    name: Regenerate Sonar API Spec
    runs-on: ubuntu-24.04
    steps:
      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2
        id: app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Get GitHub App User ID
        id: get-user-id
        run: echo "user-id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: Configure Git
        run: |
          git config --global user.name '${{ steps.app-token.outputs.app-slug }}[bot]'
          git config --global user.email '${{ steps.get-user-id.outputs.user-id }}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com'

      - name: Checkout Airbyte
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          token: ${{ steps.app-token.outputs.token }}

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4
        with:
          version: "9.4.0"

      - name: Remove yarn to prevent package manager detection issues
        run: rm -f "$(which yarn)" || true

      - name: Install dependencies
        working-directory: docusaurus
        run: pnpm install --frozen-lockfile

      - name: Regenerate Sonar API spec
        working-directory: docusaurus
        run: |
          node src/scripts/embedded-api/prepare-embedded-api-spec.js
          pnpm prettier --write src/data/embedded_api_spec.json

      - name: Check for changes
        id: check-changes
        working-directory: docusaurus
        run: |
          if git diff --quiet src/data/embedded_api_spec.json; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in Sonar API spec"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in Sonar API spec"
          fi

      - name: Create Pull Request
        id: create-pr
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          token: ${{ steps.app-token.outputs.token }}
          commit-message: "chore(docs): regenerate cached Sonar API spec"
          branch: "auto-regenerate-sonar-api-spec"
          delete-branch: true
          title: "chore(docs): regenerate cached Sonar API spec"
          body: |
            Regenerates the cached Sonar API spec in Docusaurus to reflect the latest API changes from the upstream Sonar service.

            This PR was automatically generated by the daily cron workflow.

            Generated by [automated workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          labels: |
            auto-merge
            auto-generated
            documentation
