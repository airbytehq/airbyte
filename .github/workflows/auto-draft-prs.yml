name: Auto-Draft PRs

# This workflow automatically converts new PRs to draft status.
# Rationale: Making a PR "ready for review" should be a conscious decision.
# Authors can easily mark their PR as ready when appropriate.
#
# Opt-out: Include "[ready]" in the PR title, or add one of these labels:
#   - "skip-draft-status"
#   - "auto-merge"
#   - "auto-merge/bypass-ci-checks"

on:
  pull_request_target:
    types:
      - opened

jobs:
  auto-draft:
    name: Convert PR to Draft
    # Skip if:
    # - PR is already a draft
    # - PR title contains "[ready]" (opt-out)
    # - PR has opt-out label (skip-draft-status, auto-merge, auto-merge/bypass-ci-checks)
    # - PR is from a bot (Dependabot, etc.)
    if: |
      github.event.pull_request.draft == false &&
      !contains(github.event.pull_request.title, '[ready]') &&
      !contains(toJson(github.event.pull_request.labels.*.name), 'skip-draft-status') &&
      !contains(toJson(github.event.pull_request.labels.*.name), 'auto-merge') &&
      github.event.pull_request.user.type != 'Bot'
    permissions:
      contents: read
      pull-requests: write
    runs-on: ubuntu-24.04
    steps:
      - name: Convert PR to draft
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr ready --undo "$PR_NUMBER" --repo "${{ github.repository }}"

      - name: Add comment explaining draft status
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            Thank you for creating this PR. As a policy to protect our engineers' time, we require all PRs to be created first in draft status. Your PR has been converted to draft status in respect for this policy.

            Once the PR has been tested and is ready for review, you can proceed to convert the PR to "ready for review" status by clicking the "Ready for review" button at the bottom of the PR page.

            To skip this auto-draft behavior, include `[ready]` in your PR title or add the `skip-draft-status` label when creating the PR.
