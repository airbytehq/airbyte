# Whenever a change is made to the connector base image Dockerfiles, this workflow will be
# triggered.

# NOTE: This workflow does not publish the images to Docker Hub. It only builds them and tests them.

name: Dockerimage Build Testing for Connector and Base Images
on:
  pull_request:
    paths:
      - docker-images/Dockerfile.java-connector
      - docker-images/Dockerfile.java-connector-base
      - docker-images/Dockerfile.python-connector
      - docker-images/Dockerfile.python-connector-base


jobs:
  detect-changes:
    name: Detect changes in connector base image Dockerfiles
    runs-on: ubuntu-latest
    outputs:
      java-base: ${{ steps.changes.outputs.java-base }}
      python-base: ${{ steps.changes.outputs.python-base }}
      java-connector: ${{ steps.changes.outputs.java-connector }}
      python-connector: ${{ steps.changes.outputs.python-connector }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - id: changes
        uses: dorny/paths-filter@v3.0.2
        with:
          filters: |
            java-connector:
              - 'docker-images/Dockerfile.java-connector'
            java-base:
              - 'docker-images/Dockerfile.java-connector-base'
            python-connector:
              - 'docker-images/Dockerfile.python-connector'
            python-base:
              - 'docker-images/Dockerfile.python-connector-base'

  build-base-images:
    name: Build Base Images
    runs-on: ubuntu-latest
    needs: detect-changes
    if: >
      needs.detect-changes.outputs.java-base ||
      needs.detect-changes.outputs.python-base
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Java Base Image
        id: docker-build-java-base
        if: needs.detect-changes.outputs.java-base == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker-images/Dockerfile.java-connector-base
          platforms: linux/amd64,linux/arm64
          tags: airbyte/java-connector-base:draft-pr-${{ github.event.pull_request.number }}
          push: false

      - name: Build Python Base Image
        id: docker-build-python-base
        if: needs.detect-changes.outputs.python-base == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker-images/Dockerfile.python-connector-base
          platforms: linux/amd64,linux/arm64
          tags: airbyte/python-connector-base:draft-pr-${{ github.event.pull_request.number }}
          push: false
    outputs:
      java-base-image: ${{ steps.docker-build-java-base.outputs.target }}
      python-base-image: ${{ steps.docker-build-python-base.outputs.target }}

  test-build-java-connectors:
    name: Test Java Connector Base Image
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images]
    if: >
      needs.detect-changes.outputs.java-connector ||
      needs.build-base-images.outputs.java-base-image
    strategy:
      fail-fast: false
      matrix:
        connector:
          - source-mysql
          - source-postgres
          - destination-mysql
          - destination-postgres
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Java Connector Base Image
        id: docker-build-java-connector
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker-images/Dockerfile.java-connector
          platforms: linux/amd64,linux/arm64
          tags: airbyte/java-connector:draft-pr-${{ github.event.pull_request.number }}
          build-args: |
            CONNECTOR=${{ matrix.connector }}
            BASE_IMAGE=${{ needs.build-base-images.outputs.java-base-image || 'docker.io/airbyte/java-connector-base:latest'  }}
          push: false

  test-build-python-connectors:
    name: Test Python Connector Base Image
    runs-on: ubuntu-latest
    needs: [detect-changes, build-base-images]
    if: >
      needs.detect-changes.outputs.python-connector ||
      needs.build-base-images.outputs.python-base-image
    strategy:
      fail-fast: false
      matrix:
        connector:
          - source-s3
          - source-hubspot
          - source-shopify
          - destination-motherduck
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Python Connector Base Image
        id: docker-build-python-connector
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker-images/Dockerfile.python-connector
          platforms: linux/amd64,linux/arm64
          tags: airbyte/python-connector:draft-pr-${{ github.event.pull_request.number }}
          build-args: |
            CONNECTOR=${{ matrix.connector }}
            BASE_IMAGE=${{ needs.build-base-images.outputs.python-base-image || 'docker.io/airbyte/python-connector-base:latest' }}
          push: false
