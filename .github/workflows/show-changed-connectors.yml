name: Changed connector

on:
  push:
    branches-ignore:
      - "gitbook/v1"

jobs:

  find_valid_pat:
    name: "Find a PAT with room for actions"
    timeout-minutes: 10
    runs-on: ubuntu-latest
    outputs:
      pat: ${{ steps.variables.outputs.pat }}
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@v2
      - name: Check PAT rate limits
        id: variables
        run: |
          ./tools/bin/find_non_rate_limited_PAT \
            ${{ secrets.AIRBYTEIO_PAT }} \
            ${{ secrets.OSS_BUILD_RUNNER_GITHUB_PAT }} \
            ${{ secrets.SUPERTOPHER_PAT }} \
            ${{ secrets.DAVINCHIA_PAT }}

  show-affected-connectors:
    name: "Show affected connectors"
    needs:
      - find_valid_pat
    runs-on: ubuntu-latest
    steps:
      - name: Extract current branch name
        shell: bash
        run: echo "##[set-output name=branch;]$(echo ${GITHUB_REF#refs/heads/})"
        id: extract_current_branch
      - name: Extract changed files
        shell: bash
        run: echo "##[set-output name=files;]$(git diff --name-only master...${{steps.extract_current_branch.outputs.branch}})"
        with:
          github-token: ${{ needs.find_valid_pat.outputs.pat }}
        id: extract_changed_files
      - name: Debbug
        run: |
          echo "!!! DEBBUG !!! "
          echo ${{ steps.extract_current_branch.outputs.branch }}
          echo ${{ needs.find_valid_pat.outputs.pat }}
          git branch