name: On-Demand Connector Regression Tests
# This workflow triggers the regression test workflow in airbyte-ops-mcp.
# Logs and artifacts are kept in the private airbyte-ops-mcp repo.
# See: https://github.com/airbytehq/airbyte-ops-mcp

concurrency:
  # This is the name of the concurrency group. It is used to prevent concurrent runs of the same workflow.
  #
  # - github.head_ref is only defined on PR runs, it makes sure that the concurrency group is unique for pull requests
  #  ensuring that only one run per pull request is active at a time.
  #
  # - github.run_id is defined on all runs, it makes sure that the concurrency group is unique for workflow dispatches.
  # This allows us to run multiple workflow dispatches in parallel.
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      # Global static-arg inputs for slash commands
      repo:
        description: "The repository name"
        required: false
        default: "airbytehq/airbyte"
        type: string
      gitref:
        description: "The git reference (branch or tag)"
        required: false
        type: string
      comment-id:
        description: "The ID of the comment triggering the workflow"
        required: false
        type: number
      pr:
        description: "The pull request number, if applicable"
        required: false
        type: number

      # Workflow-specific inputs
      target_image:
        description: "Target connector image (new version) with tag (e.g., airbyte/source-github:2.0.0)"
        required: true
        type: string
      control_image:
        description: "Control connector image (baseline version) with tag (e.g., airbyte/source-github:1.0.0)"
        required: true
        type: string
      command:
        description: "Airbyte command to run"
        required: false
        type: choice
        options:
          - spec
          - check
          - discover
          - read
        default: check
      connection_id:
        description: "Airbyte Cloud connection ID to fetch config/catalog from"
        required: false
        type: string
      state_path:
        description: "Path to state JSON file (optional for read)"
        required: false
        type: string

jobs:
  trigger_regression_tests:
    name: Trigger Regression Tests in airbyte-ops-mcp
    runs-on: ubuntu-24.04
    steps:
      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: airbytehq
          repositories: |
            airbyte
            airbyte-ops-mcp
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Build inputs JSON
        id: build-inputs
        run: |
          # Build the inputs JSON as compact single-line output for GITHUB_OUTPUT
          INPUTS_JSON=$(jq -c -n \
            --arg target_image "${{ inputs.target_image }}" \
            --arg control_image "${{ inputs.control_image }}" \
            --arg command "${{ inputs.command || 'check' }}" \
            --arg connection_id "${{ inputs.connection_id }}" \
            --arg state_path "${{ inputs.state_path }}" \
            '{
              target_image: $target_image,
              control_image: $control_image,
              command: $command
            } + (if $connection_id != "" then {connection_id: $connection_id} else {} end)
              + (if $state_path != "" then {state_path: $state_path} else {} end)')

          echo "Triggering regression test workflow with inputs:"
          echo "$INPUTS_JSON" | jq .
          echo "inputs_json=$INPUTS_JSON" >> "$GITHUB_OUTPUT"

      - name: Trigger regression test workflow in airbyte-ops-mcp
        id: trigger-workflow
        uses: the-actions-org/workflow-dispatch@v4
        with:
          workflow: connector-regression-test.yml
          repo: airbytehq/airbyte-ops-mcp
          ref: main
          token: ${{ steps.get-app-token.outputs.token }}
          inputs: ${{ steps.build-inputs.outputs.inputs_json }}
          wait-for-completion: true
          wait-for-completion-timeout: 30m
          wait-for-completion-interval: 30s
          display-workflow-run-url: true

      - name: Post result to PR comment
        if: always() && inputs.pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.get-app-token.outputs.token }}
          script: |
            const conclusion = '${{ steps.trigger-workflow.outputs.workflow-conclusion }}' || 'unknown';
            const workflowUrl = '${{ steps.trigger-workflow.outputs.workflow-url }}' || 'https://github.com/airbytehq/airbyte-ops-mcp/actions/workflows/connector-regression-test.yml';
            const targetImage = '${{ inputs.target_image }}';
            const controlImage = '${{ inputs.control_image }}';
            const command = '${{ inputs.command || 'check' }}';

            const statusEmoji = conclusion === 'success' ? ':white_check_mark:' : conclusion === 'failure' ? ':x:' : ':warning:';

            const body = `## Regression Test Results ${statusEmoji}

            **Target:** \`${targetImage}\`
            **Control:** \`${controlImage}\`
            **Command:** \`${command}\`
            **Result:** \`${conclusion}\`

            [View full test logs](${workflowUrl}) (requires access to airbyte-ops-mcp)`;

            await github.rest.issues.createComment({
              owner: 'airbytehq',
              repo: 'airbyte',
              issue_number: ${{ inputs.pr || 0 }},
              body: body
            });

      - name: Output workflow result
        if: always()
        run: |
          conclusion="${{ steps.trigger-workflow.outputs.workflow-conclusion }}"
          conclusion="${conclusion:-unknown}"
          workflow_url="${{ steps.trigger-workflow.outputs.workflow-url }}"
          workflow_url="${workflow_url:-https://github.com/airbytehq/airbyte-ops-mcp/actions/workflows/connector-regression-test.yml}"
          target_image="${{ inputs.target_image }}"
          control_image="${{ inputs.control_image }}"
          command="${{ inputs.command }}"
          command="${command:-check}"

          echo "Regression test workflow completed."
          echo "Conclusion: $conclusion"
          echo "Workflow URL: $workflow_url"

          {
            echo "## Regression Test Results"
            echo ""
            echo "**Target:** \`$target_image\`"
            echo "**Control:** \`$control_image\`"
            echo "**Command:** \`$command\`"
            echo "**Conclusion:** \`$conclusion\`"
            echo ""
            echo "[View full test logs in airbyte-ops-mcp]($workflow_url)"
          } >> "$GITHUB_STEP_SUMMARY"
