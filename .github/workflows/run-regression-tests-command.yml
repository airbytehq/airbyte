name: On-Demand Connector Regression Tests
# This workflow triggers the regression test workflow in airbyte-ops-mcp.
# Logs and artifacts are kept in the private airbyte-ops-mcp repo.
# See: https://github.com/airbytehq/airbyte-ops-mcp

concurrency:
  # This is the name of the concurrency group. It is used to prevent concurrent runs of the same workflow.
  #
  # - github.head_ref is only defined on PR runs, it makes sure that the concurrency group is unique for pull requests
  #  ensuring that only one run per pull request is active at a time.
  #
  # - github.run_id is defined on all runs, it makes sure that the concurrency group is unique for workflow dispatches.
  # This allows us to run multiple workflow dispatches in parallel.
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      # Global static-arg inputs for slash commands
      repo:
        description: "The repository name"
        required: false
        default: "airbytehq/airbyte"
        type: string
      gitref:
        description: "The git reference (branch or tag)"
        required: false
        type: string
      comment-id:
        description: "The ID of the comment triggering the workflow"
        required: false
        type: number
      pr:
        description: "The pull request number, if applicable"
        required: false
        type: number

      # Workflow-specific inputs
      target_image:
        description: "Target connector image (new version) with tag (e.g., airbyte/source-github:2.0.0)"
        required: true
        type: string
      control_image:
        description: "Control connector image (baseline version) with tag (e.g., airbyte/source-github:1.0.0)"
        required: true
        type: string
      command:
        description: "Airbyte command to run"
        required: false
        type: choice
        options:
          - spec
          - check
          - discover
          - read
        default: check
      connection_id:
        description: "Airbyte Cloud connection ID to fetch config/catalog from"
        required: false
        type: string
      state_path:
        description: "Path to state JSON file (optional for read)"
        required: false
        type: string

jobs:
  trigger_regression_tests:
    name: Trigger Regression Tests in airbyte-ops-mcp
    runs-on: ubuntu-24.04
    steps:
      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: airbytehq
          repositories: |
            airbyte
            airbyte-ops-mcp
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Build inputs JSON
        id: build-inputs
        run: |
          # Build the inputs JSON as compact single-line output for GITHUB_OUTPUT
          INPUTS_JSON=$(jq -c -n \
            --arg target_image "${{ inputs.target_image }}" \
            --arg control_image "${{ inputs.control_image }}" \
            --arg command "${{ inputs.command || 'check' }}" \
            --arg connection_id "${{ inputs.connection_id }}" \
            --arg state_path "${{ inputs.state_path }}" \
            '{
              target_image: $target_image,
              control_image: $control_image,
              command: $command
            } + (if $connection_id != "" then {connection_id: $connection_id} else {} end)
              + (if $state_path != "" then {state_path: $state_path} else {} end)')

          echo "Triggering regression test workflow with inputs:"
          echo "$INPUTS_JSON" | jq .
          echo "inputs_json=$INPUTS_JSON" >> "$GITHUB_OUTPUT"

      - name: Trigger regression test workflow in airbyte-ops-mcp
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: connector-regression-test.yml
          repo: airbytehq/airbyte-ops-mcp
          ref: main
          token: ${{ steps.get-app-token.outputs.token }}
          inputs: ${{ steps.build-inputs.outputs.inputs_json }}

      - name: Output workflow link
        run: |
          echo "Regression test workflow triggered in airbyte-ops-mcp."
          echo "View the workflow runs at: https://github.com/airbytehq/airbyte-ops-mcp/actions/workflows/connector-regression-test.yml"
