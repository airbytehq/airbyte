name: Auto Upgrade CDK for Certified Connectors
on:
  # schedule:
  # TODO run every 3 weeks
  #   # Run daily at 2 AM UTC
  #   - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  list-certified-connectors:
    name: List Certified Connectors
    runs-on: ubuntu-24.04
    outputs:
      connectors: ${{ steps.list-connectors.outputs.connectors }}
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@v4

      - name: List certified connectors
        id: list-connectors
        run: |
          connectors=()
          for dir in airbyte-integrations/connectors/*; do
            metadata_file="${dir}/metadata.yaml"
            if test -f "$metadata_file"; then
              if grep -q "supportLevel: certified" "$metadata_file"; then
                connector_name=$(basename "$dir")
                connectors+=("$connector_name")
              fi
            fi
          done

          # Convert to JSON array
          json_array=$(printf '%s\n' "${connectors[@]}" | jq -R . | jq -s .)
          echo "connectors=$json_array" >> $GITHUB_OUTPUT
          echo "Found ${#connectors[@]} certified connectors"

  upgrade-connector-cdk:
    name: Upgrade CDK for ${{ matrix.connector }}
    needs: list-certified-connectors
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        connector: ${{ fromJson(needs.list-certified-connectors.outputs.connectors) }}
      fail-fast: false
      max-parallel: 5
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "zulu"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Run upgradeCdk for ${{ matrix.connector }}
        id: upgrade-cdk
        run: |
          ./gradlew :airbyte-integrations:connectors:${{ matrix.connector }}:upgradeCdk

      - name: Check for changes
        id: check-changes
        if: steps.upgrade-cdk.outputs.exit_code == '0'
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected for ${{ matrix.connector }}"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected for ${{ matrix.connector }}"
          fi

      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: upgrade CDK for ${{ matrix.connector }}"
          branch: "auto-upgrade-cdk/${{ matrix.connector }}"
          delete-branch: true
          title: "chore: upgrade CDK for ${{ matrix.connector }}"
          body: |
            ## Summary
            - Automatically upgraded CDK version for `${{ matrix.connector }}`

            ## Changes
            This PR was automatically generated by the auto-upgrade-certified-connectors-cdk workflow.

            ## Test plan
            - [ ] Review the changes
            - [ ] Verify the connector still passes tests

            ðŸ¤– Generated with automated workflow
          labels: |
            area/connectors
            auto-cdk-upgrade
          assignees: ""
          reviewers: ""
