name: Auto Upgrade CDK for Certified Connectors
on:
  # schedule:
  # TODO run every 3 weeks
  #   # Run daily at 2 AM UTC
  #   - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  list-certified-connectors:
    name: List Certified Connectors
    runs-on: ubuntu-24.04
    outputs:
      connectors: ${{ steps.list-connectors.outputs.connectors }}
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: List certified connectors
        id: list-connectors
        run: |
          connectors=()
          for dir in airbyte-integrations/connectors/*; do
            metadata_file="${dir}/metadata.yaml"
            build_gradle="${dir}/build.gradle"
            build_gradle_kts="${dir}/build.gradle.kts"

            # If metadata.yaml exists and says we're certified
            if test -f "$metadata_file" && grep -q "supportLevel: certified" "$metadata_file"; then
              # If we have a gradle buildscript using the bulk connector plugin
              if (test -f "$build_gradle" && grep -q "airbyte-bulk-connector" "$build_gradle") || \
                  (test -f "$build_gradle_kts" && grep -q "airbyte-bulk-connector" "$build_gradle_kts"); then
                connector_name=$(basename "$dir")
                connectors+=("$connector_name")
              fi
            fi
          done

          # Nonobvious `printf | jq | jq` thing here:
          # Print each element of the array on a separate line
          # -> jq converts each line to a JSON string (i.e. wrap in double quotes)
          # -> jq reads those lines and wraps them into a JSON array (compact-output is needed for compatibility with github's output format)
          json_array=$(printf '%s\n' "${connectors[@]}" | jq --raw-input . | jq --compact-output --slurp .)
          echo "connectors=$json_array" >> $GITHUB_OUTPUT
          echo "Found ${#connectors[@]} certified bulk CDK connectors"

  upgrade-connector-cdk:
    name: Upgrade CDK for ${{ matrix.connector }}
    needs: list-certified-connectors
    runs-on: ubuntu-24.04
    strategy:
      matrix:
        # TODO undo this
        # connector: ${{ fromJson(needs.list-certified-connectors.outputs.connectors) }}
        connector: [destination-dev-null]
      fail-fast: false
      max-parallel: 5
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Java
        uses: actions/setup-java@c5195efecf7bdfc987ee8bae7a71cb8b11521c00 # v4
        with:
          distribution: "zulu"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@80e941e61874822d2a89974089c4915748e8f4b7 # v4

      - name: Run upgradeCdk for ${{ matrix.connector }}
        id: upgrade-cdk
        run: |
          ./gradlew :airbyte-integrations:connectors:${{ matrix.connector }}:upgradeCdk

      - name: Check for changes
        id: check-changes
        if: steps.upgrade-cdk.outputs.exit_code == '0'
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected for ${{ matrix.connector }}"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected for ${{ matrix.connector }}"
          fi

      - name: Create Pull Request
        id: create-pr
        if: steps.check-changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@c5a7806660adbe173f04e3e038b0ccdcd758773c # v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: upgrade bulk CDK for ${{ matrix.connector }}"
          branch: "auto-upgrade-jvm-bulk-cdk/${{ matrix.connector }}"
          delete-branch: true
          title: "chore: upgrade Bulk CDK for ${{ matrix.connector }}"
          body: |
            Upgrade Bulk CDK version for `${{ matrix.connector }}`

            ðŸ¤– Generated by [automated workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}).
          labels: |
            area/connectors
            auto-cdk-upgrade
          assignees: ""
          reviewers: ""
          # TODO remove this
          draft: true
