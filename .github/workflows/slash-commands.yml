# Copied from `airbytehq/airbyte`.
# Modified to use `cloudposse-github-actions/get-pr` to get PR info,
# which we can eventually backport to `airbytehq/airbyte` as well.
# NOTE: Not all slash commands are supported in this repo.
# See `README.md` in this directory for details.
name: Slash Command Dispatch
on:
  issue_comment:
    types: [created]
jobs:
  slashCommandDispatch:
    runs-on: ubuntu-24.04
    steps:
      # Use pre-made action (handles private repo auth):
      - name: Get PR Info
        if: ${{ github.event.issue.pull_request }}
        id: pr-info
        uses: cloudposse-github-actions/get-pr@v2.0.0
        with:
          id: ${{ github.event.issue.number }}

      - name: Slash Command Dispatch (Workflow)
        id: scd
        uses: peter-evans/slash-command-dispatch@13bc09769d122a64f75aa5037256f6f2d78be8c4 #v4.0.0
        with:
          token: ${{ secrets.GH_PAT_MAINTENANCE_OCTAVIA }}
          config: >
            [
              {
                "command": "format-fix",
                "permission": "write",
                "issue_type": "pull-request",
                "dispatch_type": "workflow",
                "static_args": [
                  "pr=${{ github.event.issue.number }}",
                  "comment-id=${{ github.event.comment.id }}"
                ]
              },
              {
                "command": "poe",
                "permission": "write",
                "issue_type": "pull-request",
                "dispatch_type": "workflow",
                "static_args": [
                  "pr=${{ github.event.issue.number }}",
                  "comment-id=${{ github.event.comment.id }}"
                ]
              },
              {
                "command": "bump-airbyte-submodule",
                "permission": "write",
                "issue_type": "pull-request",
                "dispatch_type": "workflow",
                "static_args": [
                  "pr=${{ github.event.issue.number }}",
                  "comment-id=${{ github.event.comment.id }}"
                ]
              },
              {
                "command": "update-connector-cdk-version",
                "permission": "write",
                "issue_type": "pull-request",
                "dispatch_type": "workflow",
                "static_args": [
                  "pr=${{ github.event.issue.number }}",
                  "comment-id=${{ github.event.comment.id }}",
                  "repo=${{ fromJSON(steps.pr-info.outputs.json).head.repo.full_name || github.repository }}",
                  "gitref=${{ fromJSON(steps.pr-info.outputs.json).head.ref }}"
                ],
                "repository": "airbytehq/airbyte"
              }
            ]

      - name: Edit comment with error message
        if: steps.scd.outputs.error-message
        uses: peter-evans/create-or-update-comment@v1
        with:
          comment-id: ${{ github.event.comment.id }}
          body: |
            > Error: ${{ steps.scd.outputs.error-message }}
