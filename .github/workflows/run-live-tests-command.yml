name: On-Demand Live Connector Validation Tests
# This workflow uses the airbyte-ops-mcp implementation for live tests.
# See: https://github.com/airbytehq/airbyte-ops-mcp

permissions:
  contents: read

concurrency:
  # This is the name of the concurrency group. It is used to prevent concurrent runs of the same workflow.
  #
  # - github.head_ref is only defined on PR runs, it makes sure that the concurrency group is unique for pull requests
  #  ensuring that only one run per pull request is active at a time.
  #
  # - github.run_id is defined on all runs, it makes sure that the concurrency group is unique for workflow dispatches.
  # This allows us to run multiple workflow dispatches in parallel.
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

on:
  workflow_dispatch:
    inputs:
      # Global static-arg inputs for slash commands
      repo:
        description: "The repository name. Optional. Defaults to 'airbytehq/airbyte'."
        required: false
        default: "airbytehq/airbyte"
        type: string
      gitref:
        description: "The git reference (branch or tag). Optional. Defaults to the default branch."
        required: false
        type: string
      comment-id:
        description: "The ID of the comment triggering the workflow. Optional."
        required: false
        type: number
      pr:
        description: "The pull request number, if applicable. Optional."
        required: false
        type: number

      # Workflow-specific inputs
      connector_image:
        description: "Full connector image name with tag (e.g., airbyte/source-github:1.0.0)"
        required: true
        type: string
      command:
        description: "Airbyte command to run"
        required: false
        type: choice
        options:
          - spec
          - check
          - discover
          - read
        default: check
      connection_id:
        description: "Airbyte Cloud connection ID to fetch config/catalog from"
        required: false
        type: string
      state_path:
        description: "Path to state JSON file (optional for read)"
        required: false
        type: string

jobs:
  live_tests:
    name: Live Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Run Live Test
        id: live-test
        env:
          AIRBYTE_CLOUD_CLIENT_ID: ${{ secrets.AIRBYTE_CLOUD_CLIENT_ID }}
          AIRBYTE_CLOUD_CLIENT_SECRET: ${{ secrets.AIRBYTE_CLOUD_CLIENT_SECRET }}
        run: |
          ARGS=(--connector-image "${{ inputs.connector_image }}" --command "${{ inputs.command }}")

          if [ -n "${{ inputs.connection_id }}" ]; then
            ARGS+=(--connection-id "${{ inputs.connection_id }}")
          fi

          if [ -n "${{ inputs.state_path }}" ]; then
            ARGS+=(--state-path "${{ inputs.state_path }}")
          fi

          uvx --from=airbyte-internal-ops airbyte-ops cloud connector live-test "${ARGS[@]}"

      - name: Upload Test Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: live-test-artifacts-${{ github.run_id }}
          path: /tmp/live_test_artifacts/
          retention-days: 7
