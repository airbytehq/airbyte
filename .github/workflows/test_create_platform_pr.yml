name: "DO NOT MERGE: Test create PR in airbyte-platform following CDK release"
on:
  push:
    branches:
      - issue-22485_**

jobs:
  bump-version:
    runs-on: ubuntu-latest
    outputs:
      new_cdk_version: ${{ steps.bumpversion.outputs.NEW_VERSION }}
    steps:
      - name: Checkout Airbyte
        uses: actions/checkout@v3
        with:
          repository: airbytehq/airbyte
          ref: master
          token: ${{ secrets.GH_PAT_MAINTENANCE_OSS }}
      - name: "Publish Airbyte CDK: bump version"
        id: bumpversion
        run: |
          pip install bumpversion
          cd airbyte-cdk/python
          bumpversion major
          new_version="$(grep -i 'current_version = ' .bumpversion.cfg | sed -e 's/.* = //')"
          awk -v NEW_VERSION="$new_version" -v CHANGELOG_MESSAGE="${{ github.event.inputs.changelog-message }}" 'NR==3{print "## " NEW_VERSION "\n" CHANGELOG_MESSAGE "\n"}1' CHANGELOG.md > tmp && mv tmp CHANGELOG.md
          echo NEW_VERSION=$new_version >> $GITHUB_OUTPUT
  create-pr:
    needs: bump-version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Airbyte Platform
        uses: actions/checkout@v3
        with:
          repository: airbytehq/airbyte-platform-internal
          token: ${{ secrets.GH_PAT_MAINTENANCE_OCTAVIA }}
      - name: Update CDK version
        run: |
          echo ${{needs.bump-version.outputs.new_cdk_version}} > oss/airbyte-connector-builder-server/CDK_VERSION
          cat oss/airbyte-connector-builder-server/CDK_VERSION
      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@v4
        with:
          token: ${{ secrets.GH_PAT_MAINTENANCE_OCTAVIA }}
          commit-message: Updating CDK version following release
          title: Updating CDK version following release
          body: This is an automatically generated PR triggered by a CDK release
          branch: automatic-cdk-release-${{needs.bump-version.outputs.new_cdk_version}}
          base: master
          delete-branch: true
      - name: Print create-pull-request output
        run: |
          echo ${{steps.create-pull-request.outputs.pull-request-url}}
