name: Docker Connector Base Image Tests

on:
  pull_request:
    paths:
      - "docker-images/Dockerfile.java-connector"
      - "docker-images/Dockerfile.java-connector-base"
      - "docker-images/Dockerfile.python-connector"
      - "docker-images/Dockerfile.python-connector-base"
      - "docker-images/Dockerfile.manifest-only-connector"
  workflow_dispatch:

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      java-images: ${{ steps.changes.outputs.java-images }}
      python-images: ${{ steps.changes.outputs.python-images }}
      manifest-only: ${{ steps.changes.outputs.manifest-only }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3.0.2
        with:
          filters: |
            java-images:
              - 'docker-images/Dockerfile.java-connector'
              - 'docker-images/Dockerfile.java-connector-base'
            python-images:
              - 'docker-images/Dockerfile.python-connector'
              - 'docker-images/Dockerfile.python-connector-base'
            manifest-only:
              - 'docker-images/Dockerfile.manifest-only-connector'

  build-java-base-image:
    runs-on: ubuntu-latest
    needs: detect-changes
    environment:
      name: ghcr.io/airbytehq/java-connector-base
      url: https://ghcr.io/airbytehq/java-connector-base
    if: needs.detect-changes.outputs.java-images == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Java Base Image
        id: docker-build-java-base
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker-images/Dockerfile.java-connector-base
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/airbytehq/java-connector-base:draft-pr-${{ github.event.pull_request.number }}
            ghcr.io/airbytehq/java-connector-base:draft-pr-${{ github.event.pull_request.number }}-build${{ github.run_number }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Run Java Base Image Vulnerability Scan
        uses: anchore/scan-action@v6
        with:
          image: "ghcr.io/airbytehq/java-connector-base:draft-pr-${{ github.event.pull_request.number }}"
          output-format: "table"
          severity-cutoff: high
          fail-build: false

    outputs:
      java-base-image: ${{ steps.docker-build-java-base.outputs.imageid }}

  build-python-base-image:
    runs-on: ubuntu-latest
    needs: detect-changes
    environment:
      name: ghcr.io/airbytehq/python-connector-base
      url: https://ghcr.io/airbytehq/python-connector-base
    if: needs.detect-changes.outputs.python-images == 'true'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Python Base Image
        id: docker-build-python-base
        uses: docker/build-push-action@v5
        with:
          context: .
          file: docker-images/Dockerfile.python-connector-base
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/airbytehq/python-connector-base:draft-pr-${{ github.event.pull_request.number }}
            ghcr.io/airbytehq/python-connector-base:draft-pr-${{ github.event.pull_request.number }}-build${{ github.run_number }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BASE_IMAGE=ghcr.io/airbytehq/python-connector-base:draft-pr-${{ github.event.pull_request.number }}

      - name: Run Python Base Image Vulnerability Scan
        uses: anchore/scan-action@v6
        with:
          image: "ghcr.io/airbytehq/python-connector-base:draft-pr-${{ github.event.pull_request.number }}"
          output-format: "table"
          severity-cutoff: high
          fail-build: false

    outputs:
      python-base-image: ${{ steps.docker-build-python-base.outputs.imageid }}

  test-java-connector-image-matrix:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-java-base-image]
    if: needs.detect-changes.outputs.java-images == 'true'
    strategy:
      fail-fast: false
      matrix:
        connector:
          - source-postgres
          - destination-postgres
          - destination-snowflake
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "21"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Build Connector Tarball
        run: |
          ./gradlew :airbyte-integrations:connectors:${{ matrix.connector }}:distTar

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ${{ matrix.connector }} Image
        uses: docker/build-push-action@v5
        with:
          context: airbyte-integrations/connectors/${{ matrix.connector }}
          file: docker-images/Dockerfile.java-connector
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}-build${{ github.run_number }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BASE_IMAGE=ghcr.io/airbytehq/java-connector-base:draft-pr-${{ github.event.pull_request.number }}
            CONNECTOR_NAME=${{ matrix.connector }}

      - name: Run `spec` Image Test
        run: |
          docker run --rm \
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }} \
            spec

      - name: Run ${{ matrix.connector }} Image Vulnerability Scan
        uses: anchore/scan-action@v6
        with:
          image: "ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}"
          output-format: "table"
          severity-cutoff: high
          fail-build: false

  test-python-connector-image-matrix:
    runs-on: ubuntu-latest
    needs: [detect-changes, build-python-base-image]
    if: needs.detect-changes.outputs.python-images == 'true'
    strategy:
      fail-fast: false
      matrix:
        connector:
          - source-google-drive
          - source-s3
          - source-salesforce
          - source-shopify
          - destination-motherduck
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ${{ matrix.connector }} Image
        uses: docker/build-push-action@v5
        with:
          context: airbyte-integrations/connectors/${{ matrix.connector }}
          file: docker-images/Dockerfile.python-connector
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}-build${{ github.run_number }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BASE_IMAGE=ghcr.io/airbytehq/python-connector-base:draft-pr-${{ github.event.pull_request.number }}

      - name: Run `spec` Image Test
        run: |
          docker run --rm \
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }} \
            spec

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install CDK CLI
        run: |
          uv tool install 'git+https://github.com/airbytehq/airbyte-python-cdk.git@aj/tests/add-docker-based-standard-tests[dev]'

      - name: Fetch connector secrets
        env:
          GCP_GSM_CREDENTIALS: ${{ secrets.GCP_GSM_CREDENTIALS }}
        run: |
          airbyte-cdk secrets fetch ${{ matrix.connector }}

      - name: Run connector tests
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
          DOCKER_BUILDKIT: 1
          BUILDX_NO_DEFAULT_ATTESTATIONS: 1
        run: |
          cd airbyte-integrations/connectors/${{ matrix.connector }}
          airbyte-cdk connector test ${{ matrix.connector }}

      - name: Run ${{ matrix.connector }} Image Vulnerability Scan
        uses: anchore/scan-action@v6
        with:
          image: "ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}"
          output-format: "table"
          severity-cutoff: high
          fail-build: false

  test-manifest-only-connector-image-matrix:
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.manifest-only == 'true'
    strategy:
      fail-fast: false
      matrix:
        connector:
          - source-pokeapi
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build ${{ matrix.connector }} Image
        uses: docker/build-push-action@v5
        with:
          context: airbyte-integrations/connectors/${{ matrix.connector }}
          file: docker-images/Dockerfile.manifest-only-connector
          platforms: linux/amd64
          tags: |
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}-build${{ github.run_number }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            CONNECTOR_NAME=${{ matrix.connector }}

      - name: Run `spec` Image Test
        run: |
          docker run --rm \
            ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }} \
            spec

      - name: Setup uv
        uses: astral-sh/setup-uv@v4

      - name: Install CDK CLI
        run: |
          uv tool install 'git+https://github.com/airbytehq/airbyte-python-cdk.git@aj/tests/add-docker-based-standard-tests[dev]'

      - name: Fetch connector secrets
        env:
          GCP_GSM_CREDENTIALS: ${{ secrets.GCP_GSM_CREDENTIALS }}
        run: |
          airbyte-cdk secrets fetch ${{ matrix.connector }}

      - name: Run connector tests
        env:
          DOCKER_DEFAULT_PLATFORM: linux/amd64
          DOCKER_BUILDKIT: 1
          BUILDX_NO_DEFAULT_ATTESTATIONS: 1
        run: |
          cd airbyte-integrations/connectors/${{ matrix.connector }}
          airbyte-cdk connector test ${{ matrix.connector }}

      - name: Run ${{ matrix.connector }} Image Vulnerability Scan
        uses: anchore/scan-action@v6
        with:
          image: "ghcr.io/airbytehq/${{ matrix.connector }}:draft-pr-${{ github.event.pull_request.number }}"
          output-format: "table"
          severity-cutoff: high
          fail-build: false
