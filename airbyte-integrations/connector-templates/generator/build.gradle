plugins {
    id "base"
    id "com.github.node-gradle.node" version "2.2.4"
}

node {
    download = true
    version = "14.11.0"
}

assemble.dependsOn(npmInstall)

def addScaffoldTask(name, scaffoldParams=[]) {
    def taskName = "generate_${name}"
    def outputDir = "airbyte-integrations/connectors/source-scaffold-${name}"

    def task = tasks.create(taskName) {
        inputs.files rootProject.fileTree("airbyte-integrations/connector-templates/${name}")

        exec {
            workingDir rootDir
            commandLine 'rm', '-rf', outputDir
        }
        exec {
            workingDir rootDir
            def cmd = ['./tools/integrations/manage.sh', 'scaffold', name, "scaffold-${name}"]
            cmd.addAll(scaffoldParams)
            commandLine cmd
        }

        outputs.dir rootProject.file(outputDir)

    }

    // When we only build core, connector projects don't exist, let's make sure we protect ourselves from it.
    def scaffoldTestProjectPath = ":${outputDir.replace('/', ':')}"
    if (findProject(scaffoldTestProjectPath) != null) {
        project(scaffoldTestProjectPath) {
            build.dependsOn task
        }
    }
}

addScaffoldTask('source-python')
addScaffoldTask('source-python-singer', ['tap-exchangeratesapi'])
