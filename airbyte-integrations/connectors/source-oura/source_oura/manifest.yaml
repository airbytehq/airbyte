version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path: ["data"]
  base_requester:
    url_base: "https://api.ouraring.com/v2/usercollection"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_key'] }}"
  date_requester:
    $ref: "#/definitions/base_requester"
    request_parameters:
      start_date: "{{ config['start_date'].split('T')[0] }}"
      end_date: "{{ config['end_date'].split('T')[0] }}"
  datetime_requester:
    $ref: "#/definitions/base_requester"
    request_parameters:
      start_datetime: "{{ config['start_datetime'] }}"
      end_datetime: "{{ config['end_datetime'] }}"
  paginator:
    type: DefaultPaginator
    pagination_strategy:
      type: CursorPagination
      cursor_value: "{{ response['next_token'] }}"
      page_size: 100 # Not used, but check fails without it
    page_token_option:
      type: RequestOption
      field_name: "next_token"
      inject_into: "request_parameter"
    page_size_option: # Not used, but check fails without it
      field_name: ""
      inject_into: "request_parameter"
  base_retriever:
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      $ref: "#/definitions/paginator"
  date_retriever:
    $ref: "#/definitions/base_retriever"
    requester:
      $ref: "#/definitions/date_requester"
  datetime_retriever:
    $ref: "#/definitions/base_retriever"
    requester:
      $ref: "#/definitions/datetime_requester"
  date_stream:
    retriever:
      $ref: "#/definitions/date_retriever"
  datetime_stream:
    retriever:
      $ref: "#/definitions/datetime_retriever"
  daily_activity_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "daily_activity"
      primary_key: "timestamp"
      path: "/daily_activity"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          class_5_min:
            type:
              - string
              - "null"
          score:
            type:
              - number
              - "null"
          active_calories:
            type:
              - number
              - "null"
          average_met_minutes:
            type:
              - number
              - "null"
          contributors:
            type: object
            properties:
              meet_daily_targets:
                type:
                  - number
                  - "null"
              move_every_hour:
                type:
                  - number
                  - "null"
              recovery_time:
                type:
                  - number
                  - "null"
              stay_active:
                type:
                  - number
                  - "null"
              training_frequency:
                type:
                  - number
                  - "null"
              training_volume:
                type:
                  - number
                  - "null"
          equivalent_walking_distance:
            type:
              - number
              - "null"
          high_activity_met_minutes:
            type:
              - number
              - "null"
          high_activity_time:
            type:
              - number
              - "null"
          inactivity_alerts:
            type:
              - number
              - "null"
          low_activity_met_minutes:
            type:
              - number
              - "null"
          low_activity_time:
            type:
              - number
              - "null"
          medium_activity_met_minutes:
            type:
              - number
              - "null"
          medium_activity_time:
            type:
              - number
              - "null"
          met:
            type: object
            properties:
              interval:
                type:
                  - number
                  - "null"
              items:
                type: array
                items:
                  type:
                    - number
                    - "null"
              timestamp:
                type:
                  - string
                  - "null"
                format: date-time
          meters_to_target:
            type:
              - number
              - "null"
          non_wear_time:
            type:
              - number
              - "null"
          resting_time:
            type:
              - number
              - "null"
          sedentary_met_minutes:
            type:
              - number
              - "null"
          sedentary_time:
            type:
              - number
              - "null"
          steps:
            type:
              - number
              - "null"
          target_calories:
            type:
              - number
              - "null"
          target_meters:
            type:
              - number
              - "null"
          total_calories:
            type:
              - number
              - "null"
          day:
            type:
              - string
              - "null"
            format: date
          timestamp:
            type:
              - string
              - "null"
            format: date-time
  daily_readiness_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "daily_readiness"
      primary_key: "timestamp"
      path: "/daily_readiness"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          contributors:
            type: object
            properties:
              activity_balance:
                type:
                  - number
                  - "null"
              body_temperature:
                type:
                  - number
                  - "null"
              hrv_balance:
                type:
                  - number
                  - "null"
              previous_day_activity: {}
              previous_night:
                type:
                  - number
                  - "null"
              recovery_index:
                type:
                  - number
                  - "null"
              resting_heart_rate:
                type:
                  - number
                  - "null"
              sleep_balance:
                type:
                  - number
                  - "null"
          day:
            type:
              - string
              - "null"
            format: date
          score:
            type:
              - number
              - "null"
          temperature_deviation:
            type:
              - number
              - "null"
          temperature_trend_deviation:
            type:
              - number
              - "null"
          timestamp:
            type:
              - string
              - "null"
            format: date-time
  daily_sleep_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "daily_sleep"
      primary_key: "timestamp"
      path: "/daily_sleep"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          contributors:
            type: object
            properties:
              deep_sleep:
                type:
                  - number
                  - "null"
              efficiency:
                type:
                  - number
                  - "null"
              latency:
                type:
                  - number
                  - "null"
              rem_sleep:
                type:
                  - number
                  - "null"
              restfulness:
                type:
                  - number
                  - "null"
              timing:
                type:
                  - number
                  - "null"
              total_sleep:
                type:
                  - number
                  - "null"
          day:
            type:
              - string
              - "null"
            format: date
          score:
            type:
              - number
              - "null"
          timestamp:
            type:
              - string
              - "null"
            format: date-time
  heart_rate_stream:
    $ref: "#/definitions/datetime_stream"
    $parameters:
      name: "heart_rate"
      primary_key: "timestamp"
      path: "/heartrate"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          bpm:
            type:
              - number
              - "null"
          source:
            type:
              - string
              - "null"
          timestamp:
            type:
              - string
              - "null"
            format: date-time
  sessions_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "sessions"
      primary_key: "start_datetime"
      path: "/session"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          day:
            type:
              - string
              - "null"
            format: date
          start_datetime:
            type:
              - string
              - "null"
            format: date-time
          end_datetime:
            type:
              - string
              - "null"
            format: date-time
          type:
            type:
              - string
              - "null"
          heart_rate: {}
          heart_rate_variability: {}
          mood: {}
          motion_count:
            type: object
            properties:
              interval:
                type:
                  - number
                  - "null"
              items:
                type: array
                items:
                  type:
                    - number
                    - "null"
              timestamp:
                type:
                  - string
                  - "null"
                format: date-time
  sleep_periods_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "sleep_periods"
      primary_key: "bedtime_start"
      path: "/sleep"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          average_breath:
            type:
              - number
              - "null"
          average_heart_rate:
            type:
              - number
              - "null"
          average_hrv:
            type:
              - number
              - "null"
          awake_time:
            type:
              - number
              - "null"
          bedtime_end:
            type:
              - string
              - "null"
            format: date-time
          bedtime_start:
            type:
              - string
              - "null"
            format: date-time
          day:
            type:
              - string
              - "null"
            format: date
          deep_sleep_duration:
            type:
              - number
              - "null"
          efficiency:
            type:
              - number
              - "null"
          heart_rate:
            type: object
            properties:
              interval:
                type:
                  - number
                  - "null"
              items:
                type: array
                items:
                  type:
                    - number
                    - "null"
              timestamp:
                type:
                  - string
                  - "null"
                format: date-time
          hrv:
            type: object
            properties:
              interval:
                type:
                  - number
                  - "null"
              items:
                type: array
                items:
                  type:
                    - number
                    - "null"
              timestamp:
                type:
                  - string
                  - "null"
                format: date-time
          latency:
            type:
              - number
              - "null"
          light_sleep_duration:
            type:
              - number
              - "null"
          low_battery_alert:
            type: boolean
          lowest_heart_rate:
            type:
              - number
              - "null"
          movement_30_sec:
            type:
              - string
              - "null"
          period:
            type:
              - number
              - "null"
          readiness_score_delta:
            type:
              - number
              - "null"
          rem_sleep_duration:
            type:
              - number
              - "null"
          restless_periods:
            type:
              - number
              - "null"
          sleep_phase_5_min:
            type:
              - string
              - "null"
          sleep_score_delta:
            type:
              - number
              - "null"
          time_in_bed:
            type:
              - number
              - "null"
          total_sleep_duration: {}
          type:
            type:
              - string
              - "null"
  tags_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "tags"
      primary_key: "timestamp"
      path: "/tag"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          day:
            type:
              - string
              - "null"
            format: date
          text:
            type:
              - string
              - "null"
          timestamp:
            type:
              - string
              - "null"
            format: date-time
          tags:
            type: array
            items:
              type:
                - string
                - "null"
  workouts_stream:
    $ref: "#/definitions/date_stream"
    $parameters:
      name: "workouts"
      primary_key: "start_datetime"
      path: "/workout"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          activity:
            type:
              - string
              - "null"
          calories:
            type:
              - number
              - "null"
          day:
            type:
              - string
              - "null"
            format: date
          distance:
            type:
              - number
              - "null"
          end_datetime:
            type:
              - string
              - "null"
            format: date-time
          intensity:
            type:
              - string
              - "null"
          label: {}
          source:
            type:
              - string
              - "null"
          start_datetime:
            type:
              - string
              - "null"
            format: date-time
streams:
  - "#/definitions/daily_activity_stream"
  - "#/definitions/daily_readiness_stream"
  - "#/definitions/daily_sleep_stream"
  - "#/definitions/heart_rate_stream"
  - "#/definitions/sessions_stream"
  - "#/definitions/sleep_periods_stream"
  - "#/definitions/tags_stream"
  - "#/definitions/workouts_stream"

check:
  stream_names:
    - "heart_rate"
