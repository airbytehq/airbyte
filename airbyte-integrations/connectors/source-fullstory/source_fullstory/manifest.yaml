version: "0.29.0"

definitions:
  requester:
    url_base: "https://api.fullstory.com"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_key'] }}"
  retriever:
    type: SimpleRetriever
    record_selector:
      type: RecordSelector
      extractor:
        type: DpathExtractor
        field_path: ["{{ parameters.name }}"]
      paginator:
        type: "DefaultPaginator"
        pagination_strategy:
          type: "TokenBased"
          token_field: "nextPaginationToken"
          token_option:
            type: "RequestOption"
            inject_into: "request_parameter"
            field_name: "pagination_token"

    requester:
      $ref: "#/definitions/requester"

  base_stream:
    retriever:
      $ref: "#/definitions/retriever"

  operations_stream:
    type: DeclarativeStream
    $parameters:
      name: "operations"
      path: "/operations/v1"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Operations Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - "null"
              - string
          type:
            type:
              - "null"
              - string
          details:
            type:
              - "null"
              - object
          results:
            type:
              - "null"
              - object
          state:
            type:
              - "null"
              - string
          errorDetails:
            type:
              - "null"
              - string
          createdAt:
            type:
              - "null"
              - string
            format: date-time
          finishedAt:
            type:
              - "null"
              - string
            format: date-time
          estimatePctComplete:
            type:
              - "null"
              - integer
          step:
            type:
              - "null"
              - string
  sessions_stream:
    type: DeclarativeStream
    $parameters:
      name: "sessions"
      path: "/sessions/v2?{{ 'uid=' ~ config['uid'] }}"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Sessions Schema
        additionalProperties: true
        type: object
        properties:
          userId:
            type:
              - "null"
              - integer
              - string
          sessionId:
            type:
              - "null"
              - integer
              - string
          createdTime:
            type:
              - "null"
              - integer
              - string
          fsUrl:
            type:
              - "null"
              - string
  segments_stream:
    type: DeclarativeStream
    $parameters:
      name: "segments"
      path: "/segments/v1"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Segments Schema
        additionalProperties: true
        type: object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          creator:
            type:
              - "null"
              - string
          created:
            type:
              - "null"
              - string
          url:
            type:
              - "null"
              - string
  blockrules_stream:
    type: DeclarativeStream
    $parameters:
      name: "blockrules"
      path: "/settings/recording/v1/blocking"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: BlockRules Schema
        additionalProperties: true
        type: object
        properties:
          blockedIps:
            type:
              - "null"
              - array
            items:
              type: string
          blockedUas:
            type:
              - "null"
              - array
            items:
              type: string
          blockedAppIds:
            type:
              - "null"
              - array
            items:
              type: string
  domainsettings_stream:
    type: DeclarativeStream
    $parameters:
      name: "domainsettings"
      path: "/settings/recording/v1/domain"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: DomainSettings Schema
        additionalProperties: true
        type: object
        properties:
          onlyRecordKnownDomains:
            type:
              - "null"
              - boolean
          domains:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - object
              properties:
                disabled:
                  type:
                    - "null"
                    - boolean
                domain:
                  type:
                    - "null"
                    - string
  geosettings_stream:
    type: DeclarativeStream
    $parameters:
      name: "geosettings"
      path: "/settings/recording/v1/geo"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: GeoSettings Schema
        additionalProperties: true
        type: object
        properties:
          record_geo_mode:
            type:
              - "null"
              - string
          record_geo_zones:
            type:
              - "null"
              - array
            items:
              type: string
  recordingfeatures_stream:
    type: DeclarativeStream
    $parameters:
      name: "recordingfeatures"
      path: "/settings/recording/v1/features"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: RecordingFeatures Schema
        additionalProperties: true
        type: object
        properties:
          enabled:
            type:
              - "null"
              - boolean
          consoleWatcher:
            type:
              - "null"
              - boolean
          ajaxWatcher:
            type:
              - "null"
              - boolean
          resourceUploading:
            type:
              - "null"
              - boolean
          recordingShutoff:
            type:
              - "null"
              - boolean
  targetrules_stream:
    type: DeclarativeStream
    $parameters:
      name: "sessionTargetingRules"
      path: "/settings/recording/v1/targeting"
    $ref: "#/definitions/base_stream"

    schema_loader: {}
  webhooks_stream:
    type: DeclarativeStream
    $parameters:
      name: "webhooks"
      path: "/webhooks/v1/endpoints"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Webhooks Schema
        additionalProperties: true
        type: object
        properties:
          endpoints:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - object
              properties:
                id:
                  type:
                    - "null"
                    - string
                created:
                  type:
                    - "null"
                    - string
                modified:
                  type:
                    - "null"
                    - string
                enabled:
                  type:
                    - "null"
                    - boolean
                url:
                  type:
                    - "null"
                    - string
                event_types:
                  type:
                    - "null"
                    - array
                  items:
                    type:
                      - "null"
                      - object
                    properties:
                      event_name:
                        type:
                          - "null"
                          - string
                      subcategory:
                        type:
                          - "null"
                          - string
  event-types_stream:
    type: DeclarativeStream
    $parameters:
      name: "eventDefs"
      path: "/webhooks/v1/event-types"
    $ref: "#/definitions/base_stream"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: EventTypes Schema
        type: object
        additionalProperties: true
        properties:
          eventName:
            type:
              - "null"
              - string
          displayName:
            type:
              - "null"
              - string
          hasSubcategories:
            type:
              - "null"
              - boolean
streams:
  - "#/definitions/sessions_stream"
  - "#/definitions/segments_stream"
  - "#/definitions/operations_stream"
  - "#/definitions/blockrules_stream"
  - "#/definitions/domainsettings_stream"
  - "#/definitions/geosettings_stream"
  - "#/definitions/recordingfeatures_stream"
  - "#/definitions/targetrules_stream"
  - "#/definitions/webhooks_stream"
  - "#/definitions/event-types_stream"

check:
  type: CheckStream
  stream_names:
    - "sessions"
