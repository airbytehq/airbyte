version: "0.1.0"

definitions:
  selector:
    extractor:
      field_pointer: ["articles"]
  base_requester:
    url_base: "https://gnews.io/api/v4"
    http_method: "GET"
  base_retriever:
    record_selector:
      $ref: "*ref(definitions.selector)"
    paginator:
      type: NoPagination
  common_parameters:
    token: "{{ config['api_key'] }}"
    lang: "{{ config['language'] }}"
    country: "{{ config['country'] }}"
    nullable: "{{ ','.join(config['nullable']) }}"
    from: "{{ config['from'] }}"
    to: "{{ config['to'] }}"
  search_stream:
    $options:
      name: "search"
      primary_key: "url"
      path: "/search"
    retriever:
      $ref: "*ref(definitions.base_retriever)"
      requester:
        $ref: "*ref(definitions.base_requester)"
        request_options_provider:
          request_parameters:
            $ref: "*ref(definitions.common_parameters)"
            q: "{{ config['query'] }}"
            in: "{{ ','.join(config['in']) }}"
            sortby: "{{ config['sortby'] }}"
  top_headlines_stream:
    $options:
      name: "top_headlines"
      primary_key: "url"
      path: "/top-headlines"
    retriever:
      $ref: "*ref(definitions.base_retriever)"
      requester:
        $ref: "*ref(definitions.base_requester)"
        request_options_provider:
          request_parameters:
            $ref: "*ref(definitions.common_parameters)"
            topic: "{{ config['top_headlines_topic'] }}"
            q: "{{ config['top_headlines_query'] }}"

streams:
  - "*ref(definitions.search_stream)"
  - "*ref(definitions.top_headlines_stream)"

check:
  stream_names:
    - "search"
    - "top_headlines"
