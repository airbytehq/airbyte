version: "0.29.0"

definitions:
  selector:
    extractor:
      field_path: ["data", "items"]
  requester:
    url_base: "https://api.partnerstack.com/api/v2/"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['public_key'] }}"
      password: "{{ config['private_key'] }}"
    request_parameters:
      min_created: "{{ timestamp(config['start_date']) * 1000 }}"
  partition_router:
    request_cursor_field: "min_updated"
    cursor_field: "updated_at"
    class_name: source_partnerstack.components.PartnerstackSlicer
  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      pagination_strategy:
        type: "CursorPagination"
        cursor_value: "{{ last_records[-1]['key'] }}"
        stop_condition: "{{ response.data.has_more is false }}"
        page_size: 250
      page_size_option:
        field_name: "limit"
        inject_into: "request_parameter"
      page_token_option:
        type: RequestOption
        field_name: "starting_after"
        inject_into: "request_parameter"
    requester:
      $ref: "#/definitions/requester"
    partition_router:
      $ref: "#/definitions/partition_router"

  # base stream
  base_stream:
    retriever:
      $ref: "#/definitions/retriever"

  # stream definitions
  customers_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "customers"
      primary_key: "key"
      path: "/customers"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          created_at:
            type:
              - "null"
              - integer
          customer_key:
            type:
              - "null"
              - string
          email:
            type:
              - "null"
              - string
          field_data:
            type:
              - "null"
              - object
          fields:
            type:
              - "null"
              - array
          key:
            type:
              - "null"
              - string
          meta:
            type:
              - "null"
              - object
          name:
            type:
              - "null"
              - string
          partner_key:
            type:
              - "null"
              - string
          partnership_key:
            type:
              - "null"
              - string
          provider_key:
            type:
              - "null"
              - string
          source_key:
            type:
              - "null"
              - string
          source_type:
            type:
              - "null"
              - string
          test:
            type:
              - "null"
              - boolean
          updated_at:
            type:
              - "null"
              - integer
  deals_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "deals"
      primary_key: "key"
      path: "/deals"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          created_at:
            type:
              - "null"
              - integer
          key:
            type:
              - "null"
              - string
          updated_at:
            type:
              - "null"
              - integer
          account_name:
            type:
              - "null"
              - object
          amount:
            type:
              - "null"
              - integer
          close_date:
            type:
              - "null"
              - string
          contact_first_name:
            type:
              - "null"
              - string
          contact_last_name:
            type:
              - "null"
              - string
          external_key:
            type:
              - "null"
              - string
          field_data:
            type:
              - "null"
              - object
          fields:
            type:
              - "null"
              - array
          group_key:
            type:
              - "null"
              - string
          lost_reason:
            type:
              - "null"
              - string
          meta:
            type:
              - "null"
              - object
          mold_key:
            type:
              - "null"
              - string
          partner_key:
            type:
              - "null"
              - string
          source:
            type:
              - "null"
              - string
          stage:
            type:
              - "null"
              - string
          team:
            type:
              - "null"
              - object
          team_member:
            type:
              - "null"
              - object
  groups_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "groups"
      primary_key: "key"
      path: "/groups"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          archived:
            type:
              - "null"
              - boolean
          created_at:
            type:
              - "null"
              - integer
          default:
            type:
              - "null"
              - boolean
          features:
            type:
              - "null"
              - object
          key:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          slug:
            type:
              - "null"
              - string
          updated_at:
            type:
              - "null"
              - integer
  leads_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "leads"
      primary_key: "key"
      path: "/leads"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          amount:
            type:
              - "null"
              - integer
          approved:
            type:
              - "null"
              - boolean
          created_at:
            type:
              - "null"
              - integer
          external_key:
            type:
              - "null"
              - string
          field_data:
            type:
              - "null"
              - object
          fields:
            type:
              - "null"
              - array
          group_key:
            type:
              - "null"
              - string
          key:
            type:
              - "null"
              - string
          meta:
            type:
              - "null"
              - object
          mold_key:
            type:
              - "null"
              - string
          partner_key:
            type:
              - "null"
              - string
          status:
            type:
              - "null"
              - string
          updated_at:
            type:
              - "null"
              - integer
  partnerships_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "partnerships"
      primary_key: "key"
      path: "/partnerships"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          created_at:
            type:
              - "null"
              - integer
          email:
            type:
              - "null"
              - string
          first_name:
            type:
              - "null"
              - string
          group:
            type:
              - "null"
              - object
          joined_at:
            type:
              - "null"
              - integer
          key:
            type:
              - "null"
              - string
          last_name:
            type:
              - "null"
              - string
          manager:
            type:
              - "null"
              - object
          m_data:
            type:
              - "null"
              - object
          partner_key:
            type:
              - "null"
              - string
          stats:
            type:
              - "null"
              - object
          tags:
            type:
              - "null"
              - array
          team:
            type:
              - "null"
              - object
          updated_at:
            type:
              - "null"
              - integer
  rewards_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "rewards"
      primary_key: "key"
      path: "/rewards"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          action:
            type:
              - "null"
              - object
          amount:
            type:
              - "null"
              - integer
          created_at:
            type:
              - "null"
              - integer
          customer:
            type:
              - "null"
              - object
          description:
            type:
              - "null"
              - string
          invoice:
            type:
              - "null"
              - object
          key:
            type:
              - "null"
              - string
          offer:
            type:
              - "null"
              - object
          partnership:
            type:
              - "null"
              - object
          reward_status:
            type:
              - "null"
              - string
          transaction:
            type:
              - "null"
              - object
          trigger:
            type:
              - "null"
              - object
          updated_at:
            type:
              - "null"
              - integer
  transactions_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "transactions"
      primary_key: "key"
      path: "/transactions"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        properties:
          amount:
            type:
              - "null"
              - integer
          amount_usd:
            type:
              - "null"
              - integer
          approved:
            type:
              - "null"
              - boolean
          category_key:
            type:
              - "null"
              - string
          created_at:
            type:
              - "null"
              - integer
          currency:
            type:
              - "null"
              - string
          customer:
            type:
              - "null"
              - object
          customer_key:
            type:
              - "null"
              - string
          extension:
            type:
              - "null"
              - object
          key:
            type:
              - "null"
              - string
          product_key:
            type:
              - "null"
              - object
          updated_at:
            type:
              - "null"
              - integer
streams:
  - "#/definitions/customers_stream"
  - "#/definitions/deals_stream"
  - "#/definitions/groups_stream"
  - "#/definitions/leads_stream"
  - "#/definitions/partnerships_stream"
  - "#/definitions/rewards_stream"
  - "#/definitions/transactions_stream"

check:
  stream_names:
    - "groups"
