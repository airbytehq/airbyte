version: "0.1.0"

definitions:
  schema_loader:
    type: JsonFileSchemaLoader
    file_path: "./source_greenhouse/schemas/{{ parameters['name'] }}.json"
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []
  requester:
    type: HttpRequester
    url_base: "https://harvest.greenhouse.io/v1/"
    http_method: "GET"
    error_handler:
      type: CompositeErrorHandler
      # ignore 403 error but retry default retriable http errors (429, 500 - 600)
      error_handlers:
        - type: DefaultErrorHandler
          response_filters:
            - http_codes: [403]
              action: IGNORE
        - type: DefaultErrorHandler
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['api_key'] }}"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      pagination_strategy:
        type: "CursorPagination"
        cursor_value: "{{ headers['link']['next']['url'] }}"
        stop_condition: "{{ 'next' not in headers['link'] }}"
        page_size: 100
      page_size_option:
        field_name: "per_page"
        inject_into: "request_parameter"
      page_token_option:
        inject_into: "path"
  base_stream:
    type: DeclarativeStream
    name: "applications"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
  base_incremental_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester: "#/definitions/requester"
      stream_slicer:
        request_cursor_field: "updated_after"
        cursor_field: "updated_at"
        class_name: source_greenhouse.components.GreenHouseSlicer
  applications_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "applications"
    name: "applications"
    retriever:
      $ref: "#/definitions/retriever"
      requester: "#/definitions/requester"
      stream_slicer:
        request_cursor_field: "created_after"
        cursor_field: "applied_at"
        class_name: source_greenhouse.components.GreenHouseSlicer
  candidates_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "candidates"
    name: "candidates"
  close_reasons_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "close_reasons"
    name: "close_reasons"
    primary_key: "id"
  degrees_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "degrees"
    name: "degrees"
  departments_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "departments"
    name: "departments"
  jobs_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "jobs"
    name: "jobs"
  jobs_openings_stream:
    name: "jobs_openings"
    primary_key: "id"
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "jobs/{{ stream_slice.parent_id }}/openings"
      stream_slicer:
        type: SubstreamSlicer
        parent_stream_configs:
          - stream: "#/definitions/jobs_stream"
            parent_key: "id"
            stream_slice_field: "parent_id"
  applications_demographics_answers_stream:
    $ref: "#/definitions/base_stream"
    name: "applications_demographics_answers"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "applications/{{ stream_slice.parent_id }}/demographics/answers"
      stream_slicer:
        class_name: source_greenhouse.components.GreenHouseSubstreamSlicer
        parent_stream: "#/definitions/applications_stream"
        request_cursor_field: "updated_after"
        stream_slice_field: "parent_id"
        cursor_field: "updated_at"
        parent_key: "id"
  applications_interviews_stream:
    $ref: "#/definitions/base_stream"
    name: "applications_interviews"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "applications/{{ stream_slice.parent_id }}/scheduled_interviews"
      stream_slicer:
        class_name: source_greenhouse.components.GreenHouseSubstreamSlicer
        parent_stream: "#/definitions/applications_stream"
        request_cursor_field: "updated_after"
        stream_slice_field: "parent_id"
        cursor_field: "updated_at"
        parent_key: "id"
  custom_fields_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "custom_fields"
    name: "custom_fields"
  questions_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "demographics/questions"
    name: "demographics_questions"
  demographics_answers_answer_options_stream:
    $parameters:
      schema_loader:
        $ref: "#/definitions/schema_loader"
      retriever:
        $ref: "#/definitions/retriever"
        requester:
          $ref: "#/definitions/requester"
          path: "demographics/questions/{{ stream_slice.parent_id }}/answer_options"
        stream_slicer:
          type: SubstreamSlicer
          parent_stream_configs:
            - stream: "#/definitions/questions_stream"
              parent_key: "id"
              stream_slice_field: "parent_id"
    name: "demographics_answers_answer_options"
    primary_key: "id"
  demographics_question_sets_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "demographics/question_sets"
    name: "demographics_question_sets"
  demographics_question_sets_questions_stream:
    $parameters:
      schema_loader:
        $ref: "#/definitions/schema_loader"
      retriever:
        $ref: "#/definitions/retriever"
        requester:
          $ref: "#/definitions/requester"
          path: "demographics/question_sets/{{ stream_slice.parent_id }}/questions"
        stream_slicer:
          type: SubstreamSlicer
          parent_stream_configs:
            - stream: "#/definitions/demographics_question_sets_stream"
              parent_key: "id"
              stream_slice_field: "parent_id"
    name: "demographics_question_sets_questions"
    primary_key: "id"
  interviews_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "scheduled_interviews"
    name: "interviews"
  job_posts_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "job_posts"
    name: "job_posts"
  job_stages_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "job_stages"
    name: "job_stages"
  jobs_stages_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "jobs/{{ stream_slice.parent_id }}/stages"
    name: "jobs_stages"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "jobs/{{ stream_slice.parent_id }}/stages"
      stream_slicer:
        class_name: source_greenhouse.components.GreenHouseSubstreamSlicer
        parent_stream: "#/definitions/jobs_stream"
        request_cursor_field: "updated_after"
        stream_slice_field: "parent_id"
        cursor_field: "updated_at"
        parent_key: "id"
  offers_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "offers"
    name: "offers"
  rejection_reasons_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "rejection_reasons"
    name: "rejection_reasons"
  scorecards_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "scorecards"
    name: "scorecards"
  sources_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "sources"
    name: "sources"
  users_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "users"
    name: "users"
  demographics_answers_stream:
    $ref: "#/definitions/base_incremental_stream"
    $parameters:
      path: "demographics/answers"
    name: "demographics_answers"
  demographics_answer_options_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      path: "demographics/answer_options"
    name: "demographics_answer_options"
streams:
  - "#/definitions/applications_stream"
  - "#/definitions/applications_demographics_answers_stream"
  - "#/definitions/applications_interviews_stream"
  - "#/definitions/candidates_stream"
  - "#/definitions/close_reasons_stream"
  - "#/definitions/custom_fields_stream"
  - "#/definitions/degrees_stream"
  - "#/definitions/demographics_answers_stream"
  - "#/definitions/demographics_answer_options_stream"
  - "#/definitions/questions_stream"
  - "#/definitions/demographics_answers_answer_options_stream"
  - "#/definitions/demographics_question_sets_stream"
  - "#/definitions/demographics_question_sets_questions_stream"
  - "#/definitions/departments_stream"
  - "#/definitions/jobs_stream"
  - "#/definitions/jobs_openings_stream"
  - "#/definitions/interviews_stream"
  - "#/definitions/job_posts_stream"
  - "#/definitions/job_stages_stream"
  - "#/definitions/jobs_stages_stream"
  - "#/definitions/offers_stream"
  - "#/definitions/rejection_reasons_stream"
  - "#/definitions/scorecards_stream"
  - "#/definitions/sources_stream"
  - "#/definitions/users_stream"

check:
  type: CheckStream
  stream_names: ["applications"]
