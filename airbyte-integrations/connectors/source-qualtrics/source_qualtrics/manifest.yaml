version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path:
        - result
        - elements
  requester:
    type: HttpRequester
    url_base: "https://fra1.qualtrics.com/API/v3"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      api_token: '{{ config[''api_key''] }}'
      inject_into:
        type: RequestOption
        inject_into: header
        field_name: X-API-TOKEN
        
  paginator:
    type: DefaultPaginator
    page_token_option:
      type: RequestOption
      inject_into: request_parameter
      field_name: offset
    pagination_strategy:
      type: OffsetIncrement
 
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester"
    paginator:
      $ref: "#/definitions/paginator"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  
  groups:
    $ref: "#/definitions/base_stream"
    name: "groups"
    primary_key: "id"
    $parameters:
      path: "/groups"

  surveys:
    $ref: "#/definitions/base_stream"
    name: "surveys"
    primary_key: "id"
    $parameters:
      path: "/surveys"
    paginator:
      $ref: "#/definitions/paginator"

  surveys_questions:
    $ref: "#/definitions/base_stream"
    name: "surveys_questions"
    $parameters:
      path: "survey-definitions/{{ stream_partition.id }}/questions"
    transformations:
      - type: AddFields
        fields:
          - path:
              - survey_id
            value: "{{ stream_partition.id }}"
    retriever:
      type: SimpleRetriever
      record_selector:
        $ref: "#/definitions/selector"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        type: NoPagination
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/surveys"
            parent_key: "id"
            partition_field: "id"

  surveys_responses_requester:
    type: CustomRequester
    class_name: "source_qualtrics.component.CustomRequester" 
    url_base: "https://fra1.qualtrics.com/API/v3"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      api_token: '{{ config[''api_key''] }}'
      inject_into:
        type: RequestOption
        inject_into: header
        field_name: X-API-TOKEN

  surveys_responses:
      $ref: "#/definitions/base_stream"
      name: "surveys_responses"
      $parameters:
        path: ""
      transformations:
        - type: AddFields
          fields:
            - path:
                - survey_id
              value: "{{ stream_partition.id }}"
      retriever:
        type: SimpleRetriever
        record_selector:
          type: RecordSelector
          extractor:
            type: DpathExtractor
            field_path:
              - responses
              # - '*'
              # - values
        requester:
          $ref: "#/definitions/surveys_responses_requester"
        paginator:
          type: NoPagination
        partition_router:
          type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/surveys"
              parent_key: "id"
              partition_field: "id"
      incremental_sync:
        type: DatetimeBasedCursor
        cursor_field: _lastModifiedDate
        cursor_datetime_formats:
          - '%Y-%m-%dT%H:%M:%S.%fZ'
          - '%Y-%m-%dT%H:%M:%SZ'
        datetime_format: '%Y-%m-%dT%H:%M:%SZ'
        start_datetime:
          type: MinMaxDatetime
          datetime: '{{ config[''start_date''] }}'
          datetime_format: '%Y-%m-%dT%H:%M:%SZ'

streams:
  - "#/definitions/groups"
  - "#/definitions/surveys"
  - "#/definitions/surveys_questions"
  - "#/definitions/surveys_responses"

check:
  type: CheckStream
  stream_names:
    - "groups"
    - "surveys"
    - "surveys_questions"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/qualtrics
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    type: object
    required:
      - api_key
      - start_date
    properties:
      api_key:
        type: string
        title: API Key
        airbyte_secret: true
        order: 0
      start_date:
        type: string
        title: Start date
        pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$
        order: 1
    additionalProperties: true
  
metadata:
  autoImportSchema:
    groups: true
    surveys: true
    surveys_questions: true
    surveys_responses: true
