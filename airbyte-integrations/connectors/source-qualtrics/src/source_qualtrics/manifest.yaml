version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path:
        - result
        - elements

  requester:
    type: HttpRequester
    url_base: "https://fra1.qualtrics.com/API/v3"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      api_token: '{{ config[''api_key''] }}'
      inject_into:
        type: RequestOption
        inject_into: header
        field_name: X-API-TOKEN
        
  paginator:
    type: DefaultPaginator
    page_token_option:
      type: RequestOption
      inject_into: request_parameter
      field_name: offset
    pagination_strategy:
      type: OffsetIncrement
 
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    requester:
      $ref: "#/definitions/requester"
    paginator:
      $ref: "#/definitions/paginator"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  
  groups_stream:
    $ref: "#/definitions/base_stream"
    name: "groups"
    primary_key: "id"
    $parameters:
      path: "/groups"

  surveys_stream:
    $ref: "#/definitions/base_stream"
    name: "surveys"
    primary_key: "id"
    $parameters:
      path: "/surveys"
    paginator:
      $ref: "#/definitions/paginator"

  surveys_questions_stream:
    $ref: "#/definitions/base_stream"
    name: "surveys_questions"
    $parameters:
      path: "survey-definitions/{{ stream_partition.id }}/questions"
    retriever:
      type: SimpleRetriever
      record_selector:
        $ref: "#/definitions/selector"
      requester:
        $ref: "#/definitions/requester"
      paginator:
        type: NoPagination
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/surveys_stream"
            parent_key: "id"
            partition_field: "id"

  surveys_responses_requester:
    type: CustomRequester
    class_name: "source_qualtrics.component.CustomRequester" 
    url_base: "https://fra1.qualtrics.com/API/v3"
    http_method: "POST"
    request_body_json:
      format: csv
    authenticator:
      type: ApiKeyAuthenticator
      api_token: '{{ config[''api_key''] }}'
      inject_into:
        type: RequestOption
        inject_into: header
        field_name: X-API-TOKEN

  surveys_responses_stream:
      $ref: "#/definitions/base_stream"
      name: "surveys_responses"
      $parameters:
        path: "survey-definitions/{{ stream_partition.id }}/export-responses"
      retriever:
        type: SimpleRetriever
        record_selector:
          $ref: "#/definitions/selector"
        requester:
          $ref: "#/definitions/surveys_responses_requester"
        paginator:
          type: NoPagination
        partition_router:
          type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/surveys_stream"
              parent_key: "id"
              partition_field: "id"

streams:
  - "#/definitions/groups_stream"
  - "#/definitions/surveys_stream"
  - "#/definitions/surveys_questions_stream"
  - "#/definitions/surveys_responses_stream"

check:
  type: CheckStream
  stream_names:
    - "groups"
    - "survey"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/qualtrics
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    type: object
    required:
      - api_key
    properties:
      api_key:
        type: string
        title: API Key
        airbyte_secret: true
        order: 0
    additionalProperties: true
  
metadata:
  autoImportSchema:
    groups_stream: true
    surveys_stream: true
    surveys_questions_stream: true
    surveys_responses_stream: true
