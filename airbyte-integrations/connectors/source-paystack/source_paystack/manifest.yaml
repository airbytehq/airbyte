version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["data"]

  requester:
    type: HttpRequester
    url_base: "https://api.paystack.co/"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['secret_key'] }}"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: "DefaultPaginator"
      page_size_option:
        type: "RequestOption"
        inject_into: "request_parameter"
        field_name: "perPage"
      pagination_strategy:
        type: "PageIncrement"
        page_size: 5
      page_token_option:
        type: "RequestOption"
        inject_into: "request_parameter"
        field_name: "page"
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  incremental_sync_base:
    type: DatetimeBasedCursor
    cursor_field: "{{ parameters.incremental_cursor }}"
    datetime_format: "%Y-%m-%dT%H:%M:%S.%fZ"
    cursor_granularity: "PT0.000001S"
    lookback_window: "P31D"
    start_datetime:
      datetime: "{{ config['start_date'] }}"
      datetime_format: "%Y-%m-%dT%H:%M:%SZ"
    end_datetime:
      datetime: "{{ today_utc() }}"
      datetime_format: "%Y-%m-%d"
    step: "P1M"

  transactions_stream:
    $ref: "#/definitions/base_stream"
    name: "transactions"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "transaction"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          id:
            type:
            - 'null'
            - integer
          domain:
            type:
            - 'null'
            - string
          status:
            type:
            - 'null'
            - string
          reference:
            type:
            - 'null'
            - string
          amount:
            type:
            - 'null'
            - integer
          message:
            type:
            - 'null'
            - string
          gateway_response:
            type:
            - 'null'
            - string
          paid_at:
            type:
            - 'null'
            - string
            format: date-time
          created_at:
            type:
            - 'null'
            - string
            format: date-time
          channel:
            type:
            - 'null'
            - string
          currency:
            type:
            - 'null'
            - string
          ip_address:
            type:
            - 'null'
            - string
          metadata:
            type:
            - 'null'
            - object
            properties:
              referrer:
                type:
                - 'null'
                - string
          log:
            type:
            - 'null'
            - object
            properties:
              start_time:
                type:
                - 'null'
                - integer
              time_spent:
                type:
                - 'null'
                - integer
              attempts:
                type:
                - 'null'
                - integer
              errors:
                type:
                - 'null'
                - integer
              success:
                type:
                - 'null'
                - boolean
              mobile:
                type:
                - 'null'
                - boolean
              input:
                type:
                - 'null'
                - array
                items: {}
              history:
                type:
                - 'null'
                - array
                items:
                  type:
                  - 'null'
                  - object
                  properties:
                    type:
                      type:
                      - 'null'
                      - string
                    message:
                      type:
                      - 'null'
                      - string
                    time:
                      type:
                      - 'null'
                      - integer
          fees:
            type:
            - 'null'
            - integer
          fees_split:
            type:
            - 'null'
            - string
          customer:
            type:
            - 'null'
            - object
            properties: {}
          authorization:
            type:
            - 'null'
            - object
            properties: {}
          plan:
            type:
            - 'null'
            - object
            properties: {}
          split:
            type:
            - 'null'
            - object
            properties: {}
          subaccount:
            type:
            - 'null'
            - object
            properties: {}
          order_id:
            type:
            - 'null'
            - integer
          paidAt:
            type:
            - 'null'
            - string
            format: date-time
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
          requested_amount:
            type:
            - 'null'
            - integer
          source:
            type:
            - 'null'
            - object
            properties:
              source:
                type:
                - 'null'
                - string
              type:
                type:
                - 'null'
                - string
              identifier:
                type:
                - 'null'
                - string
              entry_point:
                type:
                - 'null'
                - string
  customers_stream:
    $ref: "#/definitions/base_stream"
    name: "customers"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "customer"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          integration:
            type:
            - 'null'
            - integer
          first_name:
            type:
            - 'null'
            - string
          last_name:
            type:
            - 'null'
            - string
          email:
            type:
            - 'null'
            - string
          phone:
            type:
            - 'null'
            - string
          metadata:
            type:
            - 'null'
            - object
            properties: {}
          domain:
            type:
            - 'null'
            - string
          customer_code:
            type:
            - 'null'
            - string
          risk_action:
            type:
            - 'null'
            - string
          id:
            type:
            - 'null'
            - integer
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
          updatedAt:
            type:
            - 'null'
            - string
            format: date-time
  disputes_stream:
    $ref: "#/definitions/base_stream"
    name: "disputes"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "dispute"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          id:
            type:
            - 'null'
            - integer
          refund_amount:
            type:
            - 'null'
            - integer
          currency:
            type:
            - 'null'
            - string
          status:
            type:
            - 'null'
            - string
          resolution:
            type:
            - 'null'
            - string
          domain:
            type:
            - 'null'
            - string
          transaction:
            type:
            - 'null'
            - object
            properties: {}
          transaction_reference:
            type:
            - 'null'
            - string
          category:
            type:
            - 'null'
            - string
          customer:
            type:
            - 'null'
            - object
            properties: {}
          bin:
            type:
            - 'null'
            - string
          last4:
            type:
            - 'null'
            - string
          dueAt:
            type:
            - 'null'
            - string
            format: date-time
          resolvedAt:
            type:
            - 'null'
            - string
            format: date-time
          evidence:
            type:
            - 'null'
            - string
          attachments:
            type:
            - 'null'
            - string
          note:
            type:
            - 'null'
            - string
          history:
            type:
            - 'null'
            - array
            items:
              type:
              - 'null'
              - object
              properties:
                status:
                  type:
                  - 'null'
                  - string
                by:
                  type:
                  - 'null'
                  - string
                createdAt:
                  type:
                  - 'null'
                  - string
                  format: date-time
          messages:
            type:
            - 'null'
            - array
            items:
              type:
              - 'null'
              - object
              properties:
                sender:
                  type:
                  - 'null'
                  - string
                body:
                  type:
                  - 'null'
                  - string
                createdAt:
                  type:
                  - 'null'
                  - string
                  format: date-time
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
          updatedAt:
            type:
            - 'null'
            - string
            format: date-time
  refunds_stream:
    $ref: "#/definitions/base_stream"
    name: "refunds"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "refund"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          integration:
            type:
            - 'null'
            - integer
          transaction:
            type:
            - 'null'
            - integer
          dispute:
            type:
            - 'null'
            - object
            properties: {}
          settlement:
            type:
            - 'null'
            - object
            properties: {}
          id:
            type:
            - 'null'
            - integer
          domain:
            type:
            - 'null'
            - string
          currency:
            type:
            - 'null'
            - string
          amount:
            type:
            - 'null'
            - integer
          status:
            type:
            - 'null'
            - string
          refunded_at:
            type:
            - 'null'
            - string
            format: date-time
          refunded_by:
            type:
            - 'null'
            - string
          customer_note:
            type:
            - 'null'
            - string
          merchant_note:
            type:
            - 'null'
            - string
          deducted_amount:
            type:
            - 'null'
            - integer
          fully_deducted:
            type:
            - 'null'
            - boolean
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
  settlements_stream:
    $ref: "#/definitions/base_stream"
    name: "settlements"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "settlement"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          integration:
            type:
            - 'null'
            - integer
          subaccount:
            type:
            - 'null'
            - object
            properties: {}
          settled_by:
            type:
            - 'null'
            - string
          settlement_date:
            type:
            - 'null'
            - string
            format: date-time
          domain:
            type:
            - 'null'
            - string
          total_amount:
            type:
            - 'null'
            - integer
          total_fees:
            type:
            - 'null'
            - integer
          total_processed:
            type:
            - 'null'
            - integer
          deductions:
            type:
            - 'null'
            - integer
          effective_amount:
            type:
            - 'null'
            - integer
          status:
            type:
            - 'null'
            - string
          id:
            type:
            - 'null'
            - integer
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
          updatedAt:
            type:
            - 'null'
            - string
            format: date-time
  subscriptions_stream:
    $ref: "#/definitions/base_stream"
    name: "subscriptions"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "subscription"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          id:
            type:
            - 'null'
            - integer
          domain:
            type:
            - 'null'
            - string
          status:
            type:
            - 'null'
            - string
          start:
            type:
            - 'null'
            - integer
          quantity:
            type:
            - 'null'
            - integer
          subscription_code:
            type:
            - 'null'
            - string
          email_token:
            type:
            - 'null'
            - string
          amount:
            type:
            - 'null'
            - integer
          cron_expression:
            type:
            - 'null'
            - string
          next_payment_date:
            type:
            - 'null'
            - string
            format: date-time
          open_invoice:
            type:
            - 'null'
            - string
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
          integration:
            type:
            - 'null'
            - integer
          plan:
            type:
            - 'null'
            - object
            properties: {}
          authorization:
            type:
            - 'null'
            - object
            properties: {}
          customer:
            type:
            - 'null'
            - object
            properties: {}
          invoice_limit:
            type:
            - 'null'
            - integer
          split_code:
            type:
            - 'null'
            - string
          payments_count:
            type:
            - 'null'
            - integer
          most_recent_invoice:
            type:
            - 'null'
            - object
            properties: {}
  transfers_stream:
    $ref: "#/definitions/base_stream"
    name: "transfers"
    primary_key: "id"
    $parameters:
      incremental_cursor: "createdAt"
      path: "transfer"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          integration:
            type:
            - 'null'
            - integer
          domain:
            type:
            - 'null'
            - string
          amount:
            type:
            - 'null'
            - integer
          currency:
            type:
            - 'null'
            - string
          source:
            type:
            - 'null'
            - string
          reason:
            type:
            - 'null'
            - string
          recipient:
            type:
            - 'null'
            - object
            properties:
              domain:
                type:
                - 'null'
                - string
              type:
                type:
                - 'null'
                - string
              currency:
                type:
                - 'null'
                - string
              name:
                type:
                - 'null'
                - string
              details:
                type:
                - 'null'
                - object
                properties:
                  account_number:
                    type:
                    - 'null'
                    - string
                  account_name:
                    type:
                    - 'null'
                    - string
                  bank_code:
                    type:
                    - 'null'
                    - string
                  bank_name:
                    type:
                    - 'null'
                    - string
              description:
                type:
                - 'null'
                - string
              metadata:
                type:
                - 'null'
                - object
                properties: {}
              recipient_code:
                type:
                - 'null'
                - string
              active:
                type:
                - 'null'
                - boolean
              id:
                type:
                - 'null'
                - integer
              integration:
                type:
                - 'null'
                - integer
              createdAt:
                type:
                - 'null'
                - string
                format: date-time
              updatedAt:
                type:
                - 'null'
                - string
                format: date-time
          status:
            type:
            - 'null'
            - string
          transfer_code:
            type:
            - 'null'
            - string
          id:
            type:
            - 'null'
            - integer
          createdAt:
            type:
            - 'null'
            - string
            format: date-time
          updatedAt:
            type:
            - 'null'
            - string
            format: date-time
  invoices_stream:
    $ref: "#/definitions/base_stream"
    name: "invoices"
    primary_key: "id"
    $parameters:
      incremental_cursor: "created_at"
      path: "paymentrequest"
    incremental_sync:
      $ref: "#/definitions/incremental_sync_base"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        type:
        - 'null'
        - object
        properties:
          id:
            type:
            - 'null'
            - integer
          integration:
            type:
            - 'null'
            - integer
          domain:
            type:
            - 'null'
            - string
          amount:
            type:
            - 'null'
            - integer
          currency:
            type:
            - 'null'
            - string
          due_date:
            type:
            - 'null'
            - string
            format: date-time
          has_invoice:
            type:
            - 'null'
            - boolean
          invoice_number:
            type:
            - 'null'
            - integer
          description:
            type:
            - 'null'
            - string
          pdf_url:
            type:
            - 'null'
            - string
          line_items:
            type:
            - 'null'
            - array
            items:
              type:
              - 'null'
              - object
              properties:
                name:
                  type:
                  - 'null'
                  - string
                amount:
                  type:
                  - 'null'
                  - integer
                quantity:
                  type:
                  - 'null'
                  - integer
          tax:
            type:
            - 'null'
            - array
            items:
              type:
              - 'null'
              - object
              properties:
                name:
                  type:
                  - 'null'
                  - string
                amount:
                  type:
                  - 'null'
                  - integer
          request_code:
            type:
            - 'null'
            - string
          status:
            type:
            - 'null'
            - string
          paid:
            type:
            - 'null'
            - boolean
          paid_at:
            type:
            - 'null'
            - string
            format: date-time
          metadata:
            type:
            - 'null'
            - object
            properties: {}
          notifications:
            type:
            - 'null'
            - array
            items:
              type:
              - 'null'
              - object
              properties:
                sent_at:
                  type:
                  - 'null'
                  - string
                channel:
                  type:
                  - 'null'
                  - string
          offline_reference:
            type:
            - 'null'
            - string
          customer:
            type:
            - 'null'
            - object
            properties: {}
          created_at:
            type:
            - 'null'
            - string
            format: date-time
streams:
- "#/definitions/transactions_stream"
- "#/definitions/customers_stream"
- "#/definitions/invoices_stream"
- "#/definitions/disputes_stream"
- "#/definitions/refunds_stream"
- "#/definitions/settlements_stream"
- "#/definitions/subscriptions_stream"
- "#/definitions/transfers_stream"

check:
  type: CheckStream
  stream_names:
  - "transactions"
  - "customers"
  - "invoices"
  - "disputes"
  - "refunds"
  - "settlements"
  - "subscriptions"
  - "transfers"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/paystack
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Paystack Source Spec
    type: object
    required:
    - secret_key
    - start_date
    additionalProperties: true
    properties:
      secret_key:
        type: string
        title: Secret Key
        pattern: "^(s|r)k_(live|test)_[a-zA-Z0-9]+$"
        description: The Paystack API key (usually starts with 'sk_live_'; find yours
          <a href="https://dashboard.paystack.com/#/settings/developer">here</a>).
        airbyte_secret: true
      start_date:
        type: string
        title: Start Date
        pattern: "^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}Z$"
        description: UTC date and time in the format 2017-01-25T00:00:00Z. Any data
          before this date will not be replicated.
        examples:
        - '2017-01-25T00:00:00Z'
        format: date-time
      lookback_window_days:
        type: integer
        title: Lookback Window (in days)
        default: 0
        minimum: 0
        description: When set, the connector will always reload data from the past
          N days, where N is the value set here. This is useful if your data is updated
          after creation.
