version: "0.29.0"

definitions:
  requester:
    type: HttpRequester
    url_base: "https://api.aircall.io/v1"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config['api_id'] }}"
      password: "{{ config['api_token'] }}"

  record_retriever:
    type: SimpleRetriever
    record_selector:
      type: RecordSelector
      extractor:
        type: DpathExtractor
        field_path: ["{{ parameters.name }}"]
      paginator:
        type: "DefaultPaginator"
        page_size_option:
          type: "RequestOption"
          inject_into: "request_parameter"
          field_name: "{{ response['meta']['per_page'] }}"
        pagination_strategy:
          type: "PageIncrement"
          page_size: 5
        page_token_option:
          type: "RequestOption"
          inject_into: "request_parameter"
          field_name: "{{ response['meta']['page'] }}"

  calls_stream:
    type: DeclarativeStream
    $parameters:
      name: "calls"
      path: "/calls"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"

  company_stream:
    type: DeclarativeStream
    $parameters:
      name: "company"
      path: "/company"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"

  contacts_stream:
    type: DeclarativeStream
    $parameters:
      name: "contacts"
      path: "/contacts"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"

  numbers_stream:
    type: DeclarativeStream
    $parameters:
      name: "numbers"
      path: "/numbers"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "created_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      cursor_granularity: "PT0.000001S"
      lookback_window: "P31D"
      start_datetime:
        datetime: "{{ config['start_date'] }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: "P1M"
    primary_key: "id"

  tags_stream:
    type: DeclarativeStream
    $parameters:
      name: "tags"
      path: "/tags"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    primary_key: "id"

  user_retriever:
    type: SimpleRetriever
    record_selector:
      type: RecordSelector
      extractor:
        type: DpathExtractor
        field_path: ["users"]
    requester:
      $ref: "#/definitions/requester"

  users_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/user_retriever"
    name: "users"
    primary_key: "id"
    $parameters:
      path: "/users"

  user_availablity_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/user_retriever"
    name: "user_availablity"
    primary_key: "id"
    $parameters:
      path: "/users/availabilities"

  teams_stream:
    type: DeclarativeStream
    $parameters:
      name: "teams"
      path: "/teams"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "created_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      cursor_granularity: "PT0.000001S"
      lookback_window: "P31D"
      start_datetime:
        datetime: "{{ config['start_date'] }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: "P1M"
    primary_key: "id"

  webhooks_stream:
    type: DeclarativeStream
    $parameters:
      name: "webhooks"
      path: "/webhooks"
    retriever:
      $ref: "#/definitions/record_retriever"
      requester:
        $ref: "#/definitions/requester"
    primary_key: "id"

streams:
  - "#/definitions/calls_stream"
  - "#/definitions/company_stream"
  - "#/definitions/contacts_stream"
  - "#/definitions/numbers_stream"
  - "#/definitions/tags_stream"
  - "#/definitions/user_availablity_stream"
  - "#/definitions/users_stream"
  - "#/definitions/teams_stream"
  - "#/definitions/webhooks_stream"

check:
  type: CheckStream
  stream_names:
    - "calls"
    - "company"
    - "contacts"
    - "numbers"
    - "tags"
    - "user_availablity"
    - "users"
    - "teams"
    - "webhooks"
spec:
  type: Spec
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Aircall Spec
    type: object
    required:
      - api_id
      - api_token
      - start_date
    additionalProperties: true
    properties:
      api_id:
        title: API ID
        type: string
        description: App ID found at settings https://dashboard.aircall.io/integrations/api-keys
        airbyte_secret: true
      api_token:
        title: API Token
        type: string
        description: App token found at settings (Ref- https://dashboard.aircall.io/integrations/api-keys)
        airbyte_secret: true
      start_date:
        title: Date-From Filter
        type: string
        description: Date time filter for incremental filter, Specify which date to extract from.
        pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}T[0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3}Z$
        examples:
          - '2022-03-01T00:00:00.000Z'
        format: date-time
  documentation_url: https://docs.airbyte.com/integrations/sources/aircall
