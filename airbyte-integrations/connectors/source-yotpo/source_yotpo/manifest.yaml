version: "0.29.0"

definitions:

  yotpo_stream_requester:
    type: HttpRequester
    url_base: "https://api.yotpo.com/v1"
    http_method: "GET"
    request_parameters:
      utoken: "{{ config['access_token'] }}"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['access_token'] }}"

  yotpo_stream_plain_requester:
    type: HttpRequester
    url_base: "https://api.yotpo.com"
    http_method: "GET"
    request_parameters:
      utoken: "{{ config['access_token'] }}"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['access_token'] }}"

  privacy_stream_requester:
    type: HttpRequester
    url_base: "https://api.yotpo.com/privacy"
    http_method: "GET"
    request_parameters:
      utoken: "{{ config['access_token'] }}"
      email: "{{ config['email'] }}"

  privacy_data_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: ["response"]
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/privacy_stream_requester"
    name: "privacy_data"
    $parameters:
      path: "/data/exists"
  
  privacy_user_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: ["status"]
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/privacy_stream_requester"
    name: "privacy_user"
    $parameters:
      path: "/data"

  reviews_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: ["reviews"]
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/yotpo_stream_requester"
    incremental_sync:
      type: DatetimeBasedCursor
      cursor_field: "updated_at"
      datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      cursor_granularity: "PT0.000001S"
      lookback_window: "P31D"
      start_datetime:
        datetime: "{{ config['start_date'] }}"
        datetime_format: "%Y-%m-%dT%H:%M:%S.%f%z"
      end_datetime:
        datetime: "{{ today_utc() }}"
        datetime_format: "%Y-%m-%d"
      step: "P1M"
    name: "reviews"
    primary_key: "id"
    $parameters:
      path: "/apps/{{ config['app_key'] }}/reviews"

  reviews_bottomline_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: ["response"]
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/yotpo_stream_plain_requester"
    name: "reviews_bottomline"
    $parameters:
      path: "/products/{{ config['app_key'] }}/yotpo_site_reviews/bottomline"


  top_reviews_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: ["reviews"]
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/yotpo_stream_plain_requester"
    name: "top_reviews"
    $parameters:
      path: "/apps/{{ config['app_key'] }}/top_reviews"

  webhooks_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: ["response"]
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/yotpo_stream_plain_requester"
    name: "webhooks"
    $parameters:
      path: "/apps/{{ config['app_key'] }}/webhooks"

streams:
  - "#/definitions/privacy_data_stream"
  - "#/definitions/privacy_user_stream"
  - "#/definitions/reviews_stream"
  - "#/definitions/reviews_bottomline_stream"
  - "#/definitions/top_reviews_stream"
  - "#/definitions/webhooks_stream"

check:
  type: CheckStream
  stream_names:
    - "privacy_data"
    - "privacy_user"
    - "reviews"
    - "reviews_bottomline"
    - "top_reviews"
    - "webhooks"
