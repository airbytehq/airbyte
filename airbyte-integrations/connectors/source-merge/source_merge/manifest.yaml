version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["results"]

  requester:
    type: HttpRequester
    url_base: "https://api.merge.dev/api/ats/v1"
    http_method: "GET"
    request_headers:
      X-Account-Token: "{{ config['account_token'] }}"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_token'] }}"

  selective_paginator:
    type: DefaultPaginator
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{ response.next }}"
    page_token_option:
      type: RequestPath

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      $ref: "#/definitions/selective_paginator"
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  
  account_details_stream:
    type: DeclarativeStream
    retriever:
      type: SimpleRetriever
      record_selector:
        type: RecordSelector
        extractor:
          type: DpathExtractor
          field_path: []
      paginator:
        type: NoPagination
      requester:
        $ref: "#/definitions/requester"
    name: "account_details"
    primary_key: "id"
    $parameters:
      path: "/account-details"

  sync_status_stream:
    $ref: "#/definitions/base_stream"
    name: "sync_status"
    primary_key: "model_id"
    $parameters:
      path: "/sync-status"

  users_stream:
    $ref: "#/definitions/base_stream"
    name: "users"
    primary_key: "id"
    $parameters:
      path: "/users"

streams:
  - "#/definitions/account_details_stream"
  - "#/definitions/sync_status_stream"
  - "#/definitions/users_stream"

check:
  type: CheckStream
  stream_names:
    - "account_details"
    - "sync_status"
    - "users"
