/*
 * Copyright (c) 2023 Airbyte, Inc., all rights reserved.
 */
package io.airbyte.integrations.destination.bigquery

import com.fasterxml.jackson.databind.JsonNode
import com.fasterxml.jackson.databind.node.ObjectNode
import io.airbyte.cdk.load.util.Jsons
import io.airbyte.integrations.destination.bigquery.spec.BigqueryConfiguration
import io.airbyte.integrations.destination.bigquery.spec.BigqueryConfigurationFactory
import io.airbyte.integrations.destination.bigquery.spec.BigquerySpecification
import java.io.IOException
import java.nio.file.Files
import java.nio.file.Path
import java.util.*
import org.slf4j.Logger
import org.slf4j.LoggerFactory

object BigQueryDestinationTestUtils {
    private val LOGGER: Logger = LoggerFactory.getLogger(BigQueryDestinationTestUtils::class.java)

    val standardInsertRawOverrideConfig =
        createConfig(
            configFile = Path.of("secrets/credentials-1s1t-standard-raw-override.json"),
            datasetId = DEFAULT_NAMESPACE_PLACEHOLDER,
        )
    val standardInsertConfig =
        createConfig(
            configFile = Path.of("secrets/credentials-1s1t-standard.json"),
            datasetId = DEFAULT_NAMESPACE_PLACEHOLDER,
        )

    /**
     * Parse the config file and replace dataset with rawNamespace and stagingPath randomly
     * generated by the test.
     *
     * @param configFile Path to the config file
     * @param datasetId Dataset id to use in the test. Should be randomized per test case.
     * @param stagingPath Staging GCS path to use in the test, or null if the test is running in
     * standard inserts mode. Should be randomized per test case.
     */
    @Throws(IOException::class)
    fun createConfig(
        configFile: Path?,
        datasetId: String?,
    ): ObjectNode {
        LOGGER.info("Setting default dataset to {}", datasetId)
        val tmpConfigAsString = Files.readString(configFile)
        val config = Jsons.readTree(tmpConfigAsString) as ObjectNode
        config.put(BigQueryConsts.CONFIG_DATASET_ID, datasetId)
        return config
    }

    fun parseConfig(config: JsonNode): BigqueryConfiguration {
        val spec = Jsons.treeToValue(config, BigquerySpecification::class.java)
        return BigqueryConfigurationFactory().make(spec)
    }
}
