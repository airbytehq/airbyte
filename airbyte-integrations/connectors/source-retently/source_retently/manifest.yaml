version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["data", "{{ parameters.path_extractor }}"]
  selector_data:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["{{ parameters.path_extractor }}"]

  oauth_authenticator:
    type: OAuthAuthenticator
    token_refresh_endpoint: https://app.retently.com/api/oauth/token
    client_id: "{{ config['credentials']['client_id'] }}"
    client_secret: "{{ config['credentials']['client_secret'] }}"
    refresh_token: "{{ config['credentials']['refresh_token'] }}"
  api_authenticator:
    type: ApiKeyAuthenticator
    header: "Authorization"
    api_token: "api_key={{ config['credentials']['api_key']  }}"

  requester:
    type: HttpRequester
    url_base: "https://app.retently.com/api/v2/"
    http_method: "GET"
    authenticator:
      class_name: source_retently.components.AuthenticatorRetently
      api_auth: "#/definitions/api_authenticator"
      oauth: "#/definitions/oauth_authenticator"

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: "DefaultPaginator"
      pagination_strategy:
        type: "PageIncrement"
        page_size: 20
        start_from_page: 1
      page_token_option:
        type: "RequestOption"
        inject_into: "request_parameter"
        field_name: "page"
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  campaigns_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector_data"
      paginator:
        type: NoPagination
    name: "campaigns"
    primary_key: "id"
    $parameters:
      path_extractor: "campaigns"
      path: "campaigns"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          isActive:
            type:
              - "null"
              - boolean
          templateId:
            type:
              - "null"
              - string
          metric:
            type:
              - "null"
              - string
          type:
            type:
              - "null"
              - string
          channel:
            type:
              - "null"
              - string
  companies_stream:
    $ref: "#/definitions/base_stream"
    name: "companies"
    primary_key: "id"
    $parameters:
      path_extractor: "companies"
      path: "companies"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          id:
            type:
              - "null"
              - string
          createdDate:
            type:
              - "null"
              - string
            format: yyyy-MM-dd'T'HH:mm:ss.SSSZ
          domain:
            type:
              - "null"
              - string
          companyName:
            type:
              - "null"
              - string
          industryName:
            type:
              - "null"
              - string
          tags:
            type: array
            items:
              type:
                - "null"
                - string
          cxMetrics:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              NPS:
                type:
                  - "null"
                  - number
              CSAT:
                type:
                  - "null"
                  - number
              CES:
                type:
                  - "null"
                  - number
              STAR:
                type:
                  - "null"
                  - number
          contactsCount:
            type:
              - "null"
              - number
  customers_stream:
    $ref: "#/definitions/base_stream"
    name: "customers"
    primary_key: "id"
    $parameters:
      path_extractor: "subscribers"
      path: "nps/customers"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          id:
            type:
              - "null"
              - string
          email:
            type:
              - "null"
              - string
          firstName:
            type:
              - "null"
              - string
          lastName:
            type:
              - "null"
              - string
          companyName:
            type:
              - "null"
              - string
          companyId:
            type:
              - "null"
              - string
          tags:
            type: array
            items:
              type:
                - "null"
                - string
          createdDate:
            type:
              - "null"
              - string
            format: yyyy-MM-dd'T'HH:mm:ss.SSSZ
          properties:
            type: array
            items:
              type:
                - "null"
                - object
              additionalProperties: true
              properties:
                label:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
                type:
                  type:
                    - "null"
                    - string
                value:
                  type:
                    - "null"
                    - string
  feedback_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        type: "DefaultPaginator"
        pagination_strategy:
          type: "PageIncrement"
          page_size: 10
          start_from_page: 1
        page_token_option:
          type: "RequestOption"
          inject_into: "request_parameter"
          field_name: "page"
    name: "feedback"
    primary_key: "id"
    $parameters:
      path_extractor: "responses"
      path: "feedback"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          id:
            type:
              - "null"
              - string
          customerId:
            type:
              - "null"
              - string
          email:
            type:
              - "null"
              - string
          firstName:
            type:
              - "null"
              - string
          lastName:
            type:
              - "null"
              - string
          companyName:
            type:
              - "null"
              - string
          companyId:
            type:
              - "null"
              - string
          jobTitle:
            type:
              - "null"
              - string
          country:
            type:
              - "null"
              - string
          state:
            type:
              - "null"
              - string
          city:
            type:
              - "null"
              - string
          tags:
            type: array
            items:
              type: string
          customProps:
            type: array
            items:
              type: object
          campaignId:
            type:
              - "null"
              - string
          campaignName:
            type:
              - "null"
              - string
          createdDate:
            type:
              - "null"
              - string
            format: yyyy-MM-dd'T'HH:mm:ss.SSSZ
          score:
            type:
              - "null"
              - number
          comment:
            type:
              - "null"
              - string
          checkbox:
            type:
              - "null"
              - boolean
          additionalQuestions:
            type: array
            items:
              type: object
          feedbackTopics:
            type: array
            items:
              type: object
          feedbackTags:
            type: array
            items:
              type: string
          feedbackTagsNew:
            type: array
            items:
              type: string
          notes:
            type: array
            items:
              type: object
          status:
            type:
              - string
              - "null"
          assigned:
            type:
              - "null"
              - string
          ratingCategory:
            type:
              - "null"
              - string
          resolved:
            type:
              - "null"
              - boolean
          channel:
            type:
              - "null"
              - string
          metricsType:
            type:
              - "null"
              - string
          isBogus:
            type:
              - "null"
              - boolean
  outbox_stream:
    $ref: "#/definitions/base_stream"
    name: "outbox"
    $parameters:
      path_extractor: "surveys"
      path: "nps/outbox"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          email:
            type:
              - "null"
              - string
          customerId:
            type:
              - "null"
              - string
          firstName:
            type:
              - "null"
              - string
          lastName:
            type:
              - "null"
              - string
          companyName:
            type:
              - "null"
              - string
          companyId:
            type:
              - "null"
              - string
          sentDate:
            type:
              - "null"
              - string
            format: yyyy-MM-dd'T'HH:mm:ss.SSSZ
          channel:
            type:
              - "null"
              - string
          personTags:
            type:
              - array
              - "null"
            items:
              type: string
          campaign:
            type:
              - "null"
              - string
          campaignId:
            type:
              - "null"
              - string
          surveyTemplateId:
            type:
              - "null"
              - string
          subject:
            type:
              - "null"
              - string
          sentBy:
            type:
              - "null"
              - string
          status:
            type:
              - "null"
              - string
          attributes:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              customerTags:
                type:
                  - "null"
                  - array
                items:
                  type: string
              customProps:
                type:
                  - "null"
                  - array
                items:
                  type: object
                  additionalProperties: true
                  properties:
                    label:
                      type:
                        - "null"
                        - string
                    name:
                      type:
                        - "null"
                        - string
                    type:
                      type:
                        - "null"
                        - string
                    value:
                      type:
                        - "null"
                        - string
          detailedStatus:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              isOpened:
                type:
                  - "null"
                  - boolean
              openedDate:
                format: yyyy-MM-dd'T'HH:mm:ss.SSSZ
                type:
                  - "null"
                  - string
              isResponded:
                type:
                  - "null"
                  - boolean
              respondedDate:
                format: yyyy-MM-dd'T'HH:mm:ss.SSSZ
                type:
                  - "null"
                  - string
              hasFeedback:
                type:
                  - "null"
                  - boolean
              isOptedOut:
                type:
                  - "null"
                  - boolean
              isBounced:
                type:
                  - "null"
                  - boolean
          mandrillMessageId:
            type:
              - "null"
              - string
          additionalRecipients:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - object
              additionalProperties: true
            mandrillMessageId:
              type:
                - "null"
                - string
  reports_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector_data"
      paginator:
        type: NoPagination
    name: "reports"
    $parameters:
      path_extractor: "data"
      path: "reports"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          campaignId:
            type:
              - "null"
              - string
          questionsStats:
            type:
              - "null"
              - array
            items:
              type: object
              additionalProperties: true
          trend:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - object
              additionalProperties: true
              properties:
                day:
                  type:
                    - "null"
                    - string
                promoters:
                  type:
                    - "null"
                    - number
                passives:
                  type:
                    - "null"
                    - number
                detractors:
                  type:
                    - "null"
                    - number
                total:
                  type:
                    - "null"
                    - number
                score:
                  type:
                    - "null"
                    - number
          last:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              promoters:
                type:
                  - "null"
                  - number
              passives:
                type:
                  - "null"
                  - number
              detractors:
                type:
                  - "null"
                  - number
              total:
                type:
                  - "null"
                  - number
              score:
                type:
                  - "null"
                  - number
          deliveryStats:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              totalCount:
                type:
                  - "null"
                  - number
              opened:
                type:
                  - "null"
                  - number
              responded:
                type:
                  - "null"
                  - number
              optedOut:
                type:
                  - "null"
                  - number
              isBounced:
                type:
                  - "null"
                  - number
  nps_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector_data"
      paginator:
        type: NoPagination
    name: "nps"
    $parameters:
      path_extractor: "data"
      path: "nps/score"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          score:
            type:
              - "null"
              - integer
          scoreSum:
            type:
              - "null"
              - integer
          metricsType:
            type:
              - "null"
              - string
          promoters:
            type:
              - "null"
              - integer
          passives:
            type:
              - "null"
              - integer
          detractors:
            type:
              - "null"
              - integer
          promotersCount:
            type:
              - "null"
              - integer
          passivesCount:
            type:
              - "null"
              - integer
          detractorsCount:
            type:
              - "null"
              - integer
          totalResponses:
            type:
              - "null"
              - integer
  templates_stream:
    $ref: "#/definitions/base_stream"
    name: "templates"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        $ref: "#/definitions/selector_data"
    primary_key: "id"
    $parameters:
      path_extractor: "data"
      path: "templates"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        type: object
        additionalProperties: true
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          channel:
            type:
              - "null"
              - string
          metric:
            type:
              - "null"
              - string
streams:
  - "#/definitions/campaigns_stream"
  - "#/definitions/companies_stream"
  - "#/definitions/customers_stream"
  - "#/definitions/feedback_stream"
  - "#/definitions/outbox_stream"
  - "#/definitions/reports_stream"
  - "#/definitions/nps_stream"
  - "#/definitions/templates_stream"

check:
  type: CheckStream
  stream_names:
    - "customers"
