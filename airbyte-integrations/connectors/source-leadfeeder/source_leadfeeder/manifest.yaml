version: "0.29.0"

definitions:
  base_requester:
    type: HttpRequester
    url_base: https://api.leadfeeder.com
    http_method: GET
    request_headers:
      Authorization: Token token={{ config["api_token"] }}
  record_selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path:
        - data
  error_handler:
    type: CompositeErrorHandler
    error_handlers:
      - type: DefaultErrorHandler
        response_filters:
          - type: HttpResponseFilter
            action: IGNORE
            http_codes:
              - 402
      - type: DefaultErrorHandler
        max_retries: 2
        response_filters:
          - type: HttpResponseFilter
            action: RETRY
            http_codes:
              - 429
        backoff_strategies:
          - type: ConstantBackoffStrategy
            backoff_time_in_seconds: 60
  partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - type: ParentStreamConfig
        stream:
          $ref: "#/definitions/accounts_stream"
        parent_key: id
        partition_field: account_id
  paginator:
    type: DefaultPaginator
    page_size_option:
      type: RequestOption
      field_name: page[size]
      inject_into: request_parameter
    page_token_option:
      type: RequestOption
      field_name: page[number]
      inject_into: request_parameter
    pagination_strategy:
      type: PageIncrement
      page_size: 100
      start_from_page: 1
      inject_on_first_request: true
  incremental_sync:
    type: DatetimeBasedCursor
    end_datetime:
      type: MinMaxDatetime
      datetime: "{{ now_utc().strftime('%Y-%m-%d') }}"
      datetime_format: "%Y-%m-%d"
    start_datetime:
      type: MinMaxDatetime
      datetime: '{{ config["start_date"] }}'
      datetime_format: "%Y-%m-%d"
    datetime_format: "%Y-%m-%d"
    end_time_option:
      type: RequestOption
      field_name: end_date
      inject_into: request_parameter
    start_time_option:
      type: RequestOption
      field_name: start_date
      inject_into: request_parameter
    cursor_datetime_formats:
      - "%Y-%m-%d"

  accounts_stream:
    type: DeclarativeStream
    name: accounts
    primary_key:
      - id
    retriever:
      type: SimpleRetriever
      requester:
        $ref: "#/definitions/base_requester"
        path: /accounts
        error_handler:
          $ref: "#/definitions/error_handler"
      record_selector:
        $ref: "#/definitions/record_selector"
    schema_loader:
      type: JsonFileSchemaLoader
      file_path: "./source_leadfeeder/schemas/accounts.json"

  leads_stream:
    type: DeclarativeStream
    name: leads
    primary_key:
      - id
    retriever:
      type: SimpleRetriever
      requester:
        $ref: "#/definitions/base_requester"
        path: /accounts/{{stream_partition.account_id}}/leads
        error_handler:
          $ref: "#/definitions/error_handler"
      paginator:
        $ref: "#/definitions/paginator"
      record_selector:
        $ref: "#/definitions/record_selector"
      partition_router:
        $ref: "#/definitions/partition_router"
    transformations:
      - type: AddFields
        fields:
          - path:
              - account_id
            value: "{{stream_partition.account_id}}"
      - type: AddFields
        fields:
          - path:
              - last_visit_date
            value: "{{record['attributes']['last_visit_date']}}"
    incremental_sync:
      $ref: "#/definitions/incremental_sync"
      cursor_field: last_visit_date
    schema_loader:
      type: JsonFileSchemaLoader
      file_path: "./source_leadfeeder/schemas/leads.json"

  visits_stream:
    type: DeclarativeStream
    name: visits
    primary_key:
      - id
    retriever:
      type: SimpleRetriever
      requester:
        $ref: "#/definitions/base_requester"
        path: /accounts/{{stream_partition.account_id}}/visits
        error_handler:
          $ref: "#/definitions/error_handler"
      paginator:
        $ref: "#/definitions/paginator"
      record_selector:
        $ref: "#/definitions/record_selector"
      partition_router:
        $ref: "#/definitions/partition_router"
    transformations:
      - type: AddFields
        fields:
          - path:
              - account_id
            value: "{{stream_partition.account_id}}"
      - type: AddFields
        fields:
          - path:
              - date
            value: "{{record['attributes']['date']}}"
    incremental_sync:
      $ref: "#/definitions/incremental_sync"
      cursor_field: date
    schema_loader:
      type: JsonFileSchemaLoader
      file_path: "./source_leadfeeder/schemas/visits.json"

streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/leads_stream"
  - "#/definitions/visits_stream"

check:
  type: CheckStream
  stream_names:
    - accounts

spec:
  type: Spec
  connection_specification:
    type: object
    $schema: http://json-schema.org/draft-07/schema#
    required:
      - api_token
      - start_date
    properties:
      api_token:
        type: string
        order: 0
        title: Api Token
        airbyte_secret: true
      start_date:
        type: string
        order: 1
        title: Start date
        format: date-time
        pattern: ^[0-9]{4}-[0-9]{2}-[0-9]{2}$
