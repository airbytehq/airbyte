version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []

  custom_selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["{{ parameters.extractorPath }}"]

  requester:
    type: HttpRequester
    url_base: "https://api.aptrinsic.com/v1/"
    http_method: "GET"
    authenticator:
      type: ApiKeyAuthenticator
      header: "X-APTRINSIC-API-KEY"
      api_token: "{{ config['api_key'] }}"

  retriever:
    type: SimpleRetriever
    paginator:
      type: "DefaultPaginator"
      pagination_strategy:
        type: "CursorPagination"
        cursor_value: "{{ last_records[-1]['scrollId'] }}"
        page_size: 5
      page_token_option:
        type: "RequestPath"
        field_name: "scrollId"
        inject_into: "request_parameter"
    requester:
      $ref: "#/definitions/requester"
    record_selector:
      $ref: "#/definitions/selector"

  custom_retriever:
    type: SimpleRetriever
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"
    record_selector:
      $ref: "#/definitions/custom_selector"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  accounts_stream:
    $parameters:
      path: "accounts"
      extractorPath: "accounts"
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/custom_retriever"
    name: "accounts"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Accounts Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          trackedSubscriptionId:
            type:
              - "null"
              - string
          sfdcId:
            type:
              - "null"
              - string
          lastSeenDate:
            type:
              - "null"
              - string
          dunsNumber:
            type:
              - "null"
              - string
          industry:
            type:
              - "null"
              - string
          numberOfEmployees:
            type:
              - "null"
              - string
          sicCode:
            type:
              - "null"
              - string
          website:
            type:
              - "null"
              - string
          naicsCode:
            type:
              - "null"
              - string
          plan:
            type:
              - "null"
              - string
          location:
            type:
              - "null"
              - string
          numberOfUsers:
            type:
              - "null"
              - string
          propertyKeys:
            type:
              - "null"
              - array
            items:
              location:
                type:
                  - "null"
                  - string
          createDate:
            type:
              - "null"
              - string
          lastModifiedDate:
            type:
              - "null"
              - string
          customAttributes:
            type:
              - "null"
              - object
            additionalProperties: true
          parentGroupId:
            type:
              - "null"
              - string
  admin_attributes_stream:
    $parameters:
      path: "admin/model/account/attributes"
    $ref: "#/definitions/base_stream"
    name: "admin_attributes"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: User Attributes Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          apiName:
            type:
              - "null"
              - string
          internalName:
            type:
              - "null"
              - string
          description:
            type:
              - "null"
              - string
          type:
            type:
              - "null"
              - string
          state:
            type:
              - "null"
              - string
          origin:
            type:
              - "null"
              - string
          createdDate:
            type:
              - "null"
              - number
          modifiedDate:
            type:
              - "null"
              - number
          defaultValue:
            type:
              - "null"
              - string
  articles_stream:
    $parameters:
      path: "articles"
      extractorPath: "articleExternalViewList"
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/custom_retriever"
    name: "articles"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Articles Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            type:
              - "null"
              - string
          modifiedBy:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              id:
                type:
                  - "null"
                  - string
              name:
                type:
                  - "null"
                  - string
          articleKCs:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - object
              additionalProperties: true
              properties:
                kcId:
                  type:
                    - "null"
                    - string
                kcName:
                  type:
                    - "null"
                    - string
          articleName:
            type:
              - "null"
              - string
          author:
            type:
              - "null"
              - string
          createdDate:
            type:
              - "null"
              - number
          modifiedDate:
            type:
              - "null"
              - number
          productId:
            type:
              - "null"
              - string
          productName:
            type:
              - "null"
              - string
          releaseDate:
            type:
              - "null"
              - string
          viewType:
            type:
              - "null"
              - string
  feature_stream:
    $parameters:
      path: "feature"
      extractorPath: "features"
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/custom_retriever"
    name: "feature"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Feature Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          type:
            type:
              - "null"
              - string
            enum:
              - FEATURE
              - MODULE
          parentFeatureId:
            type:
              - "null"
              - string
          propertyKey:
            type:
              - "null"
              - string
          status:
            type:
              - "null"
              - string
            enum:
              - ACTIVATED
              - DELETED
          featureLabels:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              id:
                type:
                  - "null"
                  - string
              name:
                type:
                  - "null"
                  - string
              color:
                type:
                  - "null"
                  - string
  segments_stream:
    $parameters:
      path: "segment"
      extractorPath: "segments"
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/custom_retriever"
    name: "segments"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Segment Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
  kcbot_stream:
    $parameters:
      path: "kcbot"
      extractorPath: "kcList"
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/custom_retriever"
    name: "kcbot"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: KCBot Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          createdBy:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              id:
                type:
                  - "null"
                  - string
              name:
                type:
                  - "null"
                  - string
          createdDate:
            type:
              - "null"
              - number
          description:
            type:
              - "null"
              - string
          environments:
            type:
              - "null"
              - array
            items:
              type:
                - "null"
                - string
          id:
            type:
              - "null"
              - string
          modifiedBy:
            additionalProperties: true
            type:
              - "null"
              - object
            properties:
              id:
                type:
                  - "null"
                  - string
              name:
                type:
                  - "null"
                  - string
          modifiedDate:
            type:
              - "null"
              - number
          name:
            type:
              - "null"
              - string
          priority:
            type:
              - "null"
              - number
          productId:
            type:
              - "null"
              - string
          productName:
            type:
              - "null"
              - string
          status:
            type:
              - "null"
              - string
  user_attributes_stream:
    $parameters:
      path: "admin/model/user/attributes"
    $ref: "#/definitions/base_stream"
    name: "user_attributes"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: User Attributes Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          id:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          apiName:
            type:
              - "null"
              - string
          internalName:
            type:
              - "null"
              - string
          description:
            type:
              - "null"
              - string
          type:
            type:
              - "null"
              - string
          state:
            type:
              - "null"
              - string
          origin:
            type:
              - "null"
              - string
          createdDate:
            type:
              - "null"
              - number
          modifiedDate:
            type:
              - "null"
              - number
          defaultValue:
            type:
              - "null"
              - string
  users_stream:
    $parameters:
      path: "users"
      extractorPath: "users"
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/custom_retriever"
    name: "users"
    primary_key: "id"

    schema_loader:
      type: InlineSchemaLoader
      schema:
        $schema: http://json-schema.org/draft-07/schema#
        title: Users Schema
        additionalProperties: true
        type:
          - "null"
          - object
        properties:
          aptrinsicId:
            type:
              - "null"
              - string
          identifyId:
            type:
              - "null"
              - string
          type:
            type:
              - "null"
              - string
            enum:
              - LEAD
              - USER
              - VISITOR
              - EMPTY_USER_TYPE
          gender:
            type:
              - "null"
              - string
            enum:
              - MALE
              - FEMALE
              - OTHER
              - EMPTY_GENDER
          email:
            type:
              - "null"
              - string
          firstName:
            type:
              - "null"
              - string
          lastName:
            type:
              - "null"
              - string
          lastSeenDate:
            type:
              - "null"
              - integer
            format: int64
          signUpDate:
            type:
              - "null"
              - integer
            format: int64
          firstVisitDate:
            type:
              - "null"
              - integer
            format: int64
          title:
            type:
              - "null"
              - string
          phone:
            type:
              - "null"
              - string
          score:
            type:
              - "null"
              - integer
            format: int64
          role:
            type:
              - "null"
              - string
          subscriptionId:
            type:
              - "null"
              - string
          accountId:
            type:
              - "null"
              - string
          numberOfVisits:
            type:
              - "null"
              - integer
            format: int32
          location:
            type:
              - "null"
              - string
          propertyKeys:
            type:
              - "null"
              - array
            description: Aptrinsic Tag Key, at least one is required
            items:
              type:
                - "null"
                - string
            examples:
              - - AP-XXXXXXXXXX-2
          createDate:
            type:
              - "null"
              - integer
            format: int64
          lastModifiedDate:
            type:
              - "null"
              - integer
            format: int64
          globalUnsubscribe:
            type:
              - "null"
              - boolean
          sfdcContactId:
            type:
              - "null"
              - string
          lastVisitedUserAgentData:
            type:
              - "null"
              - array
            items:
              propertyKey:
                type:
                  - "null"
                  - string
              userAgent:
                type:
                  - "null"
                  - object
                additionalProperties: true
                properties:
                  rawUserAgent:
                    type:
                      - "null"
                      - string
                  device:
                    type:
                      - "null"
                      - string
                  platformType:
                    type:
                      - "null"
                      - string
                  platformVersion:
                    type:
                      - "null"
                      - string
                  browserType:
                    type:
                      - "null"
                      - string
                  browserVersion:
                    type:
                      - "null"
                      - string
          id:
            type:
              - "null"
              - string
            description: Synonym for identifyId, output only, not filterable
          lastInferredLocation:
            type:
              - "null"
              - object
            additionalProperties: true
            properties:
              countryName:
                type:
                  - "null"
                  - string
              countryCode:
                type:
                  - "null"
                  - string
              stateName:
                type:
                  - "null"
                  - string
              stateCode:
                type:
                  - "null"
                  - string
              city:
                type:
                  - "null"
                  - string
              street:
                type:
                  - "null"
                  - string
              postalCode:
                type:
                  - "null"
                  - string
              continent:
                type:
                  - "null"
                  - string
              regionName:
                type:
                  - "null"
                  - string
              timeZone:
                type:
                  - "null"
                  - string
              coordinates:
                type:
                  - "null"
                  - object
                additionalProperties: true
                properties:
                  latitude:
                    type:
                      - "null"
                      - number
                  longitude:
                    type:
                      - "null"
                      - number
streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/admin_attributes_stream"
  - "#/definitions/articles_stream"
  - "#/definitions/feature_stream"
  - "#/definitions/segments_stream"
  - "#/definitions/kcbot_stream"
  - "#/definitions/user_attributes_stream"
  - "#/definitions/users_stream"

check:
  type: CheckStream
  stream_names:
    - "accounts"
    - "admin_attributes"
    - "articles"
    - "feature"
    - "segments"
    - "kcbot"
    - "user_attributes"
    - "users"
