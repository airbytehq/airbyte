version: "0.1.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["{{ parameters.data_field or parameters.name }}"]
  requester:
    type: HttpRequester
    url_base: "https://api.twilio.com/"
    http_method: "GET"
    authenticator:
      type: BasicHttpAuthenticator
      username: "{{ config.account_sid }}"
      password: "{{ config.auth_token }}"
    error_handler:
      type: "DefaultErrorHandler"
      backoff_strategies:
        - type: WaitTimeFromHeader
          # https://support.twilio.com/hc/en-us/articles/360032845014-Verify-V2-Rate-Limiting
          header: "Retry-After"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      pagination_strategy:
        type: CursorPagination
        cursor_value: "{{ response['next_page_uri'] }}"
        page_size: 1000
      page_size_option:
        inject_into: "request_parameter"
        field_name: "PageSize"
      page_token_option:
        type: RequestPath
    requester:
      $ref: "#/definitions/requester"
  boundary_request_parameters:
    "{{ parameters.lower_boundary_param }}": "{{ format_datetime(stream_slice.lower_boundary, parameters.boundary_format) }}"
    "{{ parameters.upper_boundary_param }}": "{{ format_datetime(stream_slice.upper_boundary, parameters.boundary_format) }}"
  datetime_slicer:
    type: DatetimeBasedCursor
    partition_field_start: "lower_boundary"
    partition_field_end: "upper_boundary"
    start_datetime:
      datetime: "{{ config.start_date }}"
      min_datetime: "{{ day_delta(-parameters.retention_window_limit, '%Y-%m-%dT%H:%M:%SZ') if parameters.retention_window_limit }}"
    end_datetime:
      datetime: "{{ now_utc().strftime('%Y-%m-%dT%H:%M:%SZ') }}"
    datetime_format: "%Y-%m-%dT%H:%M:%SZ"
    cursor_datetime_format: "%a, %d %b %Y %H:%M:%S %z"
    step: "{{ 'P' + config.slice_step_map[parameters.name]|string() + 'D' if config.slice_step_map and config.slice_step_map[parameters.name] else parameters.step_default }}"
    lookback_window: "{{ 'PT' + config.lookback_window|string() + 'M' if config.lookback_window else '' }}"
  datetime_transformation:
    type: AddFields
    fields:
      - path: ["date_created"]
        value: "{{ format_datetime(record.date_created, '%Y-%m-%dT%H:%M:%SZ') }}"
      - path: ["date_updated"]
        value: "{{ format_datetime(record.date_updated, '%Y-%m-%dT%H:%M:%SZ') }}"
  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  # https://www.twilio.com/docs/usage/api/account#read-multiple-account-resources
  accounts_stream:
    $ref: "#/definitions/base_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "accounts"
      path: "/2010-04-01/Accounts.json"
      data_field: null
      primary_key: "sid"
  # https://www.twilio.com/docs/studio/rest-api/flow#read-a-list-of-flows
  flows_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        url_base: "https://studio.twilio.com/"
    $parameters:
      name: "flows"
      path: "/v1/Flows"
      primary_key: "sid"
  accounts_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/accounts_stream"
        parent_key: "/"
        partition_field: "record"
  base_nested_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "{{ stream_slice.record.subresource_uris[parameters.subresource_uri_key or parameters.name] }}"
      partition_router:
        $ref: "#/definitions/accounts_partition_router"
  # https://www.twilio.com/docs/usage/api/address#read-multiple-address-resources
  addresses_stream:
    $ref: "#/definitions/base_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "addresses"
      primary_key: "sid"
  # https://www.twilio.com/docs/usage/api/applications#read-multiple-application-resources
  applications_stream:
    $ref: "#/definitions/base_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "applications"
      primary_key: "sid"
  # https://www.twilio.com/docs/phone-numbers/api/incomingphonenumber-resource#read-multiple-incomingphonenumber-resources
  incoming_phone_numbers_stream:
    $ref: "#/definitions/base_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "incoming_phone_numbers"
      primary_key: "sid"
  # https://www.twilio.com/docs/usage/api/keys#read-a-key-resource
  keys_stream:
    $ref: "#/definitions/base_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "keys"
      primary_key: "sid"
  # https://www.twilio.com/docs/voice/api/outgoing-caller-ids#outgoingcallerids-list-resource
  outgoing_caller_ids_stream:
    transformations:
      - "#/definitions/datetime_transformation"
    $ref: "#/definitions/base_nested_stream"
    $parameters:
      name: "outgoing_caller_ids"
      primary_key: "sid"
  # https://www.twilio.com/docs/voice/api/recording-transcription?code-sample=code-read-list-all-transcriptions&code-language=curl&code-sdk-version=json#read-multiple-transcription-resources
  transcriptions_stream:
    $ref: "#/definitions/base_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "transcriptions"
      primary_key: "sid"
  # https://www.twilio.com/docs/phone-numbers/api/availablephonenumber-resource#read-a-list-of-countries
  # List of available phone number countries, as well as local, mobile and toll free numbers
  # may be different on each request, so could not pass the full refresh tests.
  available_phone_number_countries_stream:
    $ref: "#/definitions/base_nested_stream"
    $parameters:
      name: "available_phone_number_countries"
      data_field: "countries"
      subresource_uri_key: "available_phone_numbers"
  # https://www.twilio.com/docs/voice/api/queue-resource#read-multiple-queue-resources
  queues_stream:
    $ref: "#/definitions/base_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "queues"
      primary_key: "sid"
  base_phone_number_countries_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "{{ stream_slice.path }}"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/available_phone_number_countries_stream"
            parent_key: "subresource_uris/{{ parameters.subresource_uri_key }}"
            partition_field: "path"
  # https://www.twilio.com/docs/phone-numbers/api/availablephonenumberlocal-resource#read-multiple-availablephonenumberlocal-resources
  available_phone_numbers_local_stream:
    $ref: "#/definitions/base_phone_number_countries_stream"
    $parameters:
      name: "available_phone_numbers_local"
      data_field: "available_phone_numbers"
      subresource_uri_key: "local"
  # https://www.twilio.com/docs/phone-numbers/api/availablephonenumber-mobile-resource#read-multiple-availablephonenumbermobile-resources
  available_phone_numbers_mobile_stream:
    $ref: "#/definitions/base_phone_number_countries_stream"
    $parameters:
      name: "available_phone_numbers_mobile"
      data_field: "available_phone_numbers"
      subresource_uri_key: "mobile"
  # https://www.twilio.com/docs/phone-numbers/api/availablephonenumber-tollfree-resource#read-multiple-availablephonenumbertollfree-resources
  available_phone_numbers_toll_free_stream:
    $ref: "#/definitions/base_phone_number_countries_stream"
    $parameters:
      name: "available_phone_numbers_toll_free"
      data_field: "available_phone_numbers"
      subresource_uri_key: "toll_free"
  base_incremental_nested_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "{{ stream_slice.record.subresource_uris[parameters.name] }}"
        request_parameters:
          $ref: "#/definitions/boundary_request_parameters"
    incremental_sync:
      type: CustomIncrementalSync
      class_name: source_twilio.components.NestedStateCartesianProductStreamSlicer
      stream_slicers:
        - $ref: "#/definitions/accounts_partition_router"
        - $ref: "#/definitions/datetime_slicer"
  # https://www.twilio.com/docs/voice/api/call-resource#read-multiple-call-resources
  calls_stream:
    $ref: "#/definitions/base_incremental_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
      - type: AddFields
        fields:
          - path: ["start_time"]
            value: "{{ format_datetime(record.start_time, '%Y-%m-%dT%H:%M:%SZ') }}"
          - path: ["end_time"]
            value: "{{ format_datetime(record.end_time, '%Y-%m-%dT%H:%M:%SZ') }}"
    $parameters:
      name: "calls"
      cursor_field: "end_time"
      lower_boundary_param: "EndTime>"
      upper_boundary_param: "EndTime<"
      boundary_format: "%Y-%m-%d"
      cursor_granularity: "P1D"
      step_default: "P1Y"
      primary_key: "sid"
  # https://www.twilio.com/docs/voice/api/conference-resource#read-multiple-conference-resources
  conferences_stream:
    $ref: "#/definitions/base_incremental_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "conferences"
      data_field: null
      cursor_field: "date_updated"
      lower_boundary_param: "DateUpdated>"
      upper_boundary_param: "DateUpdated<"
      boundary_format: "%Y-%m-%d"
      cursor_granularity: "P1D"
      step_default: "P1Y"
      primary_key: "sid"
  # https://www.twilio.com/docs/sms/api/message-resource#read-multiple-message-resources
  messages_stream:
    $ref: "#/definitions/base_incremental_nested_stream"
    retriever:
      $ref: "#/definitions/base_incremental_nested_stream/retriever"
      record_selector:
        $ref: "#/definitions/selector"
        record_filter:
          condition: "{{ not parameters.with_media_only or record.num_media|int() > 0 }}"
    transformations:
      - "#/definitions/datetime_transformation"
      - type: AddFields
        fields:
          - path: ["date_sent"]
            value: "{{ format_datetime(record.date_sent, '%Y-%m-%dT%H:%M:%SZ') }}"
    $parameters:
      name: "messages"
      data_field: null
      cursor_field: "date_sent"
      lower_boundary_param: "DateSent>"
      upper_boundary_param: "DateSent<"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      cursor_granularity: "PT0S"
      step_default: "P1D"
      primary_key: "sid"
      retention_window_limit: 399
  # https://www.twilio.com/docs/voice/api/recording#read-multiple-recording-resources
  recordings_stream:
    $ref: "#/definitions/base_incremental_nested_stream"
    transformations:
      - "#/definitions/datetime_transformation"
      - type: AddFields
        fields:
          - path: ["start_time"]
            value: "{{ format_datetime(record.start_time, '%Y-%m-%dT%H:%M:%SZ') }}"
    $parameters:
      name: "recordings"
      cursor_field: "date_created"
      lower_boundary_param: "DateCreated>"
      upper_boundary_param: "DateCreated<"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      cursor_granularity: "PT0S"
      step_default: "P1Y"
      primary_key: "sid"
  # https://www.twilio.com/docs/usage/monitor-alert#read-multiple-alert-resources
  alerts_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        url_base: "https://monitor.twilio.com/"
        path: "/v1/Alerts"
        request_parameters:
          $ref: "#/definitions/boundary_request_parameters"
    incremental_sync:
      $ref: "#/definitions/datetime_slicer"
    transformations:
      - "#/definitions/datetime_transformation"
      - type: AddFields
        fields:
          - path: ["date_generated"]
            value: "{{ format_datetime(record.date_generated, '%Y-%m-%dT%H:%M:%SZ') }}"
    $parameters:
      name: "alerts"
      cursor_field: "date_generated"
      lower_boundary_param: "StartDate"
      upper_boundary_param: "EndDate"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      cursor_granularity: "PT0S"
      step_default: "P1Y"
      primary_key: "sid"
  # https://www.twilio.com/docs/usage/api/usage-record#read-multiple-usagerecord-resources
  usage_records_stream:
    $ref: "#/definitions/base_incremental_nested_stream"
    retriever:
      $ref: "#/definitions/base_incremental_nested_stream/retriever"
      requester:
        $ref: "#/definitions/base_incremental_nested_stream/retriever/requester"
        path: "/2010-04-01/Accounts/{{ stream_slice.record.sid }}/Usage/Records/Daily.json"
    incremental_sync:
      type: CustomIncrementalSync
      class_name: source_twilio.components.NestedStateCartesianProductStreamSlicer
      stream_slicers:
        - $ref: "#/definitions/accounts_partition_router"
        - $ref: "#/definitions/datetime_slicer"
          start_datetime:
            datetime: "{{ format_datetime(config.start_date, '%Y-%m-%d') }}"
          end_datetime:
            datetime: "{{ today_utc() }}"
          datetime_format: "%Y-%m-%d"
          cursor_datetime_format: ""
    $parameters:
      name: "usage_records"
      cursor_field: "start_date"
      lower_boundary_param: "StartDate"
      upper_boundary_param: "EndDate"
      boundary_format: "%Y-%m-%d"
      cursor_granularity: "P1D"
      step_default: "P1Y"
      primary_key: ["account_sid", "category", "start_date"]
  # https://www.twilio.com/docs/usage/api/usage-trigger#read-multiple-usagetrigger-resources
  usage_triggers_stream:
    $ref: "#/definitions/base_nested_stream"
    retriever:
      $ref: "#/definitions/base_nested_stream/retriever"
      requester:
        $ref: "#/definitions/base_nested_stream/retriever/requester"
        path: "/2010-04-01/Accounts/{{ stream_slice.record.sid }}/Usage/Triggers.json"
    transformations:
      - "#/definitions/datetime_transformation"
      - type: AddFields
        fields:
          - path: ["date_fired"]
            value: "{{ format_datetime(record.date_fired, '%Y-%m-%dT%H:%M:%SZ') if record.date_fired else record.date_fired }}"
    $parameters:
      name: "usage_triggers"
      primary_key: "sid"
  # https://www.twilio.com/docs/voice/api/conference-participant-resource#read-multiple-participant-resources
  # This streams has records only if there are active conference participants (participants, which are on conference call at the moment request is made).
  conference_participants_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "{{ stream_slice.record.subresource_uris[parameters.subresource_uri_key] }}"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/conferences_stream"
            parent_key: "/"
            partition_field: "record"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "conference_participants"
      primary_key: ["account_sid", "conference_sid"]
      data_field: "participants"
      subresource_uri_key: "participants"
  # https://www.twilio.com/docs/usage/api/address?code-sample=code-list-dependent-pns-subresources&code-language=curl&code-sdk-version=json#list-dependent-pns
  dependent_phone_numbers_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        path: "/2010-04-01/Accounts/{{ stream_slice.record.account_sid }}/Addresses/{{ stream_slice.record.sid }}/DependentPhoneNumbers.json"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/addresses_stream"
            parent_key: "/"
            partition_field: "record"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "dependent_phone_numbers"
      primary_key: "sid"
  # https://www.twilio.com/docs/sms/api/media-resource#read-multiple-media-resources
  message_media_stream:
    $ref: "#/definitions/base_incremental_nested_stream"
    retriever:
      $ref: "#/definitions/base_incremental_nested_stream/retriever"
      requester:
        $ref: "#/definitions/base_incremental_nested_stream/retriever/requester"
        path: "{{ stream_slice.record.subresource_uris.media }}"
    incremental_sync:
      type: CustomIncrementalSync
      class_name: source_twilio.components.NestedStateCartesianProductStreamSlicer
      stream_slicers:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/messages_stream"
              parent_key: "/"
              partition_field: "record"
        - $ref: "#/definitions/datetime_slicer"
    transformations:
      - "#/definitions/datetime_transformation"
    $parameters:
      name: "message_media"
      primary_key: "sid"
      data_field: "media_list"
      lower_boundary_param: "DateCreated>"
      upper_boundary_param: "DateCreated<"
      cursor_field: "date_created"
      cursor_granularity: "PT0S"
      step_default: "P1Y"
      boundary_format: "%Y-%m-%dT%H:%M:%SZ"
      with_media_only: true
      retention_window_limit: 399


streams:
  - "#/definitions/accounts_stream"
  - "#/definitions/flows_stream"
  - "#/definitions/addresses_stream"
  - "#/definitions/applications_stream"
  - "#/definitions/incoming_phone_numbers_stream"
  - "#/definitions/keys_stream"
  - "#/definitions/outgoing_caller_ids_stream"
  - "#/definitions/transcriptions_stream"
  - "#/definitions/available_phone_number_countries_stream"
  - "#/definitions/queues_stream"
  - "#/definitions/available_phone_numbers_local_stream"
  - "#/definitions/available_phone_numbers_mobile_stream"
  - "#/definitions/available_phone_numbers_toll_free_stream"
  - "#/definitions/calls_stream"
  - "#/definitions/conferences_stream"
  - "#/definitions/messages_stream"
  - "#/definitions/recordings_stream"
  - "#/definitions/alerts_stream"
  - "#/definitions/usage_records_stream"
  - "#/definitions/usage_triggers_stream"
  - "#/definitions/conference_participants_stream"
  - "#/definitions/dependent_phone_numbers_stream"
  - "#/definitions/message_media_stream"

check:
  stream_names:
    - "accounts"
