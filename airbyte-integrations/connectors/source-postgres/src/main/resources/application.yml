---
airbyte:
  connector:
    data-channel:
      medium: ${DATA_CHANNEL_MEDIUM:STDIO}
      format: ${DATA_CHANNEL_FORMAT:JSONL}
      socket-paths: ${DATA_CHANNEL_SOCKET_PATHS}
    output:
      buffer-byte-size-threshold-for-flush: 8192
    extract:
      jdbc:
        mode: concurrent
        with-sampling: true
        table-sample-size: 1024
        throughput-bytes-per-second: 10000000
        min-fetch-size: 10
        default-fetch-size: 1024
        max-fetch-size: 1000000000
        memory-capacity-ratio: 0.3
        estimated-record-overhead-bytes: 16
        estimated-field-overhead-bytes: 16
        namespace-kind: SCHEMA
        include-pseudo-columns: false
    check:
      jdbc:
        queries:
          - >-
            SELECT 1 WHERE false;

    exception-classifiers:
      regex:
        # The following rules are for the RegexExceptionClassifier [0] which are applied
        # sequentially on a Throwable's message [1] and its nested messages by cause [2].
        #
        # This classifier's rules are applied ahead of the JdbcExceptionClassifier's further down.
        #
        # [0] https://github.com/airbytehq/airbyte/blob/master/airbyte-cdk/bulk/core/base/src/main/kotlin/io/airbyte/cdk/output/ExceptionClassifier.kt
        # [1] https://docs.oracle.com/javase/8/docs/api/java/lang/Throwable.html#getMessage--
        # [2] https://docs.oracle.com/javase/8/docs/api/java/lang/Throwable.html#getCause--

        rules:
          ## REGEX RULE TEMPLATE:
          # pattern: Required; regex pattern, c.f. https://www.freeformatter.com/java-regex-tester.html.
          #          Note that regex patterns are not case-sensitive and are multiline.
          # input-example: Required, string matching regex pattern.
          # error: Required, one of (transient|config|system).
          # group: Optional, string prefixing user-facing error message.
          # output: Optional, user-facing error message; when not set, the exception message is used instead.
          # reference-links: Optional, list of URLs appended to user-facing message after a newline.

          - pattern: (?i).*temporary file size exceeds temp_file_limit.*
            input-example: "org.postgresql.util.PSQLException: ERROR: temporary file size exceeds temp_file_limit"
            error: transient
            group: Postgres SQL Exception
            output: Encountered an error while reading the database, will retry.
            reference-links: https://github.com/airbytehq/airbyte/issues/27090
              https://github.com/airbytehq/oncall/issues/1822

          - pattern: (?i).*an i/o error occured while sending to the backend.*
            input-example: "org.postgresql.util.PSQLException: An I/O error occurred while sending to the backend."
            error: transient
            group: Postgres SQL Exception
            output: Encountered an error while reading the database, will retry.

          - pattern: (?i).*due to conflict with recovery.*
            input-example: |
              ERROR: canceling statement due to conflict with recovery.
              org.postgresql.util.PSQLException: FATAL: terminating connection due to conflict with recovery
            error: transient
            group: Postgres Query Conflicts
            output: Database connection failed due to conflict with recovery. Will retry.
            reference-links: https://github.com/airbytehq/oncall/issues/6296

          - pattern: (?i).*permission denied for table.*
            input-example: "java.lang.RuntimeException: org.postgresql.util.PSQLException: ERROR: permission denied for table xxx."
            error: config
            group: Postgres SQL Exception
            output: Database read failed due to missing read permissions on a table. See the detailed error for the table name and update permissions accordingly.
            reference-links: https://github.com/airbytehq/airbyte/issues/41614

          - pattern: (?i).*canceling statement due to statement timeout.*
            input-example: "org.postgresql.util.PSQLException: ERROR: canceling statement due to statement timeout"
            error: transient
            group: Postgres SQL Exception
            output: Database read failed due SQL statement timeout, will retry.
            reference-links: https://github.com/airbytehq/airbyte/issues/41614

          - pattern: (?i).*connection is not available, request timed out after*
            input-example: "java.sql.SQLTransientConnectionException: HikariPool-x - Connection is not available, request timed out after xms"
            error: transient
            group: Postgres Hikari Connection Error
            output: Database read failed due to connection timeout, will retry.
            reference-links: https://github.com/airbytehq/airbyte/issues/41614
              https://github.com/airbytehq/oncall/issues/5346

          - pattern: (?i).*timed out after [1-9]\d* msec*
            input-example: "java.util.concurrent.TimeoutException: Timed out after 15000 msec"
            error: transient
            group: Postgres connection timeout
            output: Database connection timeout, will retry.
            reference-links: https://github.com/airbytehq/oncall/issues/5381

          - pattern: (?i).*SocketException.*(broken pipe|socket is closed).*
            input-example: |
              java.net.SocketException: Broken pipe
              java.net.SocketException: Socket is closed
            error: transient
            group: Postgres Debezium Connection Error
            output: Database connection error when performing CDC reads, will retry.
            reference-links: https://github.com/airbytehq/oncall/issues/5321
              https://github.com/airbytehq/oncall/issues/5293
              https://github.com/airbytehq/oncall/issues/5750

          - pattern: .*cannot read from logical replication slot.*
            input-example: 'org.postgresql.util.PSQLException: ERROR: cannot read from logical replication slot "airbyte_slot"'
            error: config
            group: Postgres Debezium Connection Error
            output: The configured replication slot has been dropped or has corrupted. Please recreate the replication slot.
            reference-links: https://github.com/airbytehq/oncall/issues/5981

          - pattern: (?i).*This connection has been closed.*
            input-example: "org.postgresql.util.PSQLException: This connection has been closed."
            error: transient
            group: Postgres SQL Exception
            output: The connection to the Postgres server was unexpectedly closed, will retry.
            reference-links: https://github.com/airbytehq/oncall/issues/7016

          - pattern: (?i).*Connection or outbound has closed.*
            input-example: "java.net.SocketException: Connection or outbound has closed"
            error: transient
            group: Postgres Debezium Connection Error
            output: The connection to the Postgres server was lost, will retry.
            reference-links: https://github.com/airbytehq/oncall/issues/5871

          - pattern: (?i).*recovery is in progress.*
            input-example: "org.postgresql.util.PSQLException: ERROR: recovery is in progress"
            error: transient
            group: Postgres SQL Exception
            output: Postgres server is currently in recovery mode, will retry.
            reference-links: https://github.com/airbytehq/oncall/issues/6033

          - pattern: (?i).*terminating connection due to idle-in-transaction timeout.*
            input-example: "org.postgresql.util.PSQLException: FATAL: terminating connection due to idle-in-transaction timeout"
            error: config
            group: Postgres SQL Exception
            output: Postgres server closed the connection due to an idle-in-transaction timeout. Please review your server's timeout configuration and increase the timeout if needed
            reference-links: https://github.com/airbytehq/oncall/issues/5893

          - pattern: (?i).*An exception occurred in the change event producer. This connector will be stopped.*
            input-example: |
              io.airbyte.cdk.integrations.source.relationaldb.state.FailedRecordIteratorException: java.lang.RuntimeException:
              java.lang.RuntimeException: org.apache.kafka.connect.errors.ConnectException:
              An exception occurred in the change event producer. This connector will be stopped.
            error: transient
            group: Postgres Debezium Connection Error
            output: The sync encountered an unexpected error in the change event producer and has stopped. Please check the logs for details and troubleshoot accordingly.
            reference-links: https://github.com/airbytehq/airbyte/issues/41614

      jdbc:
        # The following rules are for the JdbcExceptionClassifier [0] which are applied on a
        # Postgres error code [1]. The vendor error code is printed in the exception
        # message, and is not to be confused with the SQLState [2] which is also in the message.
        #
        # [0] https://github.com/airbytehq/airbyte/blob/master/airbyte-cdk/bulk/toolkits/extract-jdbc/src/main/kotlin/io/airbyte/cdk/output/JdbcExceptionClassifier.kt
        # [1] https://www.postgresql.org/docs/current/errcodes-appendix.html
        # [2] https://en.wikipedia.org/wiki/SQLSTATE
        #
        rules:
          ## JDBC RULE TEMPLATE
          # code: Required, Postgres vendor error code.
          # error: Required, one of (transient|config|system).
          # output: Optional, user-facing error message; the exception message is used instead when this is not defined.
          # reference-links: Optional, list of URLs appended to user-facing message after newline.
