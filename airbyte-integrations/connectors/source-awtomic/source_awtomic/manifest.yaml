version: 0.57.0

definitions:

  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path:
        - Items

  requester:
    type: HttpRequester
    url_base: https://api.awtomic.com/
    path: subscriptions
    http_method: GET
    request_parameters: {}
    request_headers: {}
    authenticator:
      type: ApiKeyAuthenticator
      api_token: '{{ config[''api_key''] }}'
      inject_into:
        type: RequestOption
        field_name: x-api-key
        inject_into: header
    request_body_json: {}

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      page_token_option:
        type: RequestOption
        inject_into: request_parameter
        field_name: lastEvaluatedKey
      page_size_option:
        type: RequestOption
        field_name: limit
        inject_into: request_parameter
      pagination_strategy:
        class_name: "source_awtomic.page_increment_strategy.LastEvaluatedKeyPaginationStrategy"
        type: "CustomPaginationStrategy"
        page_size: 100
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  subscriptions_stream:
    $ref: "#/definitions/base_stream"
    name: Subscriptions
    primary_key:
      - SubscriptionId
      
  subscriptions_contract_stream:
    name: "subscription_contract"
    primary_key:
      - SubscriptionId
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        type: HttpRequester
        url_base: https://api.awtomic.com/
        path: subscriptions
        http_method: GET
        request_parameters: {'expandLines':'true'}
        request_headers: {}
        authenticator:
          type: ApiKeyAuthenticator
          api_token: '{{ config[''api_key''] }}'
          inject_into:
            type: RequestOption
            field_name: x-api-key
            inject_into: header
        request_body_json: {}
        path: "customers/{{ stream_slice.customer_id[22:] }}/subscriptions"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - stream: "#/definitions/subscriptions_stream"
            parent_key:  "CustomerId"
            partition_field: "customer_id"

streams:
  - "#/definitions/subscriptions_stream"
  - "#/definitions/subscriptions_contract_stream"

check:
  type: CheckStream
  stream_names:
    - "Subscriptions"

spec:
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    type: object
    required:
      - api_key
    properties:
      api_key:
        type: string
        title: API Key
        airbyte_secret: true
        order: 0
    additionalProperties: true
  type: Spec
metadata:
  autoImportSchema:
    Subscriptions: true
