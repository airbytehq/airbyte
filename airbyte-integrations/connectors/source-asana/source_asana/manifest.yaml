version: "0.78.5"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["data"]

  oauth_authenticator:
    type: OAuthAuthenticator
    client_id: "{{ config['credentials']['client_id'] }}"
    client_secret: "{{ config['credentials']['client_secret'] }}"
    refresh_token: "{{ config['credentials']['refresh_token'] }}"
    token_refresh_endpoint: "https://app.asana.com/-/oauth_token"
    grant_type: refresh_token
    access_token_name: access_token

  pat_authenticator:
    type: "BearerAuthenticator"
    api_token: "{{ config['credentials']['personal_access_token'] }}"

  selective_authenticator:
    type: SelectiveAuthenticator
    authenticator_selection_path: ["credentials", "option_title"]
    authenticators:
      "OAuth Credentials": "#/definitions/oauth_authenticator"
      "PAT Credentials": "#/definitions/pat_authenticator"

  requester:
    type: CustomRequester
    class_name: source_asana.components.AsanaHttpRequester
    url_base: https://app.asana.com/api/1.0/
    http_method: GET
    authenticator:
      $ref: "#/definitions/selective_authenticator"
    error_handler:
      type: DefaultErrorHandler
      backoff_strategies:
        - type: "WaitTimeFromHeader"
          header: "Retry-After"
      response_filters:
        - type: HttpResponseFilter
          action: IGNORE
          http_codes:
            - 403
            - 402
            - 404
            - 412
            - 451

  token_paginator_base:
    type: DefaultPaginator
    page_token_option:
      type: "RequestPath"
      field_name: "sync"
      inject_into: "request_parameter"
    pagination_strategy:
      type: CursorPagination
      cursor_value: '{{ response.get("sync", {}) }}'
      stop_condition: '{{ not response.get("sync", {}) }}'

  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: DefaultPaginator
      page_token_option:
        type: RequestOption
        inject_into: request_parameter
        field_name: offset
      page_size_option:
        type: RequestOption
        field_name: limit
        inject_into: request_parameter
      pagination_strategy:
        type: CursorPagination
        page_size: 100
        cursor_value: '{{ response.get("next_page", {}).get("offset", "") }}'
        stop_condition: '{{ not response.get("next_page", {}) }}'
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    primary_key: "gid"
    retriever:
      $ref: "#/definitions/retriever"

  projects_stream:
    $ref: "#/definitions/base_stream"
    name: "projects"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/projects_schema"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        use_cache: true
        request_parameters:
          workspace: "{{ stream_slice['workspace_gid'] }}"
      partition_router:
        $ref: "#/definitions/workspaces_partition_router"
    $parameters:
      path: "/projects"

  projects_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/projects_stream"
        parent_key: "gid"
        partition_field: "project_id"

  sections_compact_stream:
    $ref: "#/definitions/base_stream"
    name: "sections_compact"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/sections_compact_schema"
    $parameters:
      path: "/projects/{{ stream_slice['project_id'] }}/sections"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        use_cache: true
      partition_router:
        $ref: "#/definitions/projects_partition_router"

  sections_compact_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/sections_compact_stream"
        parent_key: "gid"
        partition_field: "section_gid"

  sections_stream:
    $ref: "#/definitions/base_stream"
    name: "sections"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/sections_schema"
    $parameters:
      path: "/sections/{{ stream_slice['section_gid'] }}"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/sections_compact_partition_router"

  tasks_stream:
    $ref: "#/definitions/base_stream"
    name: "tasks"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/tasks_schema"
    $parameters:
      path: "/tasks"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        use_cache: true
        request_parameters:
          project: "{{ stream_slice.project_id }}"
      partition_router:
        $ref: "#/definitions/projects_partition_router"

  tasks_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/tasks_stream"
        parent_key: "gid"
        partition_field: "task_gid"

  stories_compact_stream:
    $ref: "#/definitions/base_stream"
    name: "stories_compact"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/stories_compact_schema"
    $parameters:
      path: "/tasks/{{ stream_slice['task_gid'] }}/stories"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        use_cache: true
      partition_router:
        $ref: "#/definitions/tasks_partition_router"

  stories_compact_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/stories_compact_stream"
        parent_key: "gid"
        partition_field: "story_gid"

  stories_stream:
    $ref: "#/definitions/base_stream"
    name: "stories"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/stories_schema"
    $parameters:
      path: "/stories/{{ stream_slice['story_gid'] }}"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/stories_compact_partition_router"

  workspaces_stream:
    $ref: "#/definitions/base_stream"
    name: "workspaces"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/workspaces_schema"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        use_cache: true
    $parameters:
      path: "/workspaces"

  workspaces_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/workspaces_stream"
        parent_key: "gid"
        partition_field: "workspace_gid"

  tags_stream:
    $ref: "#/definitions/base_stream"
    name: "tags"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/tags_schema"
    $parameters:
      path: "/tags"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          workspace: "{{ stream_slice.workspace_gid }}"
      partition_router:
        $ref: "#/definitions/workspaces_partition_router"

  users_stream:
    $ref: "#/definitions/base_stream"
    name: "users"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/users_schema"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          workspace: "{{ stream_slice.workspace_gid }}"
      partition_router:
        $ref: "#/definitions/workspaces_partition_router"
    $parameters:
      path: "/users"

  teams_stream:
    $ref: "#/definitions/base_stream"
    name: "teams"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/teams_schema"
    $parameters:
      path: "/organizations/{{ stream_slice['workspace_gid'] }}/teams"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/workspaces_partition_router"

  teams_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/teams_stream"
        parent_key: "gid"
        partition_field: "team_gid"

  team_memberships_stream:
    $ref: "#/definitions/base_stream"
    name: "team_memberships"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/team_memberships_schema"
    $parameters:
      path: "/teams/{{ stream_slice['team_gid'] }}/team_memberships"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/teams_partition_router"

  attachments_compact_stream:
    $ref: "#/definitions/base_stream"
    name: "attachments_compact"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/attachments_compact_schema"
    $parameters:
      path: "/attachments"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        use_cache: true
        request_parameters:
          parent: "{{ stream_slice.parent_gid }}"
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/projects_stream"
              parent_key: "gid"
              partition_field: "parent_gid"
            - stream: "#/definitions/tasks_stream"
              parent_key: "gid"
              partition_field: "parent_gid"

  attachments_compact_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/attachments_compact_stream"
        parent_key: "gid"
        partition_field: "attachments_gid"

  attachments_stream:
    $ref: "#/definitions/base_stream"
    name: "attachments"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/attachments_schema"
    $parameters:
      path: "/attachments/{{ stream_slice['attachments_gid'] }}"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/attachments_compact_partition_router"

  portfolios_compact_stream:
    $ref: "#/definitions/base_stream"
    name: "portfolios_compact"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/portfolios_compact_schema"
    $parameters:
      path: "/portfolios"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          owner: "{{ stream_slice['users_gid'] }}"
          workspace: "{{ stream_slice['workspace_gid'] }}"
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/workspaces_stream"
              parent_key: "gid"
              partition_field: "workspace_gid"
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/users_stream"
              parent_key: "gid"
              partition_field: "users_gid"

  portfolios_compact_partition_router:
    type: SubstreamPartitionRouter
    parent_stream_configs:
      - stream: "#/definitions/portfolios_compact_stream"
        parent_key: "gid"
        partition_field: "portfolios_gid"

  portfolios_stream:
    $ref: "#/definitions/base_stream"
    name: "portfolios"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/portfolios_schema"
    $parameters:
      path: "/portfolios/{{ stream_slice['portfolios_gid'] }}"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/portfolios_compact_partition_router"

  portfolios_memberships_stream:
    $ref: "#/definitions/base_stream"
    name: "portfolios_memberships"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/portfolios_memberships_schema"
    $parameters:
      path: "/portfolio_memberships"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          portfolio: "{{ stream_slice['portfolios_gid'] }}"
      partition_router:
        $ref: "#/definitions/portfolios_compact_partition_router"

  custom_fields_stream:
    $ref: "#/definitions/base_stream"
    name: "custom_fields"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/custom_fields_schema"
    $parameters:
      path: "/workspaces/{{ stream_slice['workspace_gid'] }}/custom_fields"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        $ref: "#/definitions/workspaces_partition_router"

  organization_exports_stream:
    $ref: "#/definitions/base_stream"
    name: "organization_exports"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/organization_exports_schema"
    $parameters:
      path: "/organization_exports/{{ stream_slice.gid }}"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        - type: ListPartitionRouter
          values: "{{ config['organization_export_ids' ] }}"
          cursor_field: gid

  events_stream:
    $ref: "#/definitions/base_stream"
    name: "events"
    primary_key: "created_at"
    schema_loader:
      type: InlineSchemaLoader
      schema:
        $ref: "#/definitions/events_schema"
    $parameters:
      path: "/events"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/token_paginator_base"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          resource: "{{ stream_slice.parent_gid }}"
      partition_router:
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/tasks_stream"
              parent_key: "gid"
              partition_field: "parent_gid"
        - type: SubstreamPartitionRouter
          parent_stream_configs:
            - stream: "#/definitions/projects_stream"
              parent_key: "gid"
              partition_field: "parent_gid"

  projects_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      archived:
        type:
          - "null"
          - boolean
      color:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      current_status:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          title:
            type:
              - "null"
              - string
          author:
            type:
              - "null"
              - object
            properties:
              gid:
                type:
                  - "null"
                  - string
              resource_type:
                type:
                  - "null"
                  - string
              name:
                type:
                  - "null"
                  - string
          color:
            type:
              - "null"
              - string
          html_text:
            type:
              - "null"
              - string
          modified_at:
            type:
              - "null"
              - string
            format: date-time
          text:
            type:
              - "null"
              - string
          created_at:
            type:
              - "null"
              - string
            format: date-time
          created_by:
            type:
              - "null"
              - object
            properties:
              gid:
                type:
                  - "null"
                  - string
              resource_type:
                type:
                  - "null"
                  - string
              name:
                type:
                  - "null"
                  - string
      custom_field_settings:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
      default_view:
        type:
          - "null"
          - string
      due_date:
        type:
          - "null"
          - string
        format: date
      due_on:
        type:
          - "null"
          - string
        format: date
      html_notes:
        type:
          - "null"
          - string
      is_template:
        type:
          - "null"
          - boolean
      members:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string
      modified_at:
        type:
          - "null"
          - string
        format: date-time
      notes:
        type:
          - "null"
          - string
      public:
        type:
          - "null"
          - boolean
      start_on:
        type:
          - "null"
          - string
        format: date
      workspace:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      custom_fields:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            display_value:
              type:
                - "null"
                - string
            enabled:
              type:
                - "null"
                - boolean
            enum_options:
              type:
                - "null"
                - array
              items:
                type:
                  - "null"
                  - object
                properties:
                  gid:
                    type:
                      - "null"
                      - string
                  resource_type:
                    type:
                      - "null"
                      - string
                  color:
                    type:
                      - "null"
                      - string
                  enabled:
                    type:
                      - "null"
                      - boolean
                  name:
                    type:
                      - "null"
                      - string
            name:
              type:
                - "null"
                - string
            number_value:
              type:
                - "null"
                - number
            resource_subtype:
              type:
                - "null"
                - string
            text_value:
              type:
                - "null"
                - boolean
            type:
              type:
                - "null"
                - string
      followers:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string
      icon:
        type:
          - "null"
          - string
      owner:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      permalink_url:
        type:
          - "null"
          - string
      team:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  sections_compact_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string

  sections_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      project:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  tasks_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      approval_status:
        type:
          - "null"
          - string
      completed:
        type:
          - "null"
          - boolean
      completed_at:
        type:
          - "null"
          - string
        format: date-time
      completed_by:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      dependencies:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
      dependents:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
      due_at:
        type:
          - "null"
          - string
        format: date-time
      due_on:
        type:
          - "null"
          - string
        format: date
      external:
        type:
          - "null"
          - object
        properties:
          data:
            type:
              - "null"
              - string
          gid:
            type:
              - "null"
              - string
      hearted:
        type:
          - "null"
          - boolean
      hearts:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            user:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
      html_notes:
        type:
          - "null"
          - string
      is_rendered_as_separator:
        type:
          - "null"
          - boolean
      liked:
        type:
          - "null"
          - boolean
      likes:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            user:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
      memberships:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            project:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
            section:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
      modified_at:
        type:
          - "null"
          - string
        format: date-time
      notes:
        type:
          - "null"
          - string
      num_hearts:
        type:
          - "null"
          - integer
      num_likes:
        type:
          - "null"
          - integer
      num_subtasks:
        type:
          - "null"
          - integer
      resource_subtype:
        type:
          - "null"
          - string
      start_on:
        type:
          - "null"
          - string
        format: date
      assignee:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      custom_fields:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            created_by:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
            currency_code:
              type:
                - "null"
                - string
            custom_label:
              type:
                - "null"
                - string
            custom_label_position:
              type:
                - "null"
                - string
            description:
              type:
                - "null"
                - string
            display_value:
              type:
                - "null"
                - string
            enabled:
              type:
                - "null"
                - boolean
            enum_options:
              type:
                - "null"
                - array
              items:
                type:
                  - "null"
                  - object
                properties:
                  gid:
                    type:
                      - "null"
                      - string
                  resource_type:
                    type:
                      - "null"
                      - string
                  color:
                    type:
                      - "null"
                      - string
                  enabled:
                    type:
                      - "null"
                      - boolean
                  name:
                    type:
                      - "null"
                      - string
            enum_value:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                color:
                  type:
                    - "null"
                    - string
                enabled:
                  type:
                    - "null"
                    - boolean
                name:
                  type:
                    - "null"
                    - string
            format:
              type:
                - "null"
                - string
            has_notifications_enabled:
              type:
                - "null"
                - boolean
            is_global_to_workspace:
              type:
                - "null"
                - boolean
            name:
              type:
                - "null"
                - string
            number_value:
              type:
                - "null"
                - number
            precision:
              type:
                - "null"
                - integer
            resource_subtype:
              type:
                - "null"
                - string
            text_value:
              type:
                - "null"
                - string
            type:
              type:
                - "null"
                - string
      followers:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string
      parent:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      permalink_url:
        type:
          - "null"
          - string
      projects:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string
      tags:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string
      workspace:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  stories_compact_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      created_by:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      resource_subtype:
        type:
          - "null"
          - string
      text:
        type:
          - "null"
          - string
      type:
        type:
          - "null"
          - string
      task:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          resource_subtype:
            type:
              - "null"
              - string
      target:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          resource_subtype:
            type:
              - "null"
              - string

  stories_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      created_by:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      resource_subtype:
        type:
          - "null"
          - string
      text:
        type:
          - "null"
          - string
      type:
        type:
          - "null"
          - string
      html_text:
        type:
          - "null"
          - string
      is_pinned:
        type:
          - "null"
          - boolean
      sticker_name:
        type:
          - "null"
          - string
      is_editable:
        type:
          - "null"
          - boolean
      is_edited:
        type:
          - "null"
          - boolean
      liked:
        type:
          - "null"
          - boolean
      likes:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            user:
              type:
                - "null"
                - object
              properties:
                gid:
                  type:
                    - "null"
                    - string
                resource_type:
                  type:
                    - "null"
                    - string
                name:
                  type:
                    - "null"
                    - string
      num_likes:
        type:
          - "null"
          - integer
      task:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          resource_subtype:
            type:
              - "null"
              - string

  workspaces_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      email_domains:
        type:
          - "null"
          - array
        items:
          type: string
      is_organization:
        type:
          - "null"
          - boolean

  tags_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      color:
        type:
          - "null"
          - string
      followers:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string
      name:
        type:
          - "null"
          - string
      permalink_url:
        type:
          - "null"
          - string
      workspace:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  users_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      email:
        type:
          - "null"
          - string
      photo:
        type:
          - "null"
          - object
        properties:
          image_128x128:
            type:
              - "null"
              - string
          image_21x21:
            type:
              - "null"
              - string
          image_27x27:
            type:
              - "null"
              - string
          image_36x36:
            type:
              - "null"
              - string
          image_60x60:
            type:
              - "null"
              - string
      workspaces:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            name:
              type:
                - "null"
                - string

  teams_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      description:
        type:
          - "null"
          - string
      html_description:
        type:
          - "null"
          - string
      organization:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      permalink_url:
        type:
          - "null"
          - string

  team_memberships_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      is_guest:
        type:
          - "null"
          - boolean
      team:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      user:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  attachments_compact_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      resource_subtype:
        type:
          - "null"
          - string

  attachments_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      resource_subtype:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      download_url:
        type:
          - "null"
          - string
      permanent_url:
        type:
          - "null"
          - string
      host:
        type:
          - "null"
          - string
      parent:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
          resource_subtype:
            type:
              - "null"
              - string
          created_by:
            type:
              - "null"
              - object
            properties:
              gid:
                type:
                  - "null"
                  - string
              resource_type:
                type:
                  - "null"
                  - string
      size:
        type:
          - "null"
          - integer
      view_url:
        type:
          - "null"
          - string
      connected_to_app:
        type:
          - "null"
          - boolean

  portfolios_compact_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string

  portfolios_memberships_schema:
    $schema: http://json-schema.org/draft-07/schema#
    title: Portfolio Memberships Schema
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - string
          - "null"
      resource_type:
        type:
          - string
          - "null"
      portfolio:
        type:
          - object
          - "null"
        properties:
          gid:
            type:
              - string
              - "null"
          resource_type:
            type:
              - string
              - "null"
          name:
            type:
              - string
              - "null"
      user:
        type:
          - object
          - "null"
        properties:
          gid:
            type:
              - string
              - "null"
          resource_type:
            type:
              - string
              - "null"
          name:
            type:
              - string
              - "null"

  portfolios_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      name:
        type:
          - "null"
          - string
      color:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      created_by:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      current_status_update:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          title:
            type:
              - "null"
              - string
          resource_subtype:
            type:
              - "null"
              - string
      due_on:
        type:
          - "null"
          - string
        format: date-time
      members:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      owner:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      start_on:
        type:
          - "null"
          - string
        format: date-time
      workspace:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      permalink_url:
        type:
          - "null"
          - string
      public:
        type:
          - "null"
          - boolean
      project_templates:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  custom_fields_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      created_by:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      currency_code:
        type:
          - "null"
          - string
      custom_label:
        type:
          - "null"
          - string
      custom_label_position:
        type:
          - "null"
          - string
      description:
        type:
          - "null"
          - string
      display_value:
        type:
          - "null"
          - string
      enabled:
        type:
          - "null"
          - boolean
      enum_options:
        type:
          - "null"
          - array
        items:
          type:
            - "null"
            - object
          properties:
            gid:
              type:
                - "null"
                - string
            resource_type:
              type:
                - "null"
                - string
            color:
              type:
                - "null"
                - string
            enabled:
              type:
                - "null"
                - boolean
            name:
              type:
                - "null"
                - string
      enum_value:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          color:
            type:
              - "null"
              - string
          enabled:
            type:
              - "null"
              - boolean
          name:
            type:
              - "null"
              - string
      format:
        type:
          - "null"
          - string
      has_notifications_enabled:
        type:
          - "null"
          - boolean
      is_global_to_workspace:
        type:
          - "null"
          - boolean
      number_value:
        type:
          - "null"
          - number
      precision:
        type:
          - "null"
          - integer
      resource_subtype:
        type:
          - "null"
          - string
      text_value:
        type:
          - "null"
          - string
      type:
        type:
          - "null"
          - string

  organization_exports_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      gid:
        type:
          - "null"
          - string
      resource_type:
        type:
          - "null"
          - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      download_url:
        type:
          - "null"
          - string
      state:
        type:
          - "null"
          - string
      organization:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string

  events_schema:
    $schema: http://json-schema.org/draft-07/schema#
    additionalProperties: true
    type: object
    properties:
      user:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      resource:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      type:
        type:
          - "null"
          - string
      action:
        type:
          - "null"
          - string
      parent:
        type:
          - "null"
          - object
        properties:
          gid:
            type:
              - "null"
              - string
          resource_type:
            type:
              - "null"
              - string
          name:
            type:
              - "null"
              - string
      created_at:
        type:
          - "null"
          - string
        format: date-time
      change:
        type:
          - "null"
          - object
        properties:
          field:
            type:
              - "null"
              - string
          action:
            type:
              - "null"
              - string
          new_value:
            type:
              - "null"
              - object
            properties:
              gid:
                type:
                  - "null"
                  - string
              resource_type:
                type:
                  - "null"
                  - string
          added_value:
            type:
              - "null"
              - object
            properties:
              gid:
                type:
                  - "null"
                  - string
              resource_type:
                type:
                  - "null"
                  - string
          removed_value:
            type:
              - "null"
              - object
            properties:
              gid:
                type:
                  - "null"
                  - string
              resource_type:
                type:
                  - "null"
                  - string

streams:
  - "#/definitions/projects_stream"
  - "#/definitions/sections_compact_stream"
  - "#/definitions/sections_stream"
  - "#/definitions/tasks_stream"
  - "#/definitions/stories_compact_stream"
  - "#/definitions/stories_stream"
  - "#/definitions/workspaces_stream"
  - "#/definitions/tags_stream"
  - "#/definitions/users_stream"
  - "#/definitions/teams_stream"
  - "#/definitions/team_memberships_stream"
  - "#/definitions/attachments_compact_stream"
  - "#/definitions/attachments_stream"
  - "#/definitions/portfolios_compact_stream"
  - "#/definitions/portfolios_stream"
  - "#/definitions/portfolios_memberships_stream"
  - "#/definitions/custom_fields_stream"
  - "#/definitions/organization_exports_stream"
  - "#/definitions/events_stream"

check:
  type: CheckStream
  stream_names:
    - "projects"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/asana
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Asana Spec
    type: object
    additionalProperties: true
    properties:
      credentials:
        title: Authentication mechanism
        description: Choose how to authenticate to Github
        type: object
        oneOf:
          - type: object
            title: Authenticate via Asana (Oauth)
            required:
              - client_id
              - client_secret
              - refresh_token
            properties:
              option_title:
                type: string
                title: Credentials title
                description: OAuth Credentials
                const: OAuth Credentials
              client_id:
                type: string
                title: ""
                description: ""
                airbyte_secret: true
              client_secret:
                type: string
                title: ""
                description: ""
                airbyte_secret: true
              refresh_token:
                type: string
                title: ""
                description: ""
                airbyte_secret: true
          - type: object
            title: Authenticate with Personal Access Token
            required:
              - personal_access_token
            properties:
              option_title:
                type: string
                title: Credentials title
                description: PAT Credentials
                const: PAT Credentials
              personal_access_token:
                type: string
                title: Personal Access Token
                description: Asana Personal Access Token (generate yours <a href="https://app.asana.com/0/developer-console">here</a>).
                airbyte_secret: true
      test_mode:
        type: boolean
        title: Test Mode
        description:
          This flag is used for testing purposes for certain streams that
          return a lot of data. This flag is not meant to be enabled for prod.
        airbyte_hidden: true
      organization_export_ids:
        title: Organization Export IDs
        description: Globally unique identifiers for the organization exports
        type: array
      num_workers:
        type: integer
        title: Number of concurrent workers
        minimum: 1
        maximum: 25
        default: 10
        examples: [1, 2, 3]
        description: >-
          The number of worker threads to use for the sync.
          The performance upper boundary is based on the limit of your Asana pricing plan.
          More info about the rate limit tiers can be found on Asana's API <a href="https://developers.asana.com/docs/rate-limits">docs</a>.
  advanced_auth:
    auth_flow_type: oauth2.0
    predicate_key:
      - credentials
      - option_title
    predicate_value: OAuth Credentials
    oauth_config_specification:
      complete_oauth_output_specification:
        type: object
        properties:
          refresh_token:
            type: string
            path_in_connector_config:
              - credentials
              - refresh_token
      complete_oauth_server_input_specification:
        type: object
        properties:
          client_id:
            type: string
          client_secret:
            type: string
      complete_oauth_server_output_specification:
        type: object
        properties:
          client_id:
            type: string
            path_in_connector_config:
              - credentials
              - client_id
          client_secret:
            type: string
            path_in_connector_config:
              - credentials
              - client_secret
metadata:
  autoImportSchema:
    projects: false
    sections_compact: false
    sections: false
    tasks: false
    stories_compact: false
    stories: false
    workspaces: false
    tags: false
    users: false
    teams: false
    team_memberships: false
    attachments_compact: false
    attachments: false
    portfolios_compact: false
    portfolios: false
    custom_fields: false
    organization_exports: false
    events: false

# Asana rate limiting has two tiers:
# - Free: 2.5 req/s, 150 req/min
# - Paid: 25 req/s, 1500 req/min
#
# In addition, Asana has a cap on the maximum number of requests in progress concurrently depending
# on the endpoint HTTP method:
# - GET: 50 concurrent requests (We're already capping at 25 req/sec, but 50 should be the absolute ceiling)
# - POST/PUT/PATCH/DELETE: 5 concurrent requests (We don't have any streams using these methods)
#
# Lastly, a few specific endpoints have stricter limitation although neither are used at the moment:
# - /search: 60 req/min
concurrency_level:
  type: ConcurrencyLevel
  default_concurrency: "{{ config.get('num_workers', 3) }}"
  max_concurrency: 25
