version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["data"]
  requester:
    type: HttpRequester
    url_base: "https://app.orbit.love/api/v1/"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_token'] }}"
    request_parameters:
      start_date: "{{config['start_date']}}"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"
  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"
  workspace_stream:
    $ref: "#/definitions/base_stream"
    name: "workspace"
    primary_key: "id"
    $parameters:
      path: "workspaces/{{config['workspace']}}"

  members_stream:
    $ref: "#/definitions/base_stream"
    name: "members"
    primary_key: "id"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        type: "DefaultPaginator"
        pagination_strategy:
          type: "CursorPagination"
          cursor_value: "{{ response['links']['next'] }}"
        page_token_option:
          type: "RequestPath"
    $parameters:
      path: "{{config['workspace']}}/members"

streams:
  - "#/definitions/workspace_stream"
  - "#/definitions/members_stream"

check:
  type: CheckStream
  stream_names:
    - "workspace"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/orbit
  connection_specification:
    $schema: http://json-schema.org/draft-07/schema#
    title: Orbit Source Spec
    type: object
    required:
      - api_token
      - workspace
    properties:
      api_token:
        type: string
        airbyte_secret: true
        title: API Token
        description: Authorizes you to work with Orbit workspaces associated with the token.
        order: 0
      workspace:
        type: string
        title: Workspace
        description: The unique name of the workspace that your API token is associated with.
        order: 1
      start_date:
        type: string
        title: Start Date
        description: >-
          Date in the format 2022-06-26. Only load members whose last activities are after this date.
        pattern: >-
          ^[0-9]{4}-[0-9]{2}-[0-9]{2}$
        order: 2