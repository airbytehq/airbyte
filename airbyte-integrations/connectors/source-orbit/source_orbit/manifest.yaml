version: "0.52.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: ["data"]
  requester:
    type: HttpRequester
    url_base: "https://app.orbit.love/api/v1/"
    http_method: "GET"
    authenticator:
      type: BearerAuthenticator
      api_token: "{{ config['api_token'] }}"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  incremental_sync:
    type: DatetimeBasedCursor
    cursor_field: last_activity_occurred_at
    cursor_datetime_formats:
      - "%Y-%m-%dT%H:%M:%S.%f%z"
      - "%Y-%m-%d"
    datetime_format: "%Y-%m-%d"
    start_datetime:
      type: MinMaxDatetime
      datetime: "{{ config['start_date'] }}"
      datetime_format: "%Y-%m-%d"
    end_datetime:
      type: MinMaxDatetime
      datetime: "{{ now_utc().strftime('%Y-%m-%d') }}"
      datetime_format: "%Y-%m-%d"
    start_time_option:
      type: RequestOption
      inject_into: request_parameter
      field_name: start_date
    end_time_option:
      type: RequestOption
      inject_into: "request_parameter"
      field_name: end_date

  workspace_stream:
    $ref: "#/definitions/base_stream"
    name: "workspace"
    primary_key: "id"
    $parameters:
      path: "workspaces/{{config['workspace']}}"

  activity_types_stream:
    $ref: "#/definitions/base_stream"
    name: "activity_types"
    primary_key: "id"
    $parameters:
      path: "{{config['workspace']}}/activity_types"

  members_stream:
    $ref: "#/definitions/base_stream"
    name: "members"
    primary_key: "id"
    incremental_sync:
      $ref: "#/definitions/incremental_sync"
    $parameters:
      path: "{{config['workspace']}}/members"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        type: "DefaultPaginator"
        pagination_strategy:
          type: PageIncrement
          start_from_page: 1
          page_size: 100
        page_token_option:
          type: RequestOption
          inject_into: request_parameter
          field_name: page
        page_size_option:
          inject_into: request_parameter
          field_name: items
          type: RequestOption
    transformations:
      - type: AddFields
        fields:
          - path: ["last_activity_occurred_at"]
            value: "{{ record['attributes']['last_activity_occurred_at'] }}"

  activities_stream:
    $ref: "#/definitions/base_stream"
    name: "activities"
    primary_key: "id"
    incremental_sync:
      $ref: "#/definitions/incremental_sync"
      cursor_field: updated_at
    $parameters:
      path: "{{config['workspace']}}/activities"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        type: "DefaultPaginator"
        pagination_strategy:
          type: PageIncrement
          start_from_page: 1
          page_size: 100
        page_token_option:
          type: RequestOption
          inject_into: request_parameter
          field_name: page
        page_size_option:
          inject_into: request_parameter
          field_name: items
          type: RequestOption
    transformations:
      - type: AddFields
        fields:
          - path: ["updated_at"]
            value: "{{ record['attributes']['updated_at'] }}"

streams:
  - "#/definitions/workspace_stream"
  - "#/definitions/members_stream"
  - "#/definitions/activities_stream"
  - "#/definitions/activity_types_stream"

check:
  type: CheckStream
  stream_names:
    - "workspace"
