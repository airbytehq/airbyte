version: "0.29.0"

definitions:
  schema_loader:
    type: JsonFileSchemaLoader
    file_path: "./source_facebook_pages/schemas/{{ parameters['name'] }}.json"
  selector:
    extractor:
      field_path: ["data"]
  requester:
    url_base: "https://graph.facebook.com/v23.0"
    http_method: "GET"
    error_handler:
      type: CompositeErrorHandler
      error_handlers:
        - type: DefaultErrorHandler
          response_filters:
            - http_codes: [400]
              action: FAIL
        - type: DefaultErrorHandler
          response_filters:
            - http_codes: [429, 500, 502, 503, 504]
              action: RETRY
        - type: DefaultErrorHandler
    authenticator:
      type: CustomAuthenticator
      class_name: source_facebook_pages.components.AuthenticatorFacebookPageAccessToken
      page_id: "{{ config['page_id'] }}"
      access_token: "{{ config['access_token'] }}"
  facebook_post_paginator:
    type: DefaultPaginator
    pagination_strategy:
      type: "CursorPagination"
      cursor_value: "{{ response.paging.get('cursors', {}).get('after') }}"
      stop_condition: "{{ response.paging == '' or not response.paging.get('next') }}"
      page_size: 100
    page_size_option:
      field_name: "limit"
      inject_into: "request_parameter"
    page_token_option:
      type: RequestOption
      field_name: "after"
      inject_into: "request_parameter"
  retriever:
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    schema_loader:
      $ref: "#/definitions/schema_loader"
    retriever:
      $ref: "#/definitions/retriever"
    transformations:
      - type: CustomTransformation
        class_name: source_facebook_pages.components.CustomFieldTransformation
  page_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "page"
      primary_key: "id"
      path: "/{{ config['page_id'] }}"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        extractor:
          field_path: []
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          fields: |
            {{ 
              ','.join([
              'id',
              'about',
              'category',
              'category_list',
              'cover',
              'description',
              'emails',
              'engagement',
              'fan_count',
              'followers_count',
              'global_brand_page_name',
              'global_brand_root_id',
              'has_transitioned_to_new_page_experience',
              'hours',
              'is_published',
              'link',
              'location',
              'name',
              'username',
              'verification_status',
              'website',
              ]) 
            }}

  post_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "post"
      primary_key: "id"
      path: "/{{ config['page_id'] }}/posts"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/facebook_post_paginator"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          fields: |
            {{ 
              ','.join([
              'id',
              'created_time',
              'is_published',
              'message',
              'permalink_url',
              'status_type',
              'updated_time',
              'comments.limit(0).summary(true)',
              'reactions.limit(0).summary(true)'
              ])
            }}

  post_insights_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "post_insights"
      primary_key: "id"
      path: "/{{ config['page_id'] }}/posts"
    retriever:
      $ref: "#/definitions/retriever"
      paginator:
        $ref: "#/definitions/facebook_post_paginator"
      record_selector:
        type: RecordSelector
        extractor:
          field_path: ["data", "*", "insights", "data", "*"]
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          fields: |
            {{ 
              'insights.metric(%s).period(lifetime)' % ','.join([
              'post_impressions',
              'post_impressions_unique',
              'post_impressions_paid',
              'post_impressions_paid_unique',
              'post_impressions_organic',
              'post_impressions_organic_unique',
              'post_impressions_viral',
              'post_impressions_viral_unique',
              'post_impressions_nonviral',
              'post_impressions_nonviral_unique',
              'post_reactions_by_type_total',
              ])
            }}

  page_insights_stream:
    $ref: "#/definitions/base_stream"
    $parameters:
      name: "page_insights"
      primary_key: "id"
      path: "/{{ config['page_id'] }}/insights"
    retriever:
      $ref: "#/definitions/retriever"
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          metric: |
            {{
              ','.join([
              'page_post_engagements',
              'page_impressions',
              'page_impressions_unique',
              ])
            }}
streams:
  - "#/definitions/page_stream"
  - "#/definitions/post_stream"
  - "#/definitions/post_insights_stream"
  - "#/definitions/page_insights_stream"

check:
  stream_names:
    - "page"
